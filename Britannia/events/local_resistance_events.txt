#########################################################
#
# 	LOCAL RESISTANCE EVENTS
#
# 	Id 320700 - 320899 reserved	
#
#########################################################

# Assign local resistance modifier
province_event = {
	id = 320700
	hide_window = yes

	trigger = {
		# always = no
		local_resistance_potential_trigger = yes
		NOT = { has_province_flag = has_local_resistance }
		NOT = { has_province_flag = local_resistance_pacified }
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		set_province_flag = has_local_resistance
		if = {
			limit = { has_province_flag = local_resistance_unpacifying }
			clr_province_flag = local_resistance_unpacifying
		}
		else = {
			if = {
				limit = { NOT = { has_province_flag = local_resistance_pacified_before } }
				set_variable = {
					which = pacification_years_remaining
					value = 40
				}
			}
			else = {
				set_variable = {
					which = pacification_years_remaining
					value = 25
				}
			}
		}
		
		set_proper_local_resistance_level_effect = yes
		
		owner = {
			character_event = { id = 320701 }
			any_liege = {
				character_event = { id = 320701 }
			}
		}
	}
}

# Notify owner/liege
character_event = {
	id = 320701
	desc = EVTDESC320701
	picture = GFX_evt_peasants
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	trigger = {
		ai = no
		NOT = { has_global_flag = disabled_local_resistance_alerts }
	}
	
	option = {
		name = "EVTOPTA320701"
		custom_tooltip = {
			text = EVTOPTA320701TT
		}
	}
	option = {
		name = "EVTOPTB320701"
		custom_tooltip = {
			text = EVTOPTB320701TT
		}
		set_global_flag = disabled_local_resistance_alerts
	}
}

# Remove modifier if no longer relevant
province_event = {
	id = 320705
	hide_window = yes

	trigger = {
		local_resistance_potential_trigger = no
		has_province_flag = has_local_resistance
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		clr_province_flag = has_local_resistance
		remove_province_modifier = local_resistance_1
		remove_province_modifier = local_resistance_2
		remove_province_modifier = local_resistance_3
		remove_province_modifier = local_resistance_1_quiet
		remove_province_modifier = local_resistance_2_quiet
		remove_province_modifier = local_resistance_3_quiet
		remove_province_modifier = local_resistance_1_march
		remove_province_modifier = local_resistance_2_march
		remove_province_modifier = local_resistance_3_march
		
		clr_province_flag = is_pacifying_province
		clr_province_flag = local_resistance_pacified
		set_province_flag = local_resistance_unpacifying
	}
}

# Swap to quiet modifier
province_event = {
	id = 320706
	hide_window = yes

	trigger = {
		has_province_flag = has_local_resistance
		OR = {
			has_province_modifier = local_resistance_1
			has_province_modifier = local_resistance_2
			has_province_modifier = local_resistance_3
			has_province_modifier = local_resistance_1_march
			has_province_modifier = local_resistance_2_march
			has_province_modifier = local_resistance_3_march
		}
		owner = { culture = ROOT }
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_1 
					has_province_modifier = local_resistance_1_march
				}
			}
			remove_province_modifier = local_resistance_1
			remove_province_modifier = local_resistance_1_march
			add_province_modifier = { 
				name = local_resistance_1_quiet
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_2
					has_province_modifier = local_resistance_2_march
				}
			}
			remove_province_modifier = local_resistance_2
			remove_province_modifier = local_resistance_2_march
			add_province_modifier = { 
				name = local_resistance_2_quiet
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_3
					has_province_modifier = local_resistance_3_march
				}
			}
			remove_province_modifier = local_resistance_3
			remove_province_modifier = local_resistance_3_march
			add_province_modifier = { 
				name = local_resistance_3_quiet
				duration = -1
			}
		}
	}
}

# Swap to march modifier
province_event = {
	id = 320707
	hide_window = yes

	trigger = {
		has_province_flag = has_local_resistance
		OR = {
			has_province_modifier = local_resistance_1
			has_province_modifier = local_resistance_2
			has_province_modifier = local_resistance_3
			has_province_modifier = local_resistance_1_quiet
			has_province_modifier = local_resistance_2_quiet
			has_province_modifier = local_resistance_3_quiet
		}
		owner = { 
			NOT = { culture = ROOT }
			top_liege = {
				is_tributary = {
					type = march
				}
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_1 
					has_province_modifier = local_resistance_1_quiet
				}
			}
			remove_province_modifier = local_resistance_1
			remove_province_modifier = local_resistance_1_quiet
			add_province_modifier = { 
				name = local_resistance_1_march
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_2
					has_province_modifier = local_resistance_2_quiet
				}
			}
			remove_province_modifier = local_resistance_2
			remove_province_modifier = local_resistance_2_quiet
			add_province_modifier = { 
				name = local_resistance_2_march
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_3
					has_province_modifier = local_resistance_3_quiet
				}
			}
			remove_province_modifier = local_resistance_3
			remove_province_modifier = local_resistance_3_quiet
			add_province_modifier = { 
				name = local_resistance_3_march
				duration = -1
			}
		}
	}
}

# Swap to normal modifier
province_event = {
	id = 320708
	hide_window = yes

	trigger = {
		has_province_flag = has_local_resistance
		OR = {
			has_province_modifier = local_resistance_1_quiet
			has_province_modifier = local_resistance_2_quiet
			has_province_modifier = local_resistance_3_quiet
			has_province_modifier = local_resistance_1_march
			has_province_modifier = local_resistance_2_march
			has_province_modifier = local_resistance_3_march
		}
		owner = { 
			NOR = {
				culture = ROOT 
				top_liege = {
					is_tributary = {
						type = march
					}
				}
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_1_quiet 
					has_province_modifier = local_resistance_1_march
				}
			}
			remove_province_modifier = local_resistance_1_quiet
			remove_province_modifier = local_resistance_1_march
			add_province_modifier = { 
				name = local_resistance_1
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_2_quiet
					has_province_modifier = local_resistance_2_march
				}
			}
			remove_province_modifier = local_resistance_2_quiet
			remove_province_modifier = local_resistance_2_march
			add_province_modifier = { 
				name = local_resistance_2
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_3_quiet
					has_province_modifier = local_resistance_3_march
				}
			}
			remove_province_modifier = local_resistance_3_quiet
			remove_province_modifier = local_resistance_3_march
			add_province_modifier = { 
				name = local_resistance_3
				duration = -1
			}
		}
	}
}

# Pacification Progress (yearly timer)
character_event = {
	id = 320710
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		has_landed_title = d_null
	}
	
	immediate = {
		any_province = {
			limit = { 
				has_province_flag = is_pacifying_province 
			}
			owner = { save_event_target_as = province_owner }
			if = {
				limit = {
					# Pacification progress is paused if any holding in province is occupied, unless it's an internal war
					NOT = {
						any_province_holding = {
							is_occupied = yes
							owner = {
								same_realm = event_target:province_owner
							}
							controller = {
								NOT = { same_realm = event_target:province_owner }
							}
						}
					}
					
					# Pacification progress is also paused during major revolts
					has_active_major_revolt_trigger = no
				}
				subtract_variable = {
					which = pacification_years_remaining
					value = 1
				}
				if = {
					limit = {
						is_variable_equal = {
							which = pacification_years_remaining
							value = 25
						}
					}
					if = {
						limit = { has_province_modifier = local_resistance_3 }
						remove_province_modifier = local_resistance_3
						add_province_modifier = { 
							name = local_resistance_2
							duration = -1
						}
					}
					else_if = {
						limit = { has_province_modifier = local_resistance_3_quiet }
						remove_province_modifier = local_resistance_3_quiet
						add_province_modifier = { 
							name = local_resistance_2_quiet
							duration = -1
						}
					}
					else_if = {
						limit = { has_province_modifier = local_resistance_3_march }
						remove_province_modifier = local_resistance_3_march
						add_province_modifier = { 
							name = local_resistance_2_march
							duration = -1
						}
					}
				}
				else_if = {
					limit = {
						is_variable_equal = {
							which = pacification_years_remaining
							value = 10
						}
					}
					if = {
						limit = { has_province_modifier = local_resistance_2 }
						remove_province_modifier = local_resistance_2
						add_province_modifier = { 
							name = local_resistance_1
							duration = -1
						}
					}
					else_if = {
						limit = { has_province_modifier = local_resistance_2_quiet }
						remove_province_modifier = local_resistance_2_quiet
						add_province_modifier = { 
							name = local_resistance_1_quiet
							duration = -1
						}
					}
					else_if = {
						limit = { has_province_modifier = local_resistance_2_march }
						remove_province_modifier = local_resistance_2_march
						add_province_modifier = { 
							name = local_resistance_1_march
							duration = -1
						}
					}
				}
				else_if = {
					limit = {
						is_variable_equal = {
							which = pacification_years_remaining
							value = 0
						}
					}
					remove_province_modifier = local_resistance_1
					remove_province_modifier = local_resistance_1_quiet
					remove_province_modifier = local_resistance_1_march
					clr_province_flag = is_pacifying_province
					clr_province_flag = has_local_resistance
					set_province_flag = local_resistance_pacified
					set_province_flag = local_resistance_pacified_before
		
					set_variable = {
						which = nationalist_revolt_progress
						value = 0
					}
				}
			}
		}
		
		# Pacification progress rolls back gradually if not controlled by a pacifying culture
		any_province = {
			limit = { 
				has_province_flag = local_resistance_unpacifying 
			}
			change_variable = {
				which = pacification_years_remaining
				value = 1
			}
			if = {
				limit = {
					OR = {
						check_variable = {
							which = pacification_years_remaining
							value = 40
						}
						AND = {
							has_province_flag = local_resistance_pacified_before
							check_variable = {
								which = pacification_years_remaining
								value = 25
							}
						}
					}
				}
				set_variable = {
					which = pacification_years_remaining
					value = 0
				}
				clr_province_flag = local_resistance_unpacifying
			}
		}
	}
}

# Progress set back by revolts. Fired from 'on_siege_over_winner'.
character_event = {
	id = 320711
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		rebel = yes
		any_war = {
			attacker = { character = ROOT }
			OR = {
				using_cb = peasant_revolt
				using_cb = heretic_revolt
				using_cb = religious_revolt
				using_cb = cultural_revolt
				using_cb = liberation_revolt
			}
		}
		FROM = {
			location = {
				has_province_flag = has_local_resistance
				capital_holding = {
					owner = {
						ROOT_FROM = {
							owner = {
								same_realm = PREVPREV
							}
						}
					}
				}
			}
		}
	}
	
	immediate = {
		location = {
			change_variable = {
				which = pacification_years_remaining
				value = 3
			}
			if = {
				limit = {
					NOT = { has_province_flag = local_resistance_pacified_before }
					check_variable = {
						which = pacification_years_remaining
						value = 40
					}
				}
				set_variable = {
					which = pacification_years_remaining
					value = 40
				}
			}
			else_if = {
				limit = {
					has_province_flag = local_resistance_pacified_before
					check_variable = {
						which = pacification_years_remaining
						value = 25
					}
				}
				set_variable = {
					which = pacification_years_remaining
					value = 25
				}
			}
			
			# Increase resistance level if applicable
			set_proper_local_resistance_level_effect = yes
		}
	}
}

### MAJOR REVOLT EVENTS ###

# Flag revolts originating from a province with Local Resistance
character_event = {
	id = 320720
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = { FROM = { has_local_resistance_modifier_trigger = yes } }
			primary_title = { set_title_flag = local_resistance_revolt }
			if = {
				limit = { FROM = { has_active_major_revolt_trigger = yes } }
				primary_title = { set_title_flag = major_revolt_rebel_title }
			}
		}
	}
}

# Local Resistance revolt reaches 25% warscore, notify all relevant lords that a major revolt might break out soon
character_event = {
	id = 320721
	hide_window = yes
	
	only_rulers = yes
	
	trigger = {
		primary_title = { 
			has_title_flag = local_resistance_revolt
			NOT = { has_title_flag = major_revolt_warning }
		}
		war = yes
		OR = {
			any_war = {
				attacker = { character = ROOT }
				war_score >= 25
			}
			has_character_flag = won_revolt
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		any_war = {
			limit = {
				attacker = { character = ROOT }
				OR = {
					war_score >= 25 
					ROOT = { has_character_flag = won_revolt }
				}
			}
			defender = { save_event_target_as = revolt_defender }
			thirdparty_title_scope = {
				save_event_target_as = revolt_target
				random_direct_de_jure_vassal_title = {
					limit = { owner = { top_liege = { character = event_target:revolt_defender } } }
					location = { save_event_target_as = current_resistance_region_province }
				}
			}
			event_target:current_resistance_region_province = {
				calc_num_of_local_resistance_provinces_in_region_effect = yes
				get_major_revolt_variables_title_effect = yes
			}
			# Check to see if the rebellion's duchy still has any provinces with local resistance
			if = {
				limit = { 
					NOT = {
						thirdparty_title_scope = {
							any_direct_de_jure_vassal_title = {
								location = {
									has_local_resistance_modifier_trigger = yes
									local_resistance_potential_trigger = yes
								}
							}
						}
					}
				}
				# If it doesn't, then this rebellion is no longer eligible to trigger major revolts
				ROOT = { primary_title = { clr_title_flag = local_resistance_revolt } }
			}
			# Otherwise, check to see if a major revolt can be started
			else_if = {
				limit = { is_major_revolt_possible_for_war_trigger = yes }
				ROOT = { primary_title = { set_title_flag = major_revolt_warning } }
				# We notify the defender...
				defender = {
					character_event = { id = 320722 }
					# Any lords in the defender's realm who might be hit by the major revolt...
					any_realm_lord = {
						limit = { 
							any_realm_province = { 
								is_in_current_resistance_region_province = yes
								has_province_flag = has_local_resistance
							} 
						}
						character_event = { id = 320722 }
					}
					if = {
						limit = { is_tributary = { type = march } }
						# The defender's overlord, if the defender is a march...
						suzerain = {
							character_event = { id = 320722 }
							# Any lords in the overlord's realm who might be hit by the major revolt...
							any_realm_lord = {
								limit = { 
									any_realm_province = { 
										is_in_current_resistance_region_province = yes
										has_province_flag = has_local_resistance
									} 
								}
								character_event = { id = 320722 }
							}
							# Any other marches (and their vassals) under the overlord who might be hit by the major revolt...
							any_tributary = {
								limit = { 
									is_tributary = { type = march } 
									any_realm_province = { 
										is_in_current_resistance_region_province = yes
										has_province_flag = has_local_resistance
									}
								}
								character_event = { id = 320722 }
								any_realm_lord = {
									limit = { 
										any_realm_province = { 
											is_in_current_resistance_region_province = yes
											has_province_flag = has_local_resistance
										} 
									}
									character_event = { id = 320722 }
								}
							}
							# Any tributaries under the overlord who might be able to rebel...
							any_tributary = {
								limit = { 
									NOT = { is_tributary = { type = march } }
									is_local_resistance_similar_culture_to_ROOT_trigger = yes
									any_realm_province = { is_in_current_resistance_region_province = yes }
								}
								character_event = { id = 320722 }
							}
						}
					}
					# Any marches (and their vassals) under the defender who might be hit by the major revolt...
					any_tributary = {
						limit = { 
							is_tributary = { type = march } 
							any_realm_province = { 
								is_in_current_resistance_region_province = yes
								has_province_flag = has_local_resistance
							}
						}
						character_event = { id = 320722 }
						any_realm_lord = {
							limit = { 
								any_realm_province = { 
									is_in_current_resistance_region_province = yes
									has_province_flag = has_local_resistance
								} 
							}
							character_event = { id = 320722 }
						}
					}
					# ...and any tributaries under the defender who might be able to rebel
					any_tributary = {
						limit = { 
							NOT = { is_tributary = { type = march } }
							is_local_resistance_similar_culture_to_ROOT_trigger = yes
							any_realm_province = { is_in_current_resistance_region_province = yes }
						}
						character_event = { id = 320722 }
					}
				}
				
				# Start the checks to see if the Major Revolt can actually already trigger
				ROOT = { primary_title = { save_event_target_as = revolt_title } }
				event_target:current_resistance_region_province = {
					province_event = { id = 320723 days = 2 }
				}
			}
		}
	}
}

# Warning event that Major Revolt is near
character_event = {
	id = 320722
	desc = {
		text = EVTDESC320722_defender
		trigger = {
			any_war = {
				attacker = { character = FROM }
				defender = { character = ROOT }
			}
		}
	}
	desc = {
		text = EVTDESC320722_defender_vassal_or_march
		trigger = {
			NOT = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = ROOT }
				}
			}
			top_liege = {
				is_defending_against_potential_major_revolt_from_FROM = yes
			}
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = no }
		}
	}
	desc = {
		text = EVTDESC320722_suzerain
		trigger = {
			any_tributary = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = PREV }
				}
			}
		}
	}
	desc = {
		text = EVTDESC320722_defender_vassal_or_march
		trigger = {
			is_tributary = { type = march }
			suzerain = {
				OR = {
					any_war = {
						attacker = { character = FROM }
						defender = { character = PREV }
					}
					any_tributary = {
						NOT = { character = ROOT }
						any_war = {
							attacker = { character = FROM }
							defender = { character = PREV }
						}
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESC320722_potential_rebel
		trigger = {
			NOR = {				
				any_war = {
					attacker = { character = FROM }
					defender = { character = ROOT }
				}
				any_tributary = {
					any_war = {
						attacker = { character = FROM }
						defender = { character = PREV }
					}
				}
			}
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
		}
	}
	picture = GFX_evt_peasants
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	trigger = {
		ai = no
		NOT = { has_global_flag = disabled_major_revolt_warnings }
	}
	
	immediate = {
		if = {
			limit = { is_tributary = yes }
			suzerain = { save_event_target_as = current_suzerain }
		}
	}
	
	option = {		# Defender
		name = "EVTOPTA320722"
		trigger = {
			any_war = {
				attacker = { character = FROM }
				defender = { character = ROOT }
			}	
		}
		custom_tooltip = {
			text = EVTOPTA320722TT
		}
	}
	
	option = {		# Vassal, not same culture as revolt
		name = "EVTOPTB320722"
		trigger = {
			independent = no
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = no }
		}
		custom_tooltip = {
			text = EVTOPTB320722TT
		}
	}
	
	option = {		# Suzerain
		name = "EVTOPTC320722"
		trigger = {
			NOT = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = ROOT }
				}
			}
			any_tributary = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = PREV }
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTA320722TT
		}
	}
	
	option = {		# Vassal/Tributary, same culture as revolt
		name = "EVTOPTD320722"
		trigger = {
			OR = {				
				independent = no
				is_tributary = yes
			}
			NOT = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = ROOT }
				}
			}
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
		}
		custom_tooltip = {
			text = EVTOPTD320722TT
		}
	}
	
	option = {		# Dismiss warnings
		name = "EVTOPTE320722"
		custom_tooltip = {
			text = EVTOPTE320722TT
		}
		set_global_flag = disabled_major_revolt_warnings
	}
}

# Check for event 320724 every few days
# We do this via a repeating event instead of MTTH because otherwise the warning and revolt could fire a the same time due to flag-checking weirdness
# TODO Could use repeat_event, honestly
province_event = {
	id = 320723
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		event_target:revolt_title = {
			has_holder = yes
			has_title_flag = local_resistance_revolt
		}
		has_active_major_revolt_trigger = no
	}
	
	immediate = {
		event_target:revolt_title = {
			holder_scope = { character_event = { id = 320724 } }
		}
		
		# Keep re-checking until either the rebellion dies, there is no more local resistance, or a major revolt breaks out
		province_event = { id = 320723 days = 3 }
	}
	
	option = {
		name = "EVTOPTE320723"
	}
}

# Local Resistance revolt reaches 40-50%(?) warscore or wins, trigger Major Revolt
character_event = {
	id = 320724
	hide_window = yes	
	only_rulers = yes
	
	is_triggered_only = yes
	
	trigger = {
		primary_title = { 
			has_title_flag = local_resistance_revolt
			has_title_flag = major_revolt_warning		# Always want to make sure the warning fired first
		}
		war = yes
		OR = {
			any_war = {
				attacker = { character = ROOT }
				war_score >= 50
			}
			has_character_flag = won_revolt
		}
	}
	
	immediate = {
		# Note: If any of the code here is changed, make sure that the corresponding code in the 
		# on_success blocks of the cultural_revolt cb is also changed
		any_war = {
			limit = {
				attacker = { character = ROOT }
				OR = {
					war_score >= 50 
					# In case the defender surrenders early or something
					ROOT = { has_character_flag = won_revolt }
				}
			}
			defender = { save_event_target_as = revolt_defender }
			thirdparty_title_scope = {
				save_event_target_as = revolt_target
				random_direct_de_jure_vassal_title = {
					limit = { owner = { top_liege = { character = event_target:revolt_defender } } }
					location = { save_event_target_as = current_resistance_region_province }
				}
			}
			event_target:current_resistance_region_province = {
				calc_num_of_local_resistance_provinces_in_region_effect = yes
				get_major_revolt_variables_title_effect = yes
			}
			
			if = {
				limit = {
					event_target:major_revolt_title = {
						OR = {
							NOT = { has_title_flag = major_revolt_ended }
							had_title_flag = { flag = major_revolt_ended years >= 10 }
						}
					}
				}
				set_character_flag = major_revolt_ended_more_than_10_years_ago
			}
			
			# Check to see if the rebellion's duchy still has any provinces with local resistance
			if = {
				limit = { 
					NOT = {
						thirdparty_title_scope = {
							any_direct_de_jure_vassal_title = {
								location = {
									has_local_resistance_modifier_trigger = yes
									local_resistance_potential_trigger = yes
								}
							}
						}
					}
				}
				# If it doesn't, then this rebellion is no longer eligible to trigger major revolts
				ROOT = { primary_title = { clr_title_flag = local_resistance_revolt } }
			}
			# Otherwise, check to see if a major revolt can be started
			else_if = {
				limit = { is_major_revolt_possible_for_war_trigger = yes }
				defender = { save_event_target_as = major_revolt_initial_defender }
				ROOT = { character_event = { id = 320725 } }
			}
		}
	}
}
				
# Major Revolt breaks out with nearby duchies revolting and large revolt risk increases across the region	
# ROOT is the leader of the rebellion that triggered the Major Revolt
# The current_resistance_region_province event target is the focus of the revolt (normally the province where the revolt started from)
character_event = {
	id = 320725
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {		
		# Flag that the region officially has a major revolt breaking out
		event_target:current_resistance_region_province = { 
			set_major_revolt_active_effect = yes 
			get_major_revolt_variables_title_effect = yes
		}
		
		# Mark the main revolt defender
		# This is either the defender against the initial revolt, or their suzerain if the defender was a march
		if = {
			limit = { event_target:revolt_defender = { is_tributary = { type = march } } }
			event_target:revolt_defender = { suzerain = { save_event_target_as = main_revolt_defender } }
		}
		else = {
			event_target:revolt_defender = { save_event_target_as = main_revolt_defender }
		}
		
		# All unpacified provinces in the region belonging to the overlord or one of their tributaries 
		# will get a modifier giving large revolt risk increases and marking them as part of the revolt
		any_province = {
			limit = { 
				is_in_current_resistance_region_province = yes
				has_local_resistance_modifier_trigger = yes
			}
			if = {
				limit = {
					owner = {
						top_liege = {
							OR = {
								character = event_target:main_revolt_defender
								AND = {
									is_tributary = { type = march }
									suzerain = { character = event_target:main_revolt_defender }
								}
							}
						}
					}
				}
				add_province_modifier = { 
					name = ongoing_major_revolt
					duration = -1
				}
			}
			# Other unpacified provinces in the region not held by the overlord or one of their marches will get a smaller revolt risk increase
			# If that rebellion gains momentum then the revolt will spread in full to the other realm's provinces
			# Note that this modifier shouldn't be applied to provinces of vassals in revolt 
			# (they'll get the sympathetic modifier in the next event)
			else_if = {
				limit = {
					NOT = {
						owner = {
							top_liege = {
								in_revolt = yes
								liege_before_war = {
									OR = {
										character = event_target:main_revolt_defender
										AND = {
											is_tributary = { type = march }
											suzerain = { character = event_target:main_revolt_defender }
										}
									}
								}
							}
						}
					}
				}
				add_province_modifier = { 
					name = ongoing_major_revolt_minor
					duration = -1
				}						
			}
		}
		
		# Notify everyone relevant and ask potential rebels if they want to revolt
		any_playable_ruler = {
			limit = {
				OR = {
					# Top liege or one their marches has unpacified provinces in the region
					# (or the top liege is a march whose suzerain as unpacified provinces in the region)
					top_liege = {
						OR = {
							any_realm_province = {
								is_in_current_resistance_region_province = yes
							}
							any_tributary = {
								is_tributary = { type = march }
								any_realm_province = {
									is_in_current_resistance_region_province = yes
								}
							}
							AND = {
								is_tributary = { type = march }
								suzerain = {
									OR = {						
										any_tributary = {
											is_tributary = { type = march }
											any_realm_province = {
												is_in_current_resistance_region_province = yes
											}
										}
										any_realm_province = {
											is_in_current_resistance_region_province = yes
										}
									}
								}
							}
						}
					}
				}
			}
			# Vassals and tributaries (or vassals of marches) of the main_revolt_defender that are
			# a similar culture to the revolter, in the revolt region, and are already in revolt 
			# get notifications and free event troops
			# This event also flags them as participants in the major revolt
			if = {
				limit = {					
					OR = {
						AND = {
							is_tributary = yes
							NOT = { is_tributary = { type = march } }
							suzerain = { is_defending_against_potential_major_revolt_from_ROOT = yes }
							is_local_resistance_similar_culture_to_ROOT_trigger = yes
							any_realm_province = { is_in_current_resistance_region_province = yes }
							any_war = {
								using_cb = free_tributary_cb
								attacker = { character = PREVPREV }
								defender = { any_tributary = { character = PREVPREVPREV } }
							}
						}
						AND = {
							in_revolt = yes
							top_liege = { 
								liege_before_war = { is_defending_against_potential_major_revolt_from_ROOT = yes } 
								any_war = { 
									attacker = { character = PREVPREV }
									OR = {
										using_cb = bid_for_independence
										using_cb = cb_faction_independence
									}
								}
								is_local_resistance_similar_culture_to_ROOT_trigger = yes
								any_realm_province = { is_in_current_resistance_region_province = yes }
							}
						}
					}
					NOT = { has_character_flag = already_won_war }
				}
				character_event = { id = 320728 }
			}
			# Other Vassals and tributaries (or vassals of marches) of the main_revolt_defender that are
			# a similar culture to the revolter are asked if they want to join the rebellion
			else_if = {
				limit = {
					any_realm_province = { is_in_current_resistance_region_province = yes }
					is_local_resistance_similar_culture_to_ROOT_trigger = yes
					NOT = { is_tributary = { type = march } }
					OR = {
						top_liege = { is_defending_against_potential_major_revolt_from_ROOT = yes }
						AND = {
							is_tributary = yes
							suzerain = { is_defending_against_potential_major_revolt_from_ROOT = yes }
						}
					}
				}
				character_event = { id = 320727 }
			}
			# Non-similar culture vassals (and marches and vassals of marches) of the main_revolt_defender,
			# as well as the main defender him/herself, are notified
			else_if = {
				limit = {
					top_liege = { is_defending_against_potential_major_revolt_from_FROM = yes }
				}
				character_event = { id = 320726 }
			}
			# Other lords in the region get a notification, and possibly notes about their options
			else = {
				character_event = { id = 320729 }
			}
		}
		
		
		# Also notify leaders of province revolts against the current target of the Major Revolt 
		# (main_revolt_defender) and their marches and give them extra event troops
		event_target:main_revolt_defender = {
			any_war = {
				limit = {
					using_cb = cultural_revolt
					attacker = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
					defender = { character = PREVPREV }
					thirdparty_title_scope = {
						capital_scope = { is_in_current_resistance_region_province = yes }
					}
				}
				attacker = { 
					if = {
						limit = { NOT = { has_character_flag = already_won_war } }
						character_event = { id = 320728 }
					}
					# This basically only happens in the case where the major revolt is triggered by
					# a rebellion winning instead of just being >= 50 warscore
					# They're still at war when the event fires but it resolves immediately after,
					# so they shouldn't get the war version of the event
					else = {
						clr_character_flag = already_won_war
						character_event = { id = 320729 }
					}
				}			
			}
			any_tributary = {
				limit = { is_tributary = { type = march } }
				any_war = {
					limit = {
						using_cb = cultural_revolt
						attacker = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
						defender = { character = PREVPREV }
						thirdparty_title_scope = {
							capital_scope = { is_in_current_resistance_region_province = yes }
						}
					}
					if = {
						limit = { NOT = { has_character_flag = already_won_war } }
						character_event = { id = 320728 }
					}
					else = {
						clr_character_flag = already_won_war
						character_event = { id = 320729 }
					}			
				}
			}
		}
		
		# Trigger cultural rebels across the region - this is done after the notifications so that 
		# they don't get extra event troops from event 320728
		# Calculate how many unpacified duchies there are under the major revolt target
		set_variable = {
			which = num_unpacified_duchies
			value = 0
		}
		any_landed_title = {
			limit = {
				tier = DUKE
				any_direct_de_jure_vassal_title = {
					location = { has_local_resistance_modifier_trigger = yes }
					holder_scope = { 
						top_liege = { is_defending_against_potential_major_revolt_from_ROOT = yes }
						is_local_resistance_similar_culture_to_ROOT_trigger = no
					}
					is_cultural_revolt_allowed_trigger = yes		
					NOT = { # Not if there is already an ongoing revolt for the duchy
						holder_scope = {
							top_liege = {
								war = yes
								any_war = {
									defender = { character = PREV }
									using_cb = cultural_revolt
									attacker = { culture = ROOT }
									war_title = PREVPREVPREVPREV
								}
							}
						}
					}
				}
			}
			ROOT = {
				change_variable = {
					which = num_unpacified_duchies
					value = 1
				}
			}
		}		
		
		# Calculate how many revolts to make (66% of unpacified duchies and at least 2 if possible)
		set_variable = {
			which = num_immediate_revolts
			which = num_unpacified_duchies
		}
		multiply_variable = {
			which = num_immediate_revolts
			value = 0.66
		}
		if = {
			limit = {
				check_variable = {
					which = num_immediate_revolts
					value < 2
				}
			}
			set_variable = {
				which = num_immediate_revolts
				value = 2
			}
		}
		if = {
			limit = {
				check_variable = {
					which = num_immediate_revolts
					which > num_unpacified_duchies
				}
			}
			set_variable = {
				which = num_immediate_revolts
				which = num_unpacified_duchies
			}
		}
		set_variable = {
			which = num_revolts_triggered
			value = 0
		}
				
		# Trigger the revolts
		while = {
			limit = {
				check_variable = {
					which = num_revolts_triggered
					which < num_immediate_revolts
				}				
			}
			random_landed_title = {
				limit = {
					tier = DUKE
					any_direct_de_jure_vassal_title = {
						location = { has_local_resistance_modifier_trigger = yes }
						holder_scope = { 
							top_liege = { is_defending_against_potential_major_revolt_from_ROOT = yes }
							is_local_resistance_similar_culture_to_ROOT_trigger = no
						}
						is_cultural_revolt_allowed_trigger = yes		
						NOT = { # Not if there is already an ongoing revolt for the duchy
							holder_scope = {
								top_liege = {
									war = yes
									any_war = {
										defender = { character = PREV }
										using_cb = cultural_revolt
										attacker = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
										war_title = PREVPREVPREVPREV
									}
								}
							}
						}
					}
				}
				random_direct_de_jure_vassal_title = {
					limit = {
						location = { has_local_resistance_modifier_trigger = yes }
						holder_scope = { 
							top_liege = { is_defending_against_potential_major_revolt_from_ROOT = yes }
							is_local_resistance_similar_culture_to_ROOT_trigger = no
						}
						is_cultural_revolt_allowed_trigger = yes		
						NOT = { # Not if there is already an ongoing revolt for the duchy
							holder_scope = {
								top_liege = {
									war = yes
									any_war = {
										defender = { character = PREV }
										using_cb = cultural_revolt
										attacker = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
										war_title = PREVPREVPREVPREV
									}
								}
							}
						}
					}
					# Trigger a cultural revolt
					# TODO Need to add flags to the revolt when it breaks out in 320720
					location = { province_event = { id = 320600 } }
				}
			}
			change_variable = {
				which = num_revolts_triggered
				value = 1
			}
		}
		
		# Start counter for successful/crushed revolts
		event_target:major_revolt_title = {
			set_variable = {
				which = num_revolts_succeeded
				value = 0
			}
			# If the initial revolt won, then we increment the counter
			if = {
				limit = { ROOT = { has_character_flag = won_revolt } }
				change_variable = {
					which = num_revolts_succeeded
					value = 1
				}
			}
			set_variable = {
				which = num_revolts_crushed
				value = 0
			}
		}
		
		# Clear any previous major revolt leader, if that didn't get properly cleared
		event_target:current_resistance_region_province = { clear_major_revolt_leader_character = yes }
		
		# If the initial revolt won, they become the leader
		if = {
			limit = { ROOT = { has_character_flag = won_revolt } }
			ROOT = { set_major_revolt_leader_character = yes }
		}
	}
}

# Notify the main defender and any of their vassals/marches/march vassals that are not a similar culture
# to the revolt
narrative_event = {
	id = 320726
	title = EVTNAME320726
	desc = EVTDESC320726
	picture = GFX_evt_burning_fire
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA320726"
		custom_tooltip = {
			text = EVTOPTA320726TT0
		}
		tooltip = {
			top_liege = {
				show_scope_change = no
				random_realm_province = {
					limit = { 
						is_in_current_resistance_region_province = yes
						has_local_resistance_modifier_trigger = yes
					}
					# We don't add the actual modifier in this tooltip as it doesn't show up
					# since all the provinces already have the modifier from the previous event
					add_province_modifier = { 
						name = ongoing_major_revolt_tooltip		
						duration = -1
					}
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTA320726TT1
		}
	}
}

# Notify any of the vassals/march vassals of the main defender that are a similar culture to the 
# revolt, and offer them the opportunity to revolt immediately
narrative_event = {
	id = 320727
	title = EVTNAME320726
	desc = EVTDESC320726
	picture = GFX_evt_burning_fire
	
	is_triggered_only = yes
	
	# Join the revolt! (vassal)
	option = {
		name = "EVTOPTA320727"
		trigger = {
			independent = no 
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = loyal
					trait = content
					top_liege = {
						is_allied_with = ROOT
					}
					top_liege = {
						reverse_opinion = {
							who = ROOT
							value >= 70
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTA320727TT0
		}
		# TODO Need to write handling end of revolt in the cb
		# Declare independence war
		if = {
			limit = { liege = { independent = no } }
			hidden_tooltip = { top_liege = { set_defacto_vassal = ROOT } }
		}
		liege = {
			show_scope_change = no
			ROOT = {
				show_scope_change = no
				unsafe_war = {
					target = PREV
					casus_belli = bid_for_independence
				}
			}
		}
		
		# Switch provinces over to ongoing_major_revolt_sympathetic modifier
		if = {
			limit = {
				any_realm_province = {
					is_in_current_resistance_region_province = yes
					has_local_resistance_modifier_trigger = yes
				}
			}
			tooltip = {
				random_realm_province = {
					limit = { 
						is_in_current_resistance_region_province = yes
						has_local_resistance_modifier_trigger = yes
					}
					add_province_modifier = { 
						name = ongoing_major_revolt_sympathetic
						duration = -1
					}
				}
			}
			hidden_tooltip = {
				any_realm_province = {
					limit = { 
						is_in_current_resistance_region_province = yes
						has_local_resistance_modifier_trigger = yes
					}
					remove_province_modifier = ongoing_major_revolt
					add_province_modifier = { 
						name = ongoing_major_revolt_sympathetic
						duration = -1
					}
					county = {
						any_direct_de_jure_vassal_title = { refill_holding_levy = yes }
					}
				}
			}
			custom_tooltip = {
				text = EVTOPTA320727TT1
			}
		}
		custom_tooltip = {
			text = EVTOPTA320727TT2
		}
	}
	
	# Don't join (vassal)
	option = {
		name = "EVTOPTB320727"
		trigger = {
			independent = no 
		}
		ai_chance = {
			factor = 0
			additive_modifier = {
				value = 100
				OR = {
					trait = loyal
					trait = content
					top_liege = {
						is_allied_with = ROOT
					}
					top_liege = {
						reverse_opinion = {
							who = ROOT
							value >= 70
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTB320727TT
		}
		tooltip = {
			top_liege = {
				show_scope_change = no
				random_realm_province = {
					limit = { 
						is_in_current_resistance_region_province = yes
						has_local_resistance_modifier_trigger = yes
					}
					add_province_modifier = { 
						name = ongoing_major_revolt
						duration = -1
					}
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTA320726TT1
		}
	}
	
	# Join the revolt! (tributary)
	option = {
		name = "EVTOPTA320727"
		trigger = {
			independent = yes
			is_tributary = yes
		}
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = loyal
					trait = content
					suzerain = {
						reverse_opinion = {
							who = ROOT
							value >= 70
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTA320727TT0
		}
		# TODO Need to write handling end of revolt in the cb
		# Declare independence war 
		suzerain = {
			show_scope_change = no
			ROOT = {
				show_scope_change = no
				unsafe_war = {
					target = PREV
					casus_belli = free_tributary_cb
				}
			}
		}
		
		# Switch provinces over to ongoing_major_revolt_sympathetic modifier
		if = {
			limit = {
				any_realm_province = {
					is_local_resistance_similar_culture_to_ROOT_trigger = yes
					is_in_current_resistance_region_province = yes
				}
			}
			tooltip = {
				random_realm_province = {
					limit = { 
						is_local_resistance_similar_culture_to_ROOT_trigger = yes
						is_in_current_resistance_region_province = yes
					}
					add_province_modifier = { 
						name = ongoing_major_revolt_sympathetic
						duration = -1
					}
				}
			}
			hidden_tooltip = {
				any_realm_province = {
					limit = {
						is_local_resistance_similar_culture_to_ROOT_trigger = yes
						is_in_current_resistance_region_province = yes
					}
					remove_province_modifier = ongoing_major_revolt
					add_province_modifier = { 
						name = ongoing_major_revolt_sympathetic
						duration = -1
					}
					county = {
						any_direct_de_jure_vassal_title = { refill_holding_levy = yes }
					}
				}
			}
			custom_tooltip = {
				text = EVTOPTB320726TT1A
			}
		}
		custom_tooltip = {
			text = EVTOPTA320727TT2
		}
	}
	
	# Don't join (tributary)
	option = {
		name = "EVTOPTB320727"
		trigger = {
			independent = yes
			is_tributary = yes
		}
		ai_chance = {
			factor = 0
			additive_modifier = {
				value = 100
				OR = {
					trait = loyal
					trait = content
					suzerain = {
						reverse_opinion = {
							who = ROOT
							value >= 70
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTB320727TT
		}
	}
}

# Notify characters that are already in revolt (cultural revolts, or vassals/tributaries that are fighting
# an independence war) and give them the same province modifiers as above (if applicable) as well as
# event troops
narrative_event = {
	id = 320728
	title = EVTNAME320726
	desc = EVTDESC320726
	picture = GFX_evt_burning_fire
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA320727"
		custom_tooltip = {
			text = EVTOPTA320726TT0
		}
		# Is a province revolt
		if = {
			limit = { rebel = yes }
			primary_title = { set_title_flag = major_revolt_rebel_title }
			# Spawn event troops
			any_war = {
				limit = {
					using_cb = cultural_revolt
				}
				defender = { save_event_target_as = current_revolt_defender }
				thirdparty_title_scope = {
					random_direct_de_jure_vassal_title = {
						limit = {
							holder_scope = { top_liege = { character = event_target:current_revolt_defender } }
						}
						location = {
							create_character = {
								random_traits = yes
								dynasty = none
								religion = THIS
								culture = THIS
								female = no
								age = 25
								trait = peasant_leader
								trait = tough_soldier
							}
							new_character = {
								spawn_unit = {
									province = PREV
									home = PREV
									owner = ROOT
									leader = THIS
									scaled_by_biggest_garrison = 3
									troops = {
										archers = { 5 5 }
										light_cavalry = { 4 4 }
										light_infantry = { 7 7 }
										heavy_infantry = { 4 4 }
									}
									attrition = 0.5
								}
							}
						}
					}
				}
			}
			custom_tooltip = {
				text = EVTOPTA320728TT1
			}
		}
		# Is a rebelling vassal/tributary
		else = {
			if = {
				limit = {
					OR = {
						# This will be true for tributaries
						in_revolt = no
						# This checks if the character is at the top level of the revolt (i.e. not a vassal of a faction leader)
						top_liege = { character = ROOT }
					}
				}
				# Spawn some event troops, swap to ongoing_major_revolt_sympathetic modifier
				hidden_tooltip = {
					capital_scope = {
						create_character = {
							random_traits = yes
							dynasty = none
							religion = THIS
							culture = THIS
							female = no
							age = 25
							trait = peasant_leader
							trait = tough_soldier
						}
						new_character = {
							spawn_unit = {
								province = PREV
								home = PREV
								owner = ROOT
								leader = THIS
								scaled_by_biggest_garrison = 2
								troops = {
									archers = { 5 5 }
									light_cavalry = { 4 4 }
									light_infantry = { 7 7 }
									heavy_infantry = { 4 4 }
								}
								attrition = 0.5
							}
						}
					}
				}
				custom_tooltip = {
					text = EVTOPTA320728TT1
				}
			}
			
			# Switch provinces over to ongoing_major_revolt_sympathetic modifier - which provinces get
			# it depend on whether or not the revolter is a vassal or tributary
			if = {
				limit = { independent = no }
				if = {
					limit = {
						any_realm_province = {
							is_in_current_resistance_region_province = yes
							has_local_resistance_modifier_trigger = yes
						}
					}
					tooltip = {
						random_realm_province = {
							limit = { 
								is_in_current_resistance_region_province = yes
								has_local_resistance_modifier_trigger = yes
							}
							add_province_modifier = { 
								name = ongoing_major_revolt_sympathetic
								duration = -1
							}
						}
					}
					if = {
						# This checks if the character is at the top level of the revolt (i.e. not a vassal of a faction leader)
						# It's here to make sure the modifier and levy refill don't happen multiple times
						limit = { top_liege = { character = ROOT } }
						hidden_tooltip = {
							any_realm_province = {
								limit = { 
									is_in_current_resistance_region_province = yes
									has_local_resistance_modifier_trigger = yes
								}
								remove_province_modifier = ongoing_major_revolt
								add_province_modifier = { 
									name = ongoing_major_revolt_sympathetic
									duration = -1
								}
								county = {
									any_direct_de_jure_vassal_title = { refill_holding_levy = yes }
								}
							}
						}
					}
					custom_tooltip = {
						text = EVTOPTA320727TT1
					}
				}
			}
			else = {
				if = {
					limit = {
						any_realm_province = {
							is_local_resistance_similar_culture_to_ROOT_trigger = yes
							is_in_current_resistance_region_province = yes
						}
					}
					tooltip = {
						random_realm_province = {
							limit = { 
								is_local_resistance_similar_culture_to_ROOT_trigger = yes
								is_in_current_resistance_region_province = yes
							}
							add_province_modifier = { 
								name = ongoing_major_revolt_sympathetic
								duration = -1
							}
						}
					}
					hidden_tooltip = {
						any_realm_province = {
							limit = {
								is_local_resistance_similar_culture_to_ROOT_trigger = yes
								is_in_current_resistance_region_province = yes
							}
							remove_province_modifier = ongoing_major_revolt
							add_province_modifier = { 
								name = ongoing_major_revolt_sympathetic
								duration = -1
							}
							county = {
								any_direct_de_jure_vassal_title = { refill_holding_levy = yes }
							}
						}
					}
					custom_tooltip = {
						text = EVTOPTA320727TT1
					}
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTA320727TT2
		}
	}
}

# Notify everyone involved and give choices for compatible-culture vassals/tributaries to join the rebellion
# We can't make this a major event because it doesn't interact well with event targets in localisation
narrative_event = {
	id = 320729
	title = EVTNAME320726
	desc = EVTDESC320726
	picture = GFX_evt_burning_fire
	
	is_triggered_only = yes
	
	# Other independent rulers that may get involved in the revolt
	option = {
		name = "EVTOPTA320729"
		trigger = {
			independent = yes
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
			any_realm_province = { is_in_current_resistance_region_province = yes }
		}
		# TODO Notify targeted decision OR for AI, chance of supporting rebels
		custom_tooltip = {
			text = EVTOPTA320729TT
		}
	}
	
	# Other native rulers that can't intervene (vassals, essentially)
	option = {
		name = "EVTOPTB320729"
		trigger = {
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
			OR = {
				independent = no
				NOT = { any_realm_province = { is_in_current_resistance_region_province = yes } }
			}
		}
	}
	
	# Other foreigners with unpacified provinces in revolt region
	option = {
		name = "EVTOPTC320729"
		trigger = {
			top_liege = {
				has_local_resistance_provs_in_potential_major_revolt_from_FROM = yes
			}
		}
		tooltip = {
			any_realm_province = {
				limit = { 
					is_in_current_resistance_region_province = yes
					has_local_resistance_modifier_trigger = yes
				}
			}
			add_province_modifier = { 
				name = ongoing_major_revolt_minor
				duration = -1
			}
		}
		custom_tooltip = {
			text = EVTOPTC320729TTA
		}
		custom_tooltip = {
			text = EVTOPTC320729TTB
		}
	}
	
	# Other foreigners in revolt region without unpacified provinces
	option = {
		name = "EVTOPTD320729"
		trigger = {
			top_liege = {
				has_local_resistance_provs_in_potential_major_revolt_from_FROM = no
			}
		}
	}
}

# 320730 - Assign the major_revolt_rebel flag to any correct-culture tributaries or vassals 
# that revolt within the region while it's revolting + give them the modifiers and extra troops
# Triggered by on_add in the appropriate cbs

## TODO Events
# 320731 - Local Resistance/Major revolt wins major battle or siege, gains momentum (i.e. small boost in troops?)

# 320732 - Revolt in area of Major revolt under different overlord makes sufficient gains, major revolt spreads there in full

# 320733 - Maintenance event that spreads the Major Revolt modifier to newly acquired provinces/removes it from provinces that are now under native control

# In the rebellion cb
# - If the Major Revolt rebellion ends in rebel victory, small reduction in pacification progress across region
#	- Every neighbouring duchy (or the closest one if no neighbouring) has a ~60% chance of either significant reinforcements if ongoing or to (re-) revolt if there is no ongoing rebellion
#	- Every other ongoing rebellion has a smaller (~25%?) chance of getting minor reinforcements
#	- We designate a "rebellion leader" - in order of priority, either:
#		- the sponsor if the initial rebellion, if it exists
#		- the local "high king" (e.g. Baskonia, Broceliande, Cymru?, Fortriu/Fotla/Dalriada), if it is held, holds land "nearby", and the right culture
#		- the first rebel leader to win otherwise
#		- we can use an inheritable modifier to track it?
#	- When a rebellion wins, they will offer to become a tributary of the rebellion leader, if it exists (AI always accepts)
#		- If they hold the local kingship and both them and the rebels are feudal, will become direct vassal instead
#	- If the rebellion leader controls (directly or through tributaries) enough of the region, they will be offered the local kingship if they don't already hold it
#		- If feudal, all their tributaries in the revolt region will become vassals
#		- If tribal, only tributaries adjacent to the capital duchy will become vassals (+ next closest ones if the leader would be too small to keep the kingship title)
#	- The rebellion leader has targeted decisions to join the war of any ongoing rebellions once their own/initial rebellion war is over
# 320735 - Notification event to defender for reinforcements/further rebellions upon losing a rebellion war
# 320736 - Notification/request event to rebellion leader to become tributary
# 320737 - Event offering kingship to the rebellion leader

# 320738 - Notification event to rebellion leader that a revolt was defeated

# Check if there are any rebellions still ongoing for a Major Revolt, and once all have ended fire the ending event
character_event = {
	id = 320739
	hide_window = yes
	
	only_rulers = yes
	
	trigger = {
		has_landed_title = d_null
		is_major_revolt_ongoing_trigger = yes
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = { e_cymru = { has_title_flag = major_revolt_ongoing } }
			e_cymru = { capital_scope = { save_event_target_as = current_resistance_region_province } }
			check_if_major_revolt_is_over_and_fire_event_effect = yes
		}
		if = {
			limit = { e_alba = { has_title_flag = major_revolt_ongoing } }
			e_alba = { capital_scope = { save_event_target_as = current_resistance_region_province } }
			check_if_major_revolt_is_over_and_fire_event_effect = yes
		}
		if = {
			limit = { e_armorica = { has_title_flag = major_revolt_ongoing } }
			e_armorica = { capital_scope = { save_event_target_as = current_resistance_region_province } }
			check_if_major_revolt_is_over_and_fire_event_effect = yes
		}
		if = {
			limit = { e_aquitania = { has_title_flag = major_revolt_ongoing } }
			e_aquitania = { capital_scope = { save_event_target_as = current_resistance_region_province } }
			check_if_major_revolt_is_over_and_fire_event_effect = yes
		}
	}
}

# Revolt over, clean up modifiers and calculate result
character_event = {
	id = 320740	
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		any_province = {
			limit = { is_in_current_resistance_region_province = yes }
			remove_province_modifier = ongoing_major_revolt
			remove_province_modifier = ongoing_major_revolt_minor
			remove_province_modifier = ongoing_major_revolt_sympathetic
		}
		get_major_revolt_leader_character = yes
		
		event_target:current_resistance_region_province = {
			set_major_revolt_over_effect = yes
			get_major_revolt_variables_title_effect = yes
		}
		event_target:major_revolt_title = {
			clr_title_flag = complete_rebellion_victory
			clr_title_flag = major_rebellion_victory
			clr_title_flag = minor_rebellion_victory
			clr_title_flag = minor_rebellion_defeat
			clr_title_flag = major_rebellion_defeat
		}
		
		# If there are no more provinces of the local resistance culture in the region controlled by
		# foreigners, then automatically a major rebellion victory
		if = {
			limit = {
				NOT = {
					any_province = {
						is_in_current_resistance_region_province = yes
						local_resistance_potential_trigger = yes
					}
				}
			}
			event_target:major_revolt_title = { 
				set_title_flag = major_rebellion_victory 
				set_title_flag = complete_rebellion_victory		# Cosmetic only
			}
		}
		else = {
			event_target:major_revolt_title = {
				set_variable = {
					which = num_revolts_total
					which = num_revolts_succeeded
				}
				change_variable = {
					which = num_revolts_total
					which = num_revolts_crushed
				}
				if = {
					limit = {
						check_variable = {
							which = num_revolts_total
							value >= 1
						}
					}
					set_variable = {
						which = share_revolts_succeeded
						which = num_revolts_succeeded
					}
					divide_variable = {
						which = share_revolts_succeeded
						which = num_revolts_total
					}
				}
				else = {
					set_variable = {
						which = share_revolts_succeeded
						value = 0
					}
				}
				# If > 66% of the rebellions were successful, major rebellion victory - major decrease in pacification progress across region + major prestige loss
				if = {
					limit = {
						event_target:major_revolt_title = {
							check_variable = {
								which = share_revolts_succeeded
								value >= 0.66
							}
						}
					}
					set_title_flag = major_rebellion_victory
				}
				# If 35 - 60% of the rebellions were successful, minor rebellion victory - small decrease in pacification progress across region + a bit of prestige loss
				else_if = {
					limit = {
						event_target:major_revolt_title = {
							check_variable = {
								which = share_revolts_succeeded
								value >= 0.35
							}
						}
					}
					set_title_flag = minor_rebellion_victory
				}
				# If < 35% of the rebellions were successful, minor rebellion defeat - small increase in pacification progress across region + a bit of prestige
				else_if = {
					limit = {
						event_target:major_revolt_title = {
							check_variable = {
								which = share_revolts_succeeded
								value > 0
							}
						}
					}
					set_title_flag = minor_rebellion_defeat
				}
				# If none of the rebellions were successful, major rebellion defeat - moderate increase in pacification progress across region + major prestige
				else = {
					set_title_flag = major_rebellion_defeat
				}
			}
		}
		
		# Fire the actual event with effects
		any_playable_ruler = {
			character_event = { id = 320741 }
		}
	}
}

# Actual notification event for end of major revolt
# regardless of outcome the region is blocked from getting more Major Revolts for next 5/10(?) years
narrative_event = {
	id = 320741
	title = {
		text = EVTNAME320740_rebellion_defeat
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = major_rebellion_defeat
			}
		}
	}
	title = {
		text = EVTNAME320740_rebellion_stalemate
		trigger = {
			event_target:major_revolt_title = {
				OR = {
					has_title_flag = minor_rebellion_defeat
					has_title_flag = minor_rebellion_victory
				}
			}
		}
	}
	title = {
		text = EVTNAME320740_rebellion_victory
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = major_rebellion_victory
			}
		}
	}
	desc = {
		text = EVTDESC320740_rebellion_defeat
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = major_rebellion_defeat
			}
		}
	}
	desc = {
		text = EVTDESC320740_rebellion_minor_defeat
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = minor_rebellion_defeat
			}
		}
	}
	desc = {
		text = EVTDESC320740_rebellion_minor_victory
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = minor_rebellion_victory
			}
		}
	}
	desc = {
		text = EVTDESC320740_rebellion_victory
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = major_rebellion_victory
				NOT = { has_title_flag = complete_rebellion_victory }
			}
		}
	}
	desc = {
		text = EVTDESC320740_rebellion_complete_victory
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = major_rebellion_victory
				has_title_flag = complete_rebellion_victory
			}
		}
	}
    picture = { 
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = major_rebellion_defeat
			}
		}
        picture = GFX_evt_lord_overlooking_bridge
    }
    picture = { 
		trigger = {
			event_target:major_revolt_title = {
				OR = {
					has_title_flag = minor_rebellion_defeat
					has_title_flag = minor_rebellion_victory
				}
			}
		}
        picture = GFX_evt_castle_hill
    }
    picture = { 
		trigger = {
			event_target:major_revolt_title = {
				has_title_flag = major_rebellion_victory
			}
		}
        picture = GFX_evt_warrior_banners
    }
	
	is_triggered_only = yes
	
	# Major revolt leader, if there is one (and they were successful)
	option = {
		name = "EVTOPTA320740"
		trigger = {
			event_target:current_major_revolt_leader = { always = yes }
			event_target:current_major_revolt_leader = { character = PREV }
			independent = yes
			is_tributary = no
			is_local_resistance_region_culture_trigger = yes
			any_realm_province = { is_in_current_resistance_region_province = yes }
		}
		custom_tooltip = {
			text = EVTOPT320740TT
		}
		# TODO Differential prestige depending on outcome
		custom_tooltip = {
			text = EVTOPTA320740TT
		}
	}
	
	# Other rulers in the region of a similar culture to the revolt
	option = {
		name = "EVTOPTB320740"
		trigger = {
			OR = {
				NAND = {
					event_target:current_major_revolt_leader = { always = yes }
					event_target:current_major_revolt_leader = { character = PREV }
				}
				independent = no
				is_tributary = yes
			}
			top_liege = {
				is_local_resistance_region_culture_trigger = yes
				OR = {
					is_tributary = no
					suzerain = {
						is_local_resistance_region_culture_trigger = yes
					}
				}
			}
			is_local_resistance_region_culture_trigger = yes
			any_realm_province = { is_in_current_resistance_region_province = yes }
		}
		custom_tooltip = {
			text = EVTOPT320740TT
		}
		# TODO Minor differential prestige depending on outcome if independent?
		custom_tooltip = {
			text = EVTOPTB320740TT
		}
	}
	
	# Other native rulers still subject to foreign rule
	option = {
		name = "EVTOPTC320740"
		trigger = {
			NOT = {
				top_liege = {
					is_local_resistance_region_culture_trigger = yes
					OR = {
						is_tributary = no
						suzerain = {
							is_local_resistance_region_culture_trigger = yes
						}
					}
				}
			}
			is_local_resistance_region_culture_trigger = yes
			any_realm_province = { is_in_current_resistance_region_province = yes }
		}
		custom_tooltip = {
			text = EVTOPT320740TT
		}
		custom_tooltip = {
			text = EVTOPTC320740TT
		}
	}
	
	# Other foreigners with unpacified provinces in revolt region
	option = {
		name = "EVTOPTD320740"
		trigger = {
			top_liege = {
				OR = {
					any_realm_province = { 
						is_in_current_resistance_region_province = yes
						has_local_resistance_modifier_trigger = yes
					}
					any_tributary = {
						is_tributary = { type = march }
						any_realm_province = { 
							is_in_current_resistance_region_province = yes
							has_local_resistance_modifier_trigger = yes
						}
					}
				}
				is_local_resistance_region_culture_trigger = no
				culture_group = PREV
			}
			is_local_resistance_region_culture_trigger = no
		}
		custom_tooltip = {
			text = EVTOPT320740TT
		}
		custom_tooltip = {
			text = EVTOPTD320740TT
		}
	}
	
	# Other foreigners in revolt region without unpacified provinces
	option = {
		name = "EVTOPTE320740"
		trigger = {
			top_liege = {
				OR = {
					any_realm_province = { is_in_current_resistance_region_province = yes }
					any_tributary = {
						is_tributary = { type = march }
						any_realm_province = { is_in_current_resistance_region_province = yes }
					}
				}
				NOR = {
					any_realm_province = { 
						is_in_current_resistance_region_province = yes
						has_local_resistance_modifier_trigger = yes
					}
					any_tributary = {
						is_tributary = { type = march }
						any_realm_province = { 
							is_in_current_resistance_region_province = yes
							has_local_resistance_modifier_trigger = yes
						}
					}
				}
				is_local_resistance_region_culture_trigger = no
				culture_group = PREV
			}
			is_local_resistance_region_culture_trigger = no
		}
		custom_tooltip = {
			text = EVTOPT320740TT
		}
		custom_tooltip = {
			text = EVTOPTE320740TT
		}
	}
	
	# Uninvolved rulers
	option = {
		name = "EVTOPTF320740"
		trigger = {
			NOR = {
				# Is not a native ruler in the region
				AND = {
					is_local_resistance_region_culture_trigger = yes
					any_realm_province = { is_in_current_resistance_region_province = yes }
				}
				# Does not have provinces in the realm that are in the region, or is a different
				# culture group from the liege (and therefore indifferent about them)
				AND = {
					top_liege = {
						OR = {
							any_realm_province = { is_in_current_resistance_region_province = yes }
							any_tributary = {
								is_tributary = { type = march }
								any_realm_province = { is_in_current_resistance_region_province = yes }
							}
						}
						is_local_resistance_region_culture_trigger = no
						culture_group = PREV
					}
					is_local_resistance_region_culture_trigger = no
				}
			}
		}
		custom_tooltip = {
			text = EVTOPT320740TT
		}
		custom_tooltip = {
			text = EVTOPTF320740
		}
	}
}


## TODO Decisions 

# - Decision for local lord of Local Resistance region culture to stir up discontent in neighbouring provinces, which will generate a greater-than-average revolt in ~2 years and allow the lord to join
# 	- Takes 320750 - 320759
# - Decision for local vassal/tributary of Local Resistance region culture to stir up discontent in their own provinces, which after ~2 years will spawn an event army and attempt to declare war for independence
#	- Chance depending on intrigue that the liege finds out - can then demand they stop + reparations, if refused leads to early war (without event troops), if lost you have to abdicate
#	- Can attempt to call other local lords into war (?)
#	- Like normal Local Resistance rebellions, if they get to a certain warscore threshold (25%?) a Major Revolt will break out
#	- In addition to rebellions in the remaining provinces, they will also go event troops scaling based on the number of provinces that joined the revolt
