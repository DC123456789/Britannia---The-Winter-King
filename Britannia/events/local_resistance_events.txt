#########################################################
#
# 	LOCAL RESISTANCE EVENTS
#
# 	Id 320700 - 320899 reserved	
#
#########################################################

# Assign local resistance modifier
province_event = {
	id = 320700
	hide_window = yes

	trigger = {
		# always = no
		local_resistance_potential_trigger = yes
		NOT = { has_province_flag = has_local_resistance }
		NOT = { has_province_flag = local_resistance_pacified }
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		set_province_flag = has_local_resistance
		if = {
			limit = { has_province_flag = local_resistance_unpacifying }
			clr_province_flag = local_resistance_unpacifying
		}
		else = {
			if = {
				limit = { NOT = { has_province_flag = local_resistance_pacified_before } }
				set_variable = {
					which = pacification_years_remaining
					value = 40
				}
			}
			else = {
				set_variable = {
					which = pacification_years_remaining
					value = 25
				}
			}
		}
		
		set_proper_local_resistance_level_effect = yes
		
		owner = {
			character_event = { id = 320701 }
			any_liege = {
				character_event = { id = 320701 }
			}
		}
		
		save_event_target_as = current_resistance_region_province
		owner = {
			top_liege = {
				update_nationalist_revolt_size = yes
			}
		}
	}
}

# Notify owner/liege
character_event = {
	id = 320701
	desc = EVTDESC320701
	picture = GFX_evt_peasants
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	trigger = {
		ai = no
		NOT = { has_global_flag = disabled_local_resistance_alerts }
	}
	
	option = {
		name = "EVTOPTA320701"
		custom_tooltip = {
			text = EVTOPTA320701TT
		}
	}
	option = {
		name = "EVTOPTB320701"
		custom_tooltip = {
			text = EVTOPTB320701TT
		}
		set_global_flag = disabled_local_resistance_alerts
	}
}

# Remove modifier if no longer relevant
province_event = {
	id = 320705
	hide_window = yes

	trigger = {
		local_resistance_potential_trigger = no
		has_province_flag = has_local_resistance
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		clr_province_flag = has_local_resistance
		remove_province_modifier = local_resistance_1
		remove_province_modifier = local_resistance_2
		remove_province_modifier = local_resistance_3
		remove_province_modifier = local_resistance_1_quiet
		remove_province_modifier = local_resistance_2_quiet
		remove_province_modifier = local_resistance_3_quiet
		remove_province_modifier = local_resistance_1_march
		remove_province_modifier = local_resistance_2_march
		remove_province_modifier = local_resistance_3_march
		
		clr_province_flag = is_pacifying_province
		clr_province_flag = local_resistance_pacified
		set_province_flag = local_resistance_unpacifying
		
		save_event_target_as = current_resistance_region_province
		owner = {
			top_liege = {
				update_nationalist_revolt_size = yes
			}
		}
	}
}

# Swap to quiet modifier
province_event = {
	id = 320706
	hide_window = yes

	trigger = {
		has_province_flag = has_local_resistance
		OR = {
			has_province_modifier = local_resistance_1
			has_province_modifier = local_resistance_2
			has_province_modifier = local_resistance_3
			has_province_modifier = local_resistance_1_march
			has_province_modifier = local_resistance_2_march
			has_province_modifier = local_resistance_3_march
		}
		owner = { culture = ROOT }
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_1 
					has_province_modifier = local_resistance_1_march
				}
			}
			remove_province_modifier = local_resistance_1
			remove_province_modifier = local_resistance_1_march
			add_province_modifier = { 
				name = local_resistance_1_quiet
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_2
					has_province_modifier = local_resistance_2_march
				}
			}
			remove_province_modifier = local_resistance_2
			remove_province_modifier = local_resistance_2_march
			add_province_modifier = { 
				name = local_resistance_2_quiet
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_3
					has_province_modifier = local_resistance_3_march
				}
			}
			remove_province_modifier = local_resistance_3
			remove_province_modifier = local_resistance_3_march
			add_province_modifier = { 
				name = local_resistance_3_quiet
				duration = -1
			}
		}
	}
}

# Swap to march modifier
province_event = {
	id = 320707
	hide_window = yes

	trigger = {
		has_province_flag = has_local_resistance
		OR = {
			has_province_modifier = local_resistance_1
			has_province_modifier = local_resistance_2
			has_province_modifier = local_resistance_3
			has_province_modifier = local_resistance_1_quiet
			has_province_modifier = local_resistance_2_quiet
			has_province_modifier = local_resistance_3_quiet
		}
		owner = { 
			NOT = { culture = ROOT }
			top_liege = {
				is_tributary = {
					type = march
				}
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_1 
					has_province_modifier = local_resistance_1_quiet
				}
			}
			remove_province_modifier = local_resistance_1
			remove_province_modifier = local_resistance_1_quiet
			add_province_modifier = { 
				name = local_resistance_1_march
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_2
					has_province_modifier = local_resistance_2_quiet
				}
			}
			remove_province_modifier = local_resistance_2
			remove_province_modifier = local_resistance_2_quiet
			add_province_modifier = { 
				name = local_resistance_2_march
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_3
					has_province_modifier = local_resistance_3_quiet
				}
			}
			remove_province_modifier = local_resistance_3
			remove_province_modifier = local_resistance_3_quiet
			add_province_modifier = { 
				name = local_resistance_3_march
				duration = -1
			}
		}
	}
}

# Swap to normal modifier
province_event = {
	id = 320708
	hide_window = yes

	trigger = {
		has_province_flag = has_local_resistance
		OR = {
			has_province_modifier = local_resistance_1_quiet
			has_province_modifier = local_resistance_2_quiet
			has_province_modifier = local_resistance_3_quiet
			has_province_modifier = local_resistance_1_march
			has_province_modifier = local_resistance_2_march
			has_province_modifier = local_resistance_3_march
		}
		owner = { 
			NOR = {
				culture = ROOT 
				top_liege = {
					is_tributary = {
						type = march
					}
				}
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_1_quiet 
					has_province_modifier = local_resistance_1_march
				}
			}
			remove_province_modifier = local_resistance_1_quiet
			remove_province_modifier = local_resistance_1_march
			add_province_modifier = { 
				name = local_resistance_1
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_2_quiet
					has_province_modifier = local_resistance_2_march
				}
			}
			remove_province_modifier = local_resistance_2_quiet
			remove_province_modifier = local_resistance_2_march
			add_province_modifier = { 
				name = local_resistance_2
				duration = -1
			}
		}
		else_if = {
			limit = {
				OR = {
					has_province_modifier = local_resistance_3_quiet
					has_province_modifier = local_resistance_3_march
				}
			}
			remove_province_modifier = local_resistance_3_quiet
			remove_province_modifier = local_resistance_3_march
			add_province_modifier = { 
				name = local_resistance_3
				duration = -1
			}
		}
	}
}

# Pacification Progress (yearly timer)
character_event = {
	id = 320710
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		has_landed_title = d_null
	}
	
	immediate = {
		any_province = {
			limit = { 
				has_province_flag = is_pacifying_province 
			}
			owner = { save_event_target_as = province_owner }
			if = {
				limit = {
					# Pacification progress is paused if any holding in province is occupied, unless it's an internal war
					NOT = {
						any_province_holding = {
							is_occupied = yes
							owner = {
								same_realm = event_target:province_owner
							}
							controller = {
								NOT = { same_realm = event_target:province_owner }
							}
						}
					}
					
					# Pacification progress is also paused during major revolts
					has_active_major_revolt_trigger = no
				}
				subtract_variable = {
					which = pacification_years_remaining
					value = 1
				}
				if = {
					limit = {
						is_variable_equal = {
							which = pacification_years_remaining
							value = 25
						}
					}
					if = {
						limit = { has_province_modifier = local_resistance_3 }
						remove_province_modifier = local_resistance_3
						add_province_modifier = { 
							name = local_resistance_2
							duration = -1
						}
					}
					else_if = {
						limit = { has_province_modifier = local_resistance_3_quiet }
						remove_province_modifier = local_resistance_3_quiet
						add_province_modifier = { 
							name = local_resistance_2_quiet
							duration = -1
						}
					}
					else_if = {
						limit = { has_province_modifier = local_resistance_3_march }
						remove_province_modifier = local_resistance_3_march
						add_province_modifier = { 
							name = local_resistance_2_march
							duration = -1
						}
					}
				}
				else_if = {
					limit = {
						is_variable_equal = {
							which = pacification_years_remaining
							value = 10
						}
					}
					if = {
						limit = { has_province_modifier = local_resistance_2 }
						remove_province_modifier = local_resistance_2
						add_province_modifier = { 
							name = local_resistance_1
							duration = -1
						}
					}
					else_if = {
						limit = { has_province_modifier = local_resistance_2_quiet }
						remove_province_modifier = local_resistance_2_quiet
						add_province_modifier = { 
							name = local_resistance_1_quiet
							duration = -1
						}
					}
					else_if = {
						limit = { has_province_modifier = local_resistance_2_march }
						remove_province_modifier = local_resistance_2_march
						add_province_modifier = { 
							name = local_resistance_1_march
							duration = -1
						}
					}
				}
				else_if = {
					limit = {
						is_variable_equal = {
							which = pacification_years_remaining
							value = 0
						}
					}
					remove_province_modifier = local_resistance_1
					remove_province_modifier = local_resistance_1_quiet
					remove_province_modifier = local_resistance_1_march
					clr_province_flag = is_pacifying_province
					clr_province_flag = has_local_resistance
					set_province_flag = local_resistance_pacified
					set_province_flag = local_resistance_pacified_before
		
					set_variable = {
						which = nationalist_revolt_progress
						value = 0
					}
				}
			}
		}
		
		# Pacification progress rolls back gradually if not controlled by a pacifying culture
		any_province = {
			limit = { 
				has_province_flag = local_resistance_unpacifying 
			}
			change_variable = {
				which = pacification_years_remaining
				value = 1
			}
			if = {
				limit = {
					OR = {
						check_variable = {
							which = pacification_years_remaining
							value = 40
						}
						AND = {
							has_province_flag = local_resistance_pacified_before
							check_variable = {
								which = pacification_years_remaining
								value = 25
							}
						}
					}
				}
				set_variable = {
					which = pacification_years_remaining
					value = 0
				}
				clr_province_flag = local_resistance_unpacifying
			}
		}
		
		# Calculate Nationalist revolt progress for each province with local resistance
		# any_province = {
			# if = {
				# limit = { has_province_flag = has_local_resistance }
				# if = {
					# limit = { NOT = { has_province_flag = nationalist_revolt_progress_increased } }
					
					# save_event_target_as = current_resistance_region_province
					
					# clr_global_flag = nationalist_revolt_imminent
					# clear_event_target = highest_revolt_progress_province
					
					# owner = {
						# top_liege = {	
							# # Calculate revolt progress and potential size
							# update_nationalist_revolt_size = yes
							
							# # Now we add the yearly increase to ALL of the realm's provinces (including marches)
							# any_realm_province = {
								# limit = {
									# has_province_flag = has_local_resistance
									# NOT = { has_province_flag = nationalist_revolt_progress_increased }
									# is_in_current_resistance_region_province = yes
								# }
								# set_province_flag = nationalist_revolt_progress_increased
								# change_variable = {
									# which = nationalist_revolt_progress
									# which = global_nat_revolt_progress_increase
								# }
								
								# # Check if eligible for a major revolt
								# if = {
									# limit = {
										# check_variable = {
											# which = nationalist_revolt_progress
											# value = 100
										# }
										# OR = {
											# NOT = { has_global_flag = nationalist_revolt_imminent }
											# check_variable = {
												# which = nationalist_revolt_progress
												# which = event_target:highest_revolt_progress_province
											# }
										# }
									# }
									# set_global_flag = nationalist_revolt_imminent
									# save_event_target_as = highest_revolt_progress_province
								# }
							# }
							# if = {
								# limit = { is_tributary = { type = march } }
								# suzerain = {
									# any_realm_province = {
										# limit = {
											# has_province_flag = has_local_resistance
											# NOT = { has_province_flag = nationalist_revolt_progress_increased }
											# is_in_current_resistance_region_province = yes
										# }
										# set_province_flag = nationalist_revolt_progress_increased
										# change_variable = {
											# which = nationalist_revolt_progress
											# which = global_nat_revolt_progress_increase
										# }
								
										# # Check if eligible for a major revolt
										# if = {
											# limit = {
												# check_variable = {
													# which = nationalist_revolt_progress
													# value = 100
												# }
												# OR = {
													# NOT = { has_global_flag = nationalist_revolt_imminent }
													# check_variable = {
														# which = nationalist_revolt_progress
														# which = event_target:highest_revolt_progress_province
													# }
												# }
											# }
											# set_global_flag = nationalist_revolt_imminent
											# save_event_target_as = highest_revolt_progress_province
										# }
									# }
									# # Check other marches of suzerain
									# any_tributary = {
										# limit = { 
											# is_tributary = { type = march } 
											# NOT = { character = PREVPREV }
										# }
										# any_realm_province = {
											# limit = {
												# has_province_flag = has_local_resistance
												# NOT = { has_province_flag = nationalist_revolt_progress_increased }
												# is_in_current_resistance_region_province = yes
											# }
											# set_province_flag = nationalist_revolt_progress_increased
											# change_variable = {
												# which = nationalist_revolt_progress
												# which = global_nat_revolt_progress_increase
											# }
								
											# # Check if eligible for a major revolt
											# if = {
												# limit = {
													# check_variable = {
														# which = nationalist_revolt_progress
														# value = 100
													# }
													# OR = {
														# NOT = { has_global_flag = nationalist_revolt_imminent }
														# check_variable = {
															# which = nationalist_revolt_progress
															# which = event_target:highest_revolt_progress_province
														# }
													# }
												# }
												# set_global_flag = nationalist_revolt_imminent
												# save_event_target_as = highest_revolt_progress_province
											# }
										# }
									# }
								# }
							# }
							# any_tributary = {
								# limit = { is_tributary = { type = march } }
								# any_realm_province = {
									# limit = {
										# has_province_flag = has_local_resistance
										# NOT = { has_province_flag = nationalist_revolt_progress_increased }
										# is_in_current_resistance_region_province = yes
									# }
									# set_province_flag = nationalist_revolt_progress_increased
									# change_variable = {
										# which = nationalist_revolt_progress
										# which = global_nat_revolt_progress_increase
									# }
								
									# # Check if eligible for a major revolt
									# if = {
										# limit = {
											# check_variable = {
												# which = nationalist_revolt_progress
												# value = 100
											# }
											# OR = {
												# NOT = { has_global_flag = nationalist_revolt_imminent }
												# check_variable = {
													# which = nationalist_revolt_progress
													# which = event_target:highest_revolt_progress_province
												# }
											# }
										# }
										# set_global_flag = nationalist_revolt_imminent
										# save_event_target_as = highest_revolt_progress_province
									# }
								# }
							# }
						# }
					# }
					
					# if = {
						# limit = { has_global_flag = nationalist_revolt_imminent }
						# event_target:highest_revolt_progress_province = {
							# # Roll for chance of revolt depending on the province with the highest progress
							# random = {
								# chance = 40
								# additive_modifier = {
									# value = 10
									# check_variable = {
										# which = nationalist_revolt_progress
										# value = 105
									# }
								# }
								# additive_modifier = {
									# value = 10
									# check_variable = {
										# which = nationalist_revolt_progress
										# value = 110
									# }
								# }
								# additive_modifier = {
									# value = 10
									# check_variable = {
										# which = nationalist_revolt_progress
										# value = 115
									# }
								# }
								# additive_modifier = {
									# value = 10
									# check_variable = {
										# which = nationalist_revolt_progress
										# value = 120
									# }
								# }
								# additive_modifier = {
									# value = 10
									# check_variable = {
										# which = nationalist_revolt_progress
										# value = 125
									# }
								# }
								# additive_modifier = {
									# value = 10
									# check_variable = {
										# which = nationalist_revolt_progress
										# value = 130
									# }
								# }
								# # Trigger the revolt
								# #province_event = { id = 320720 days = 90 random = 180 }
								# province_event = { id = 320720 }
							# }
						# }
						# clr_global_flag = nationalist_revolt_imminent
					# }
				# }
			# }
			# # Revolt progress rolls back if not controlled by a resistance-generating culture
			# else_if = {
				# limit = {
					# NOT = {
						# is_variable_equal = {
							# which = nationalist_revolt_progress
							# value = 0
						# }
					# }
				# }
				# subtract_variable = {
					# which = nationalist_revolt_progress
					# value = 5
				# }
				# if = {
					# limit = {
						# NOT = {
							# check_variable = {
								# which = nationalist_revolt_progress
								# value = 0
							# }
						# }
					# }
					# set_variable = {
						# which = nationalist_revolt_progress
						# value = 0
					# }
				# }
			# }				
		# }
		
		# # Cleanup
		# any_province = {
			# limit = {
				# has_province_flag = nationalist_revolt_progress_increased
			# }
			# clr_province_flag = nationalist_revolt_progress_increased
		# }
	}
}

# Progress set back by revolts. Fired from 'on_siege_over_winner'.
character_event = {
	id = 320711
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		rebel = yes
		any_war = {
			attacker = { character = ROOT }
			OR = {
				using_cb = peasant_revolt
				using_cb = heretic_revolt
				using_cb = religious_revolt
				using_cb = cultural_revolt
				using_cb = liberation_revolt
				# using_cb = nationalist_revolt_wales
			}
		}
		FROM = {
			location = {
				has_province_flag = has_local_resistance
				capital_holding = {
					owner = {
						ROOT_FROM = {
							owner = {
								same_realm = PREVPREV
							}
						}
					}
				}
			}
		}
	}
	
	immediate = {
		location = {
			change_variable = {
				which = pacification_years_remaining
				value = 3
			}
			if = {
				limit = {
					NOT = { has_province_flag = local_resistance_pacified_before }
					check_variable = {
						which = pacification_years_remaining
						value = 40
					}
				}
				set_variable = {
					which = pacification_years_remaining
					value = 40
				}
			}
			else_if = {
				limit = {
					has_province_flag = local_resistance_pacified_before
					check_variable = {
						which = pacification_years_remaining
						value = 25
					}
				}
				set_variable = {
					which = pacification_years_remaining
					value = 25
				}
			}
			
			# Increase resistance level if applicable
			set_proper_local_resistance_level_effect = yes
		}
	}
}

### MAJOR REVOLT EVENTS ###

# Flag revolts originating from a province with Local Resistance
character_event = {
	id = 320720
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = { FROM = { has_local_resistance_modifier_trigger = yes } }
			primary_title = { set_title_flag = local_resistance_revolt }
		}
	}
}

# Local Resistance revolt reaches 25% warscore, notify all relevant lords that a major revolt might break out soon
character_event = {
	id = 320721
	hide_window = yes
	
	only_rulers = yes
	
	trigger = {
		primary_title = { 
			has_title_flag = local_resistance_revolt
			NOT = { has_title_flag = major_revolt_warning }
		}
		war = yes
		any_war = {
			war_score >= 25
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		any_war = {
			limit = { war_score >= 25 }
			defender = { save_event_target_as = revolt_defender }
			thirdparty_title_scope = {
				save_event_target_as = revolt_target
				random_direct_de_jure_vassal_title = {
					limit = { owner = { top_liege = { character = event_target:revolt_defender } } }
					save_event_target_as = current_resistance_region_province 
				}
			}
			event_target:current_resistance_region_province = {
				calc_num_of_local_resistance_provinces_in_region_effect = yes
			}
			if = {
				limit = { is_major_revolt_possible_for_war_trigger = yes }
				ROOT = { primary_title = { set_title_flag = major_revolt_warning } }
				# We notify the defender...
				defender = {
					character_event = { id = 320722 }
					# Any lords in the defender's realm who might be hit by the major revolt...
					any_realm_lord = {
						limit = { 
							any_realm_province = { 
								is_in_current_resistance_region_province = yes
								has_province_flag = has_local_resistance
							} 
						}
						character_event = { id = 320722 }
					}
					if = {
						limit = { is_tributary = { type = march } }
						# The defender's overlord, if the defender is a march...
						suzerain = {
							character_event = { id = 320722 }
							# Any lords in the overlord's realm who might be hit by the major revolt...
							any_realm_lord = {
								limit = { 
									any_realm_province = { 
										is_in_current_resistance_region_province = yes
										has_province_flag = has_local_resistance
									} 
								}
								character_event = { id = 320722 }
							}
							# Any other marches (and their vassals) under the overlord who might be hit by the major revolt...
							any_tributary = {
								limit = { 
									is_tributary = { type = march } 
									any_realm_province = { 
										is_in_current_resistance_region_province = yes
										has_province_flag = has_local_resistance
									}
								}
								character_event = { id = 320722 }
								any_realm_lord = {
									limit = { 
										any_realm_province = { 
											is_in_current_resistance_region_province = yes
											has_province_flag = has_local_resistance
										} 
									}
									character_event = { id = 320722 }
								}
							}
							# Any tributaries under the overlord who might be able to rebel...
							any_tributary = {
								limit = { 
									NOT = { is_tributary = { type = march } }
									is_local_resistance_similar_culture_to_ROOT_trigger = yes
									any_realm_province = { is_in_current_resistance_region_province = yes }
								}
								character_event = { id = 320722 }
							}
						}
					}
					# Any marches (and their vassals) under the defender who might be hit by the major revolt...
					any_tributary = {
						limit = { 
							is_tributary = { type = march } 
							any_realm_province = { 
								is_in_current_resistance_region_province = yes
								has_province_flag = has_local_resistance
							}
						}
						character_event = { id = 320722 }
						any_realm_lord = {
							limit = { 
								any_realm_province = { 
									is_in_current_resistance_region_province = yes
									has_province_flag = has_local_resistance
								} 
							}
							character_event = { id = 320722 }
						}
					}
					# ...and any tributaries under the defender who might be able to rebel
					any_tributary = {
						limit = { 
							NOT = { is_tributary = { type = march } }
							is_local_resistance_similar_culture_to_ROOT_trigger = yes
							any_realm_province = { is_in_current_resistance_region_province = yes }
						}
						character_event = { id = 320722 }
					}
				}
			}
		}		
	}
}

# Warning event that Major Revolt is near
character_event = {
	id = 320722
	desc = {
		text = EVTDESC320722_defender
		trigger = {
			any_war = {
				attacker = { character = FROM }
				defender = { character = ROOT }
			}
		}
	}
	desc = {
		text = EVTDESC320722_defender_vassal_or_march
		trigger = {
			top_liege = {
				OR = {
					any_war = {
						attacker = { character = FROM }
						defender = { character = PREV }
					}
					any_tributary = {
						any_war = {
							attacker = { character = FROM }
							defender = { character = PREV }
						}
					}
					AND = {
						is_tributary = { type = march }
						OR = {
							any_war = {
								attacker = { character = FROM }
								defender = { character = PREV }
							}
							any_tributary = {
								NOT = { character = ROOT }
								any_war = {
									attacker = { character = FROM }
									defender = { character = PREV }
								}
							}
						}
					}
				}
			}
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = no }
		}
	}
	desc = {
		text = EVTDESC320722_suzerain
		trigger = {
			any_tributary = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = PREV }
				}
			}
		}
	}
	desc = {
		text = EVTDESC320722_defender_vassal_or_march
		trigger = {
			is_tributary = { type = march }
			suzerain = {
				OR = {
					any_war = {
						attacker = { character = FROM }
						defender = { character = PREV }
					}
					any_tributary = {
						NOT = { character = ROOT }
						any_war = {
							attacker = { character = FROM }
							defender = { character = PREV }
						}
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESC320722_potential_rebel
		trigger = {
			NOR = {				
				any_war = {
					attacker = { character = FROM }
					defender = { character = ROOT }
				}
				any_tributary = {
					any_war = {
						attacker = { character = FROM }
						defender = { character = PREV }
					}
				}
			}
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
		}
	}
	picture = GFX_evt_peasants
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	trigger = {
		ai = no
		NOT = { has_global_flag = disabled_major_revolt_warnings }
	}
	
	immediate = {
		if = {
			limit = { is_tributary = yes }
			suzerain = { save_event_target_as = current_suzerain }
		}
	}
	
	option = {		# Defender
		name = "EVTOPTA320722"
		trigger = {
			any_war = {
				attacker = { character = FROM }
				defender = { character = ROOT }
			}	
		}
		custom_tooltip = {
			text = EVTOPTA320722TTA
		}
	}
	
	option = {		# Vassal, not same culture as revolt
		name = "EVTOPTB320722"
		trigger = {
			independent = no
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = no }
		}
		custom_tooltip = {
			text = EVTOPTA320722TTA
		}
	}
	
	option = {		# Suzerain
		name = "EVTOPTC320722"
		trigger = {
			NOT = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = ROOT }
				}
			}
			any_tributary = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = PREV }
				}
			}
		}
		custom_tooltip = {
			text = EVTOPTA320722TTA
		}
	}
	
	option = {		# Vassal/Tributary, same culture as revolt
		name = "EVTOPTD320722"
		trigger = {
			OR = {				
				independent = no
				is_tributary = yes
			}
			NOT = {
				any_war = {
					attacker = { character = FROM }
					defender = { character = ROOT }
				}
			}
			FROM = { is_local_resistance_similar_culture_to_ROOT_trigger = yes }
		}
		custom_tooltip = {
			text = EVTOPTA320722TTD
		}
	}
	
	option = {		# Dismiss warnings
		name = "EVTOPTE320722"
		custom_tooltip = {
			text = EVTOPTA320722TTE
		}
		set_global_flag = disabled_major_revolt_warnings
	}
}

# 320723 - Local Resistance revolt reaches 40-50%(?) warscore, Major Revolt breaks out with nearby duchies revolting and large revolt risk increases across the region
# TODO Also want to do a fallback check for if a local resistance revolt wins without triggering this event
character_event = {
	id = 320723
	hide_window = yes
	
	only_rulers = yes
	
	trigger = {
		primary_title = { 
			has_title_flag = local_resistance_revolt
			NOT = { has_title_flag = major_revolt_warning }
		}
		war = yes
		any_war = {
			war_score >= 50
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		any_war = {
			limit = { war_score >= 50 }
			thirdparty_title_scope = { 
				random_direct_de_jure_vassal_title = {
					limit = { owner = { top_liege = { character = defender } } }
					save_event_target_as = current_resistance_region_province 
				}
			}
			event_target:current_resistance_region_province = {
				calc_num_of_local_resistance_provinces_in_region_effect = yes
			}
			if = {
				# Check that there aren't any major revolts already ongoing in the region
				limit = { is_major_revolt_possible_for_war_trigger = yes }
				
				# Flag that the region officially has a major revolt breaking out
				event_target:current_resistance_region_province = { set_major_revolt_active_effect = yes }
				
				# Try to have the closest 66% of unpacified duchies (and at least 2) revolt immediately
				# All unpacified provinces in the region belonging to the overlord or one of their tributaries will get a modifier giving large revolt risk increases and marking them as part of the revolt
				# Other unpacified provinces in the region not held by the overlord or one of their marches will get a smaller revolt risk increase and a small rebellion
				# If that rebellion gains momentum then the revolt will spread in full to the other realm's provinces
				# Notify everyone involved
			}
		}
	}
}

# 320724 - Notify major revolt

# 320725 - Ask nearby lords of correct culture to join Major Revolt (for AI - humans will get targeted decisions instead)
#	- For tributaries in the region of the right culture, will instead be asked if they want to revolt

# 320726 - Local Resistance/Major revolt wins major battle or siege, gains momentum (i.e. small boost in troops?)

# 320727 - Revolt in area of Major revolt under different overlord makes sufficient gains, major revolt spreads there in full

# In the rebellion cb
# - If the Major Revolt rebellion ends in rebel victory, small reduction in pacification progress across region
#	- Every neighbouring duchy (or the closest one if no neighbouring) has a ~60% chance of either significant reinforcements if ongoing or to (re-) revolt if there is no ongoing rebellion
#	- Every other ongoing rebellion has a smaller (~25%?) chance of getting minor reinforcements
#	- We designate a "rebellion leader" - in order of priority, either:
#		- the sponsor if the initial rebellion, if it exists
#		- the local "high king" (e.g. Baskonia, Broceliande, Cymru?, Fortriu/Fotla/Dalriada), if it is held, holds land "nearby", and the right culture
#		- the first rebel leader to win otherwise
#		- we can use an inheritable modifier to track it?
#	- When a rebellion wins, they will offer to become a tributary of the rebellion leader, if it exists (AI always accepts)
#		- If they hold the local kingship and both them and the rebels are feudal, will become direct vassal instead
#	- If the rebellion leader controls (directly or through tributaries) enough of the region, they will be offered the local kingship if they don't already hold it
#		- If feudal, all their tributaries in the revolt region will become vassals
#		- If tribal, only tributaries adjacent to the capital duchy will become vassals (+ next closest ones if the leader would be too small to keep the kingship title)
#	- The rebellion leader has targeted decisions to join the war of any ongoing rebellions once their own/initial rebellion war is over
# 320728 - Notification event to defender for reinforcements/further rebellions upon losing a rebellion war
# 320729 - Notification/request event to rebellion leader to become tributary
# 320730 - Event offering kingship to the rebellion leader

# - If the Major Revolt rebellion ends in overlord victory, small increase in pacification progress across region
# 320731 - Notification event to rebellion leader that revolt was defeated

# 320735 - Notification event that major event is over, regardless of outcome the region is blocked from getting more Major Revolts for next 5(?) years
#	- Triggers only when all rebellions in the region are over

# Decisions 

# - Decision for local lord of Local Resistance region culture to stir up discontent in neighbouring provinces, which will generate a greater-than-average revolt in ~2 years and allow the lord to join
# 	- Takes 320740 - 320749
# - Decision for local vassal of Local Resistance region culture to stir up discontent in their own provinces, which after ~2 years will spawn an event army and attempt to declare war for independence
#	- Can attempt to call other local lords into war
#	- Like normal Local Resistance rebellions, if they get to a certain warscore threshold (25%?) a Major Revolt will break out
#	- In addition to rebellions in the remaining provinces, they will also go event troops scaling based on the number of provinces that joined the revolt

# TODO OBSOLETE, DELETE
# # Revolt triggered (not by player)
# province_event = {
	# id = 320720
	# hide_window = yes
	
	# is_triggered_only = yes

	# trigger = {
		# local_resistance_potential_trigger = yes
		# has_province_flag = has_local_resistance
		# check_variable = {
			# which = nationalist_revolt_progress
			# value = 100
		# }
		# is_province_liege_not_defending_against_nat_revolt_trigger = yes
	# }
	
	# immediate = {
		# save_event_target_as = current_resistance_region_province
		# owner = { top_liege = { save_event_target_as = target_ruler } }
		
		# # Pick the strongest eligible revolt leader
		# random_playable_ruler = {
			# limit = {
				# ai = yes
				# war = no
				# is_local_resistance_similar_culture_to_ROOT_trigger = yes
				# NOT = {
					# any_war = {
						# AND = {
							# attacker = { character = PREVPREV }
							# defender = { is_target_ruler_or_associated_march_trigger = yes }
						# }
						# AND = {
							# defender = { character = PREVPREV }
							# attacker = { is_target_ruler_or_associated_march_trigger = yes }
						# }
					# }
				# }
				# OR = {
					# AND = {
						# independent = yes
						# is_tributary = no
						# any_realm_province = {
							# any_neighbor_province = {
								# is_local_resistance_similar_culture_to_ROOT_trigger = yes
								# is_in_current_resistance_region_province = yes
								# owner = {
									# top_liege = {
										# is_target_ruler_or_associated_march_trigger = yes
										# NOR = {
											# has_non_aggression_pact_with = PREVPREVPREVPREV
											# reverse_opinion = {
												# who = PREVPREVPREVPREV
												# value = 70
											# }
										# }
									# }
								# }
							# }
						# }
					# }
					# AND = {
						# independent = yes
						# is_tributary = yes
						# suzerain = {
							# is_target_ruler_or_associated_march_trigger = yes
							# NOR = {
								# has_non_aggression_pact_with = PREV
								# reverse_opinion = {
									# who = PREV
									# value = 70
								# }
							# }
						# }
						# any_realm_province = {
							# OR = {
								# is_in_current_resistance_region_province = yes
								# any_neighbor_province = {
									# is_local_resistance_similar_culture_to_ROOT_trigger = yes
									# is_in_current_resistance_region_province = yes
									# owner = {
										# top_liege = {
											# is_target_ruler_or_associated_march_trigger = yes
										# }
									# }
								# }
							# }
						# }
					# }
					# AND = {
						# independent = no
						# liege = { 
							# independent = yes 
							# is_target_ruler_or_associated_march_trigger = yes
							# NOR = {
								# has_non_aggression_pact_with = PREV
								# reverse_opinion = {
									# who = PREV
									# value = 70
								# }
							# }
						# }
						# any_realm_province = {
							# is_in_current_resistance_region_province = yes
						# }
					# }
				# }
				# NOT = {
					# any_playable_ruler = {
						# ai = yes
						# war = no
						# is_local_resistance_similar_culture_to_ROOT_trigger = yes
						# NOT = {
							# any_war = {
								# AND = {
									# attacker = { character = PREVPREV }
									# defender = { is_target_ruler_or_associated_march_trigger = yes }
								# }
								# AND = {
									# defender = { character = PREVPREV }
									# attacker = { is_target_ruler_or_associated_march_trigger = yes }
								# }
							# }
						# }
						# OR = {
							# AND = {
								# independent = yes
								# is_tributary = no
								# any_realm_province = {
									# any_neighbor_province = {
										# is_local_resistance_similar_culture_to_ROOT_trigger = yes
										# is_in_current_resistance_region_province = yes
										# owner = {
											# top_liege = {
												# is_target_ruler_or_associated_march_trigger = yes
												# NOR = {
													# has_non_aggression_pact_with = PREVPREVPREVPREV
													# reverse_opinion = {
														# who = PREVPREVPREVPREV
														# value = 70
													# }
												# }
											# }
										# }
									# }
								# }
							# }
							# AND = {
								# independent = yes
								# is_tributary = yes
								# suzerain = {
									# is_target_ruler_or_associated_march_trigger = yes
									# NOR = {
										# has_non_aggression_pact_with = PREV
										# reverse_opinion = {
											# who = PREV
											# value = 70
										# }
									# }
								# }
								# any_realm_province = {
									# OR = {
										# is_in_current_resistance_region_province = yes
										# any_neighbor_province = {
											# is_local_resistance_similar_culture_to_ROOT_trigger = yes
											# is_in_current_resistance_region_province = yes
											# owner = {
												# top_liege = {
													# is_target_ruler_or_associated_march_trigger = yes
												# }
											# }
										# }
									# }
								# }
							# }
							# AND = {
								# independent = no
								# liege = { 
									# independent = yes 
									# is_target_ruler_or_associated_march_trigger = yes
									# NOR = {
										# has_non_aggression_pact_with = PREV
										# reverse_opinion = {
											# who = PREV
											# value = 70
										# }
									# }
								# }
								# any_realm_province = {
									# is_in_current_resistance_region_province = yes
								# }
							# }
						# }
						# relative_power = {
							# who = PREV
							# power > 1
						# }
					# }
				# }
			# }
			# save_event_target_as = revolt_leader
			# if = {
				# limit = {
					# independent = no
				# }
				# random_realm_province = {
					# limit = {
						# is_in_current_resistance_region_province = yes
					# }
					# preferred_limit = {
						# owner = {
							# character = PREVPREV
							# capital_scope = { province = PREVPREV }
						# }
					# }
					# preferred_limit = {
						# owner = {
							# character = PREVPREV
						# }
					# }
					# save_event_target_as = nationalist_revolt_target_province
				# }
			# }
			# else_if = {
				# limit = {
					# is_tributary = yes
				# }
				# random_realm_province = {
					# limit = {
						# OR = {
							# is_in_current_resistance_region_province = yes
							# any_neighbor_province = {
								# is_local_resistance_similar_culture_to_ROOT_trigger = yes
								# is_in_current_resistance_region_province = yes
								# owner = {
									# top_liege = {
										# is_target_ruler_or_associated_march_trigger = yes
									# }
								# }
							# }
						# }
					# }
					# preferred_limit = {
						# owner = {
							# character = PREVPREV
							# capital_scope = { province = PREVPREV }
						# }
					# }
					# preferred_limit = {
						# owner = {
							# character = PREVPREV
						# }
					# }
					# save_event_target_as = nationalist_revolt_target_province
				# }
			# }
			# else = {
				# random_realm_province = {
					# limit = {
						# any_neighbor_province = {
							# is_local_resistance_similar_culture_to_ROOT_trigger = yes
							# is_in_current_resistance_region_province = yes
							# owner = {
								# top_liege = {
									# is_target_ruler_or_associated_march_trigger = yes
								# }
							# }
						# }
					# }
					# random_neighbor_province = {
						# limit = {
							# is_local_resistance_similar_culture_to_ROOT_trigger = yes
							# is_in_current_resistance_region_province = yes
							# owner = {
								# top_liege = {
									# is_target_ruler_or_associated_march_trigger = yes
								# }
							# }
						# }
						# save_event_target_as = nationalist_revolt_target_province
					# }
				# }
			# }
		# }
		
		# if = {
			# limit = {
				# NOT = {
					# event_target:revolt_leader = { always = yes }
				# }
			# }
			# # Create a new revolter
			# create_character = {
				# random_traits = yes
				# dynasty = random
				# religion = ROOT
				# culture = ROOT
				# female = no
				# age = 23
				# health = 7
				# fertility = 0.7
				# attributes = {
					# martial = 8
					# diplomacy = 9
				# }
				# trait = just
				# trait = brave
				# trait = gregarious
				# trait = ambitious
				# trait = brilliant_strategist
				# trait = inspiring_leader
			# }
			
			# new_character = {
				# set_character_flag = nationalist_rebel
				
				# create_title = {
					# tier = DUKE
					# landless = yes
					# temporary = yes
					# rebel = yes
					# culture = ROOT
					# name = "MAJOR_NATIONALIST_REVOLT"
					# holder = THIS
				# }
				
				# wealth = 150
				
				# set_proper_rebel_government_effect = yes
			# }
			
			# ROOT = { save_event_target_as = nationalist_revolt_target_province }
		# }
		
		# event_target:revolt_leader = {
			# character_event = { id = 320721 }
		# }
	# }
# }

# # Event handling the actual revolt
# character_event = {
	# id = 320721
	# hide_window = yes
	
	# is_triggered_only = yes

	# immediate = {				
		# event_target:nationalist_revolt_target_province = {
			# save_event_target_as = current_resistance_region_province
			
			# # Spawn event troops
			# ROOT = {
				# set_variable = {
					# which = nat_revolt_estimated_size
					# which = PREV
				# }
				# while = {
					# limit = {
						# check_variable = {
							# which = nat_revolt_estimated_size
							# value = 1
						# }
					# }
					# spawn_unit = {
						# province = event_target:nationalist_revolt_target_province
						# home = event_target:nationalist_revolt_target_province
						# troops = {
							# light_infantry = { 4 4 }
							# heavy_infantry = { 2 2 }
							# pikemen = { 3 3 }
							# archers = { 1 1 }
						# }
						# attrition = 0.25
						# merge = yes
						# disband_on_peace = yes
						# maintenance_multiplier = 0
					# }
					# subtract_variable = {
						# which = nat_revolt_estimated_size
						# value = 10
					# }
				# }
			# }
			
			# # Clear revolt progress
			# clear_nationalist_revolt_progress_from_realm_region_effect = yes
		# }
		
		# # Declare the war
		# if = {
			# limit = { independent = no }
			# liege = {
				# reverse_unsafe_war = {
					# casus_belli = nationalist_revolt_wales
					# target = ROOT
				# }
				# save_event_target_as = nationalist_revolt_target_char
			# }
		# }
		# else_if = {
			# limit = { is_tributary = yes }
			# liege = {
				# reverse_unsafe_war = {
					# casus_belli = nationalist_revolt_wales
					# target = ROOT
				# }
			# }
		# }
		# else = {
			# event_target:nationalist_revolt_target_province = {
				# owner = {
					# top_liege = {
						# reverse_unsafe_war = {
							# casus_belli = nationalist_revolt_wales
							# target = ROOT
						# }
					# }
				# }
			# }
		# }
		
		# event_target:nationalist_revolt_target_char = {
			# # Notify revolt
			# character_event = { id = 320722 }
			
			# # Call in marches in the region...
			# any_tributary = {
				# limit = { 
					# is_tributary = { type = march } 
					# any_realm_province = {
						# is_in_current_resistance_region_province = yes
					# }
				# }
				# join_defender_wars = PREV
				# character_event = { id = 320722 }
			# }
			
			# # and your suzerain (if a march), along with any of their marches in the region
			# if = {
				# limit = { is_tributary = { type = march } }
				# suzerain = { 
					# join_defender_wars = PREV
					# character_event = { id = 320722 }
					# any_tributary = {
						# limit = { 
							# is_tributary = { type = march } 
							# any_realm_province = {
								# is_in_current_resistance_region_province = yes
							# }
						# }
						# join_defender_wars = PREVPREV
						# character_event = { id = 320722 }
					# }
				# }
			# }
		# }
		
		# # Call in other vassals, tributaries, and nearby independent rulers of the associated culture
		# any_playable_ruler = {
			# limit = {
				# is_local_resistance_similar_culture_to_ROOT_trigger = yes
				# any_realm_province = {
					# is_in_current_resistance_region_province = yes
				# }
				# OR = {
					# AND = {
						# independent = no
						# #liege = { character = event_target:nationalist_revolt_target_char }
					# }
					# AND = {
						# independent = yes
						# is_tributary = yes
						# suzerain = {
							# OR = {
								# character = event_target:nationalist_revolt_target_char
								# any_tributary = { 
									# character = event_target:nationalist_revolt_target_char
									# is_tributary = { type = march }
								# }
							# }
						# }
					# }
					# AND = {
						# independent = yes
						# is_tributary = no
					# }
				# }
				# NOT = {
					# has_non_aggression_pact_with = event_target:nationalist_revolt_target_char
				# }
			# }
			# character_event = { id = 320723 }
		# }
	# }
# }

# # Notify liege and marches of revolt
# character_event = {
	# id = 320722
	# title = EVTNAME320722
	# desc = EVTDESC320722
	# picture = GFX_evt_peasants
	# border = GFX_event_normal_frame_war
	
	# is_triggered_only = yes
	
	# option = {
		# name = "EVTOPTA320722"
	# }
# }

# # Other lords in the area asked to join revolt
# character_event = {
	# id = 320723
	# title = EVTNAME320723
	# desc = EVTDESC320723
	# picture = GFX_evt_peasants
	# border = GFX_event_normal_frame_war
	
	# is_triggered_only = yes
	
	# immediate = {
		# set_character_flag = got_event_320723
	# }
	
	# option = {
		# name = "EVTOPTA320723"
		# ai_chance = {
			# factor = 100
		# }
		# join_attacker_wars = FROM
	# }
	
	# option = {
		# name = "EVTOPTA320723"
		# ai_chance = {
			# factor = 0
		# }
	# }
# }