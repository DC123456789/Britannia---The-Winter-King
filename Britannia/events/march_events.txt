#########################################################
#
# 	MARCH EVENTS
#
# 	Id 320900 - 320999 reserved	
#
#########################################################

# Creation of the Breton March
narrative_event = {
	id = 320900
	title = "EVTNAME320900"		# TODO Localisation
	desc = "EVTDESC320900"
	major = yes
	hide_new = yes
	
	picture = "GFX_evt_castle_gate"
	
	is_triggered_only = yes
	
	immediate = {
		liege = { save_event_target_as = ROOT_liege }
		if = {
			limit = { liege = { can_create_germanic_title_trigger = yes } }
			d_nantes = { de_jure_liege = k_breton_march }
			d_rennes = { de_jure_liege = k_breton_march }
			d_bretagne = { de_jure_liege = k_breton_march }
			d_penthievre = { de_jure_liege = k_breton_march }
			d_cornouaille = { de_jure_liege = k_breton_march }
			
			if = {
				limit = { 
					has_global_flag = western_roman_empire_fallen
					NOT = { has_global_flag = franks_defeated }
				}
				k_breton_march = { de_jure_liege = e_franks }
			}
			else = {
				k_breton_march = { de_jure_liege = e_gaul }
			}
		}
		# TODO Need event for switching between these two, if relevant
		else = {
			# Alternative de jure if formed by a Romanized Germanic
			
			# TODO Trigger these only when the march takes full control of the duchy?
			# d_namnetia = { de_jure_liege = k_breton_march }
			# d_redonia = { de_jure_liege = k_breton_march }
			# d_broerec = { de_jure_liege = k_breton_march }
			# d_domnonea = { de_jure_liege = k_breton_march }
			# d_finis_terrae = { de_jure_liege = k_breton_march }
			# d_poher = { de_jure_liege = k_breton_march }
			
			if = {
				limit = { liege = { has_landed_title = e_visigoths } }
				# TODO Need to apply this when e_visigoths is formed as well, 
				# and remove it if e_visigoths is destroyed
				k_breton_march = { de_jure_liege = e_visigoths }
			}
			else = {
				k_breton_march = { de_jure_liege = 0 }
			}
		}		
		
		set_global_flag = breton_march_created
		
		grant_title = k_breton_march
		k_breton_march = { set_title_flag = is_march }
		set_defacto_liege = THIS
		event_target:ROOT_liege = {
			make_tributary = { who = ROOT tributary_type = march }
			hidden_tooltip = {
				any_vassal = {
					limit = {
						primary_title = {
							OR = {
								AND = {
									tier = DUKE
									capital_scope = {
										region = custom_breton_march
									}
								}
								AND = {
									tier = COUNT
									location = {
										region = custom_breton_march
									}
								}
							}
						}
					}
					set_defacto_liege = ROOT
				}
			}
		}
	}
	
	option = {
		name = "EVTOPTA320900"
	}
}

# 320901 TODO Creation of the Duchy of Vasconia

# 320902 TODO Creation of the Welsh March

# 320903 TODO Creation of the Pictish March

# 320904 TODO Creation of the Limes Caledonicus

# 320910 TODO Welsh March -> Earldom of Wales

# 320911 TODO Pictish March -> Earldom of Pictland

# AI creation of marches
# TODO Need to add other marches
character_event = {
	id = 320920
	desc = "You're not supposed to see this..."
	
	picture = "GFX_evt_castle_gate"
	
	hide_window = yes
	only_independent = yes
	is_triggered_only = yes
	
	trigger = {
		are_dejure_changes_allowed_trigger = yes
		ai = yes
		is_tribal = no
		higher_tier_than = DUKE
		independent = yes
		OR = {
			AND = {
				NOR = {
					culture_group = imperiale
					culture_group = celtic
				}
				any_realm_province = {
					count = 3
					region = world_gaul_lugdunensis_armorica
				}
				# any_realm_province = {
					# region = custom_breton_march
				# }
				NOT = {
					any_tributary = {
						has_landed_title = k_breton_march
					}
				}
				OR = {
					k_breton_march = { has_holder = no }
					FROM = { has_landed_title = k_breton_march }
				}
			}
		}
	}
	
	immediate = {
		# Breton March
		if = {
			limit = {			
				NOR = {
					culture_group = imperiale
					culture_group = celtic
				}
				any_realm_province = {
					count = 3
					region = world_gaul_lugdunensis_armorica
				}
				# any_realm_province = {
					# region = custom_breton_march
				# }
				NOT = {
					any_tributary = {
						has_landed_title = k_breton_march
					}
				}
				OR = {
					k_breton_march = { has_holder = no }
					FROM = { has_landed_title = k_breton_march }
				}
			}
			any_vassal = {
				limit = {
					higher_tier_than = BARON
					NOR = {
						culture_group = imperiale
						culture_group = celtic
					}
					any_realm_province = {
						#OR = {
							region = custom_breton_march
							#any_neighbor_province = {
								#region = custom_breton_march
							#}
						#}
					}
				}
				score_value = {
					value = 1
					additive_modifier = {
						OR = {
							culture_group = celtic
							culture_group = imperiale
						}
						value = -30
					}
					additive_modifier = {
						NOT = { culture_group = ROOT }
						value = -10
					}
					additive_modifier = {
						NOT = { culture = ROOT }
						value = -10
					}
					additive_modifier = {
						NOT = { religion_group = ROOT }
						value = -10
					}
					additive_modifier = {
						NOT = { religion = ROOT }
						value = -10
					}
					additive_modifier = {
						tier = DUKE
						value = 10
					}
					additive_modifier = {
						realm_size <= 2
						value = -5
					}
					additive_modifier = {
						realm_size >= 10
						value = 5
					}
					additive_modifier = {
						num_of_count_titles <= 1
						value = -5
					}
					additive_modifier = {
						num_of_count_titles > 3
						value = 5
					}
					additive_modifier = {
						dynasty = ROOT
						value = 5
					}
					additive_modifier = {
						is_friend = ROOT
						value = 5
					}
					additive_modifier = {
						is_rival = ROOT
						value = -10
					}
					additive_modifier = {
						value = 5
						reverse_opinion = { 
							who = ROOT
							value >= 25
						}
					}
					additive_modifier = {
						value = 5
						reverse_opinion = { 
							who = ROOT
							value >= 75
						}
					}
					additive_modifier = {
						value = -5
						reverse_opinion = { 
							who = ROOT
							value <= -25
						}
					}
					additive_modifier = {
						value = -5
						reverse_opinion = { 
							who = ROOT
							value <= -75
						}
					}
				}
				count = 1
				character_event = { id = 320900 }
			}
		}
	}
}

# Notification event for granting title to march
diploresponse_event = {
	id = 320925

	is_triggered_only = yes
	major = no
	is_friendly = yes

	trigger = {
		ai = no
	}

	desc = "EVTDESC320925"

	option = {
		name = "OK"
	}
}

# Notification event for transferring vassal to march
diploresponse_event = {
	id = 320926

	is_triggered_only = yes
	major = no
	is_friendly = yes

	trigger = {
		ai = no
	}

	desc = "EVTDESC320926"

	option = {
		name = "OK"
	}
}

diploresponse_event = {
	id = 320927

	is_triggered_only = yes
	major = no
	is_friendly = yes

	trigger = {
		ai = no
	}

	desc = "EVTDESC320927"

	option = {
		name = "OK"
	}
}

# Receive demand to revoke march
letter_event = {
	id = 320930
	desc = "EVTDESC320930"
	picture = "GFX_evt_emissary"
	
	only_rulers = yes
	
	is_triggered_only = yes
	
	option = {			# Accept
		name = "Yes"
		prestige = -50
		reverse_opinion = {
			modifier = opinion_approves
			who = FROMFROM
			years = 10
		}
		FROMFROM = { 
			character_event = { id = 320931 }
		}
		tooltip = {
			FROMFROM = { 
				remove_tributary = ROOT 
			}
			any_demesne_title = {
				limit = {
					has_title_flag = is_march
				}
				show_scope_change = no
				destroy_landed_title = THIS
			}
			set_defacto_liege = FROMFROM
		}
		hidden_tooltip = {
			opinion = {
				modifier = opinion_revoked_my_title
				who = FROMFROM
				years = 20
			}
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				NOT = { has_character_flag = will_give_up_march }
			}
		}
	}
	
	option = {			# Reject
		name = "No"
		# Can't resist if you're a prisoner
		trigger = {
			OR = {
				prisoner = no
				NOT = { host = { character = FROMFROM } }
			}
		}
		prestige = 50
		reverse_opinion = {
			modifier = opinion_furious
			who = FROMFROM
			years = 10
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				has_character_flag = will_give_up_march
			}
		}
		FROMFROM = { character_event = { id = 320932 } }
		war = {
			casus_belli = free_tributary_cb_liege_claim
			target = FROMFROM					
		}
	}
	
	after = {
		clr_character_flag = will_give_up_march
	}
}

# March revokation accepted
diploresponse_event = {
	id = 320931
	desc = "EVTDESC320931"

	is_triggered_only = yes
	major = no
	is_friendly = yes

	trigger = {
		#ai = no
	}

	option = {
		name = "OK"
		FROM = {
			show_scope_change = no
			remove_tributary = FROM
			hidden_tooltip = {
				any_vassal = {
					limit = { defacto_liege_title = { has_title_flag = is_march } }
					set_defacto_liege = ROOT
				}
			}
			any_demesne_title = {
				limit = {
					has_title_flag = is_march
				}
				show_scope_change = no
				destroy_landed_title = THIS
			}
			set_defacto_liege = ROOT
		}
	}
}

# March revokation refused
diploresponse_event = {
	id = 320932
	desc = "EVTDESC320932"

	is_triggered_only = yes
	major = no
	is_hostile = yes

	trigger = {
		ai = no
	}

	option = {
		name = "OK"
	}
}

# Event when march becomes independent
character_event = {
	id = 320935
	title = "EVTNAME320935"
	desc = "EVTDESC320935"
	
	picture = "GFX_evt_castle_gate"
	only_independent = yes
	
	trigger = {
		any_demesne_title = {
			has_title_flag = is_march
			NOT = { has_title_flag = is_independent_march }
		}
		NOR = { 
			is_tributary = { type = march } 
			any_war = {
				defender = {
					character = ROOT
				}
				using_cb = tributary_march_cb
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		any_demesne_title = {
			limit = {
				has_title_flag = is_march
				NOT = { has_title_flag = is_independent_march }
			}
			set_title_flag = is_independent_march
		}
	}
	
	option = {
		name = "EVTOPTA320935"
		custom_tooltip = {
			text = EVTOPTA320935TT
		}
	}
}

# Notification event for former suzerain when march becomes independent
character_event = {		# TODO localisation
	id = 320936
	title = "EVTNAME320936"
	desc = "EVTDESC320936"
	
	picture = "GFX_evt_castle_hill"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA320936"
		custom_tooltip = {
			text = EVTOPTA320936TT
		}
	}
}

# March has been independent for long enough, becomes a proper title
character_event = {		# TODO localisation
	id = 320937
	title = "EVTNAME320937"
	desc = "EVTDESC320937"
	
	picture = "GFX_evt_royal_court"
	only_independent = yes
	
	is_triggered_only = yes
	
	trigger = {
		any_demesne_title = {
			has_title_flag = is_march
			had_title_flag = {
				flag = is_independent_march
				years >= 35
			}
		}
		NOT = { is_tributary = { type = march } }
	}
	
	immediate = {
		clr_title_flag = is_march
		clr_title_flag = is_independent_march
	}
	
	option = {
		name = "EVTOPTA320937"
		custom_tooltip = {
			text = EVTOPTA320937TT
		}
	}
}

# Clear flag from marches that are re-vassalized
character_event = {
	id = 320938
	desc = "You're not supposed to see this..."	
	picture = "GFX_evt_castle_hill"	
	hide_window = yes
	
	only_playable = yes
	
	trigger = {
		any_demesne_title = {
			has_title_flag = is_march
			has_title_flag = is_independent_march
		}
		is_tributary = { type = march }
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		clr_title_flag = is_independent_march
	}
}

# TODO If a march's suzerain gets deposed and is now unlanded or a vassal of the new ruler, the march goes to the new ruler

# TODO If a march's suzerain loses a top-tier title (but still has others):
## Transfer the march to the new ruler if the marcher lord was a supporter in the civil war AND borders the new ruler's territory
## Otherwise, transfer the march to the new ruler if the title that the new ruler usurped that is the nominal "de jure" liege of the march 
### (k_neustria for k_breton_march, k_aquitaine for k_vasconia, k_mercia for k_wales, and k_northumbria for k_pictland)
## Otherwise, transfer the march to the new ruler if the title that the old ruler no longer borders the march's territory, and the new ruler does

# TODO If a march's suzerain is duke-tier or lower (and independent), the march breaks free

# TODO If a march's suzerain is no longer independent, the march is re-assigned to the liege