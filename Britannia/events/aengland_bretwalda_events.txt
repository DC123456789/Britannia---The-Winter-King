########################################
#
# Events for Bretwalda of Aengland
#
# IDs 320200 - 320399
#
########################################


### CYNERICE OF AENGLALAND ###

narrative_event = {		# All Agreed, Gain Cynerice of Aenglaland
	id = 320200
	title = "EVTNAME320200"
	desc = "EVTDESC320200"
	picture = GFX_evt_royal_court
	only_playable = yes
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_character_flag = gained_aengland
		any_title = {
			limit = { has_title_flag = aengland_primary_kingdom }
			clr_title_flag = aengland_primary_kingdom
		}
		primary_title = {
			set_title_flag = aengland_primary_kingdom
			e_aengland = { 
				gain_title = ROOT 
				copy_title_laws = PREV
			}
		}
		clr_character_flag = gained_aengland
	}
	
	option = {
		name = "EVTOPTA320200"		# Gain Cynerice of Aenglaland
		trigger = {
			character = ROOT
		}
		if = {
			limit = { NOT = { has_global_flag = first_bretwalda } }
			create_bloodline = {
				type = aelle_bretwalda
			}
			set_global_flag = first_bretwalda
		}
	}
		
	option = {
		name = "EVTOPTB320200"		# Vassal or Subject King
		trigger = {
			NOT = { character = ROOT }
			OR = {
				top_liege = { character = ROOT }
				is_tributary = {
					type = anglosaxon_tributary 
					suzerain = ROOT 
				}
			}
		}
	}
	
	option = {
		name = "EVTOPTC320200"		# Rival Kings
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = {
					type = anglosaxon_tributary 
					suzerain = ROOT 
				}
			}
			independent = yes
			is_ingvaeonic_culture_trigger = yes
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
				OR = {
					lower_tier_than = DUKE
					title = e_aengland
					empire = { title = e_aengland }
				}
			}
		}
	}
	
	option = {
		name = "EVTOPTD320200"		# Other Rulers
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = {
					type = anglosaxon_tributary 
					suzerain = ROOT 
				}
				AND = {
					independent = yes
					is_ingvaeonic_culture_trigger = yes
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
						OR = {
							lower_tier_than = DUKE
							title = e_aengland
							empire = { title = e_aengland }
						}
					}
				}
			}
		}
	}
}

# Bretwaldaship is lost on death before the Declare Supremacy Decision is taken
narrative_event = {
	id = 320201
	title = EVTNAME320201	
	desc = EVTDESC320201
	picture = GFX_evt_council
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		any_title = {
			limit = { has_title_flag = aengland_primary_kingdom }
			clr_title_flag = aengland_primary_kingdom
		}
		
		any_vassal = {
			limit = { 
				defacto_liege_title = { title = e_aengland }
			}
			set_character_flag = restore_vassalage_@ROOT
		}
		e_aengland = { destroy_landed_title = THIS }
		e_aengland = { remove_claim = ROOT }
		# This ensures that all actual vassals of ROOT are kept when Aengland is destroyed
		any_character = {
			limit = { has_character_flag = restore_vassalage_@ROOT }
			clr_character_flag = restore_vassalage_@ROOT
			set_defacto_liege = THIS
			if = {
				limit = { 
					ROOT = { higher_tier_than = PREV }
				}
				set_defacto_liege = ROOT
			}
			else = {
				ROOT = {
					current_heir = {
						set_defacto_vassal = PREVPREV
					}
				}
			}
		}
		
		ROOT = {
			current_heir = {
				save_event_target_as = bretwalda_heir
			}
		}
		
		# Remove Return of the Saxons event troops			
		character_event = { id = 313157 }
	}
	
	option = {			# Bretwalda (or heir)
		name = "EVTOPTA320201"
		trigger = {
			character = ROOT
		}
		tooltip = {
			e_aengland = { 
				show_scope_change = no
				destroy_landed_title = THIS 
			}
		}
	}
	
	option = {			# Other Anglo-Saxons
		name = "EVTOPTB320201"
		trigger = {
			NOT = { character = ROOT }
			is_ingvaeonic_culture_trigger = yes
			NOT = {
				top_liege = { 
					primary_title = {
						tier = EMPEROR 
						NOT = { title = e_aengland }
					} 
				}
			}
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
			}
		}
	}
	
	option = {			# Britons
		name = "EVTOPTC320201"
		trigger = {
			NOT = { character = ROOT }	
			OR = {
				is_brythonic_culture_trigger = yes
				culture_group = imperiale
			}
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
			}
		}
	}
	
	option = {			# Others
		name = "EVTOPTD320201"
		trigger = {
			NOR = {
				character = ROOT
				AND = {
					is_ingvaeonic_culture_trigger = yes
					NOT = {
						top_liege = { 
							primary_title = {
								tier = EMPEROR 
								NOT = { title = e_aengland }
							} 
						}
					}
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
					}
				}
				AND = {	
					OR = {
						is_brythonic_culture_trigger = yes
						culture_group = imperiale
					}
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
					}
				}
			}
		}
	}
}

# Bretwaldaship is lost if title gets new holder before the Declare Supremacy Decision is taken
narrative_event = {
	id = 320202
	title = EVTNAME320202	
	desc = EVTDESC320202
	picture = GFX_evt_council
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		ROOT = { character_event = { id = 320203 days = 1 } }
		
		any_vassal = {
			limit = { 
				defacto_liege_title = { title = e_aengland }
			}
			set_character_flag = restore_vassalage_@ROOT
		}
		e_aengland = { destroy_landed_title = THIS }
		e_aengland = { remove_claim = ROOT }
		
		# This ensures that all actual vassals of ROOT are kept when Aengland is destroyed
		any_character = {
			limit = { has_character_flag = restore_vassalage_@ROOT }
			clr_character_flag = restore_vassalage_@ROOT
			set_defacto_liege = THIS
			set_defacto_liege = ROOT
		}
	}
	
	option = {			# New Ruler
		name = "EVTOPTA320202"
		trigger = {
			character = ROOT
			NOT = { character = FROMFROMFROM }
		}
		tooltip = {
			e_aengland = { 
				show_scope_change = no
				destroy_landed_title = THIS 
			}
		}
	}
	
	option = {			# Old High King
		name = "EVTOPTB320202"
		trigger = {
			character = FROMFROMFROM
		}
		tooltip = {
			e_aengland = { 
				show_scope_change = no
				destroy_landed_title = THIS 
			}
		}
	}
	
	option = {			# Other Anglo-Saxons
		name = "EVTOPTC320202"
		trigger = {
			NOT = { character = ROOT }
			NOT = { character = FROMFROMFROM }
			is_ingvaeonic_culture_trigger = yes
			NOT = {
				top_liege = { 
					primary_title = {
						tier = EMPEROR 
						NOT = { title = e_aengland }
					} 
				}
			}
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
			}			
		}
	}
	
	option = {			# Britons
		name = "EVTOPTD320202"
		trigger = {
			NOT = { character = ROOT }	
			NOT = { character = FROMFROMFROM }
			OR = {
				is_brythonic_culture_trigger = yes
				culture_group = imperiale
			}
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
			}
		}
	}
	
	option = {			# Others
		name = "EVTOPTE320202"
		trigger = {
			NOR = {
				character = ROOT
				character = FROMFROMFROM
				AND = {
					is_ingvaeonic_culture_trigger = yes
					NOT = {
						top_liege = { 
							primary_title = {
								tier = EMPEROR 
								NOT = { title = e_aengland }
							} 
						}
					}
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
					}
				}
				AND = {	
					OR = {
						is_brythonic_culture_trigger = yes
						culture_group = imperiale
					}
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
					}
				}
			}
		}
	}
}

# Notify new ruler
narrative_event = {
	id = 320203
	title = EVTNAME320202	
	desc = EVTDESC320203
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {			# New Ruler
		name = "EVTOPTA320203"
		tooltip = {
			e_aengland = { 
				show_scope_change = no
				destroy_landed_title = THIS 
			}
		}
	}
}

narrative_event = {		# Cynerice of Aenglaland Lost (Unfit to Rule)
	id = 320204
	title = "EVTNAME320204"
	desc = "EVTDESC320204"
	picture = GFX_evt_council
	only_playable = yes
	major = yes
	
	trigger = {
		is_alternate_start = no
		has_landed_title = e_aengland
		is_unfit_to_rule_aengland_trigger = yes
		had_character_flag = {
			flag = is_unfit_to_rule_aengland
			days = 240
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		clr_character_flag = is_unfit_to_rule_aengland
	}
	
	option = {
		name = "EVTOPTA320204"		# Lose Aengland
		trigger = {
			has_landed_title = e_aengland
		}
		
		hidden_tooltip = {
			# Flag all vassals to be kept after fall of Aengland
			any_vassal = {
				limit = { 
					defacto_liege_title = { title = e_aengland }
				}
				set_character_flag = restore_vassalage_@ROOT
			}
			
			e_aengland = { destroy_landed_title = e_aengland }
			e_aengland = { remove_claim = ROOT }
			
			any_title = {
				limit = { has_title_flag = aengland_primary_kingdom }
				clr_title_flag = aengland_primary_kingdom
			}			
		}
		
		prestige = -100
		
		e_aengland = { destroy_landed_title = e_aengland }
		e_aengland = { remove_claim = ROOT }
		hidden_tooltip = { character_event = { id = 313157 } }
	}
		
	option = {
		name = "EVTOPTB320204"		# Other Anglosaxons
		trigger = {
			NOT = { has_landed_title = e_aengland }
			is_ingvaeonic_culture_trigger = yes
		}
	}
	
	option = {
		name = "EVTOPTB320204"		# Others
		trigger = {
			NOT = { has_landed_title = e_aengland }
			is_ingvaeonic_culture_trigger = no
		}
	}
	
	after = {
		hidden_tooltip = {
			if = {
				limit = { character = ROOT }
				any_character = {
					limit = { has_character_flag = restore_vassalage_@ROOT }
					clr_character_flag = restore_vassalage_@ROOT
					set_defacto_liege = THIS
					set_defacto_liege = ROOT
				}
			}
		}
	}
}

# on_yearly_pulse aengland_hegemony_score counter
character_event = {
	id = 320205
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		OR = {
			holds_anglo_saxon_kingdom_trigger = yes
			check_variable = { 
				which = aengland_hegemony_score
				value = 0.01
			}
		}
	}
	
	immediate = {
		if = {
			limit = { 
				holds_anglo_saxon_kingdom_trigger = yes
				is_tributary = no
				# Check if controls >= 25 provinces and >= 50% of Anglo-Saxon provinces
				check_variable = { 
					which = num_provinces_controlled
					value = 25
				}
				check_variable = { 
					which = fraction_anglo_saxon_provinces_controlled
					value = 0.5
				}
			}
			# Add score based on proportion of Anglo-Saxon provinces controlled
			set_variable = {
				which = score_anglo_saxon_provinces_controlled
				which = fraction_anglo_saxon_provinces_controlled
			}
			multiply_variable = {
				which = score_anglo_saxon_provinces_controlled
				value = 10
			}
			# Bloodline effects
			if = {
				limit = { 
					any_owned_bloodline = {
						has_bloodline_flag = aengland_bretwalda_bloodline
					}
				}
				multiply_variable = {
					which = score_anglo_saxon_provinces_controlled
					value = 1.15
				}
			}
			change_variable = {
				which = aengland_hegemony_score
				which = score_anglo_saxon_provinces_controlled
			}
			# Calculate and add score based on proportion of Britannia controlled
			export_to_variable = {
				which = num_total_provinces_controlled
				value = num_of_count_titles_in_realm
			}
			any_independent_ruler = {
				limit = { 
					NOT = { character = ROOT } 
					is_tributary = {
						suzerain = ROOT 
					}
					NOT = { war_with = ROOT }
				}
				export_to_variable = {
					which = num_total_provinces_controlled
					value = num_of_count_titles_in_realm
				}
				ROOT = {
					change_variable = {
						which = num_total_provinces_controlled
						which = PREV
					}
				}
			}
			set_variable = {
				which = fraction_num_total_provinces_controlled
				which = num_total_provinces_controlled
			}
			divide_variable = {
				which = fraction_num_total_provinces_controlled
				which = global_num_provinces_in_britannia
			}
			set_variable = {
				which = score_num_total_provinces_controlled
				which = fraction_num_total_provinces_controlled
			}
			multiply_variable = {
				which = score_num_total_provinces_controlled
				value = 20
			}
			# Bloodline effects
			if = {
				limit = { 
					any_owned_bloodline = {
						has_bloodline_flag = aengland_bretwalda_bloodline
					}
				}
				multiply_variable = {
					which = score_num_total_provinces_controlled
					value = 1.15
				}
			}
			change_variable = {
				which = aengland_hegemony_score
				which = score_num_total_provinces_controlled
			}
		}
		else = {
			subtract_variable = {
				which = aengland_hegemony_score
				value = 3
			}
		}
		
		# Make sure score is non-negative
		if = {
			limit = {
				NOT = { 
					check_variable = { 
						which = aengland_hegemony_score
						value = 0
					}
				}
			}
			set_variable = { 
				which = aengland_hegemony_score
				value = 0
			}
		}
	}
	
	option = {
		name = "OK"
	}
}

# on_new_holder aengland_hegemony_score initialization
character_event = {
	id = 320206
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		holds_anglo_saxon_kingdom_trigger = yes
		NOT = {
			check_variable = { 
				which = aengland_hegemony_score
				value = 0.01
			}
		}
	}
	
	immediate = {
		set_variable = {
			which = aengland_hegemony_score
			value = 0
		}
	}
	
	option = {
		name = "OK"
	}
}

# on_startup aengland_hegemony_score initialization
character_event = {
	id = 320207
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		holds_anglo_saxon_kingdom_trigger = yes
		NOT = {
			check_variable = { 
				which = aengland_hegemony_score
				value = 0.01
			}
		}
	}
	
	immediate = {
		set_variable = {
			which = aengland_hegemony_score
			value = 0
		}
		
		# Calculate number of provinces in Britannia on startup
		if = {
			limit = {
				NOT = {
					check_variable = { 
						which = global_num_provinces_in_britannia
						value = 0.01
					}
				}
			}
			set_variable = {
				which = global_num_provinces_in_britannia
				value = 0
			}				
			any_province = {
				limit = { region = world_britannia }
				change_variable = {
					which = global_num_provinces_in_britannia
					value = 1
				}
			}
		}
	}
	
	option = {
		name = "OK"
	}
}

# aengland_primary_kingdom flag maintenance
character_event = {	
	id = 320208
	desc = "You're not supposed to see this..."
	picture = GFX_evt_saxon_army
	
	hide_window = yes
	
	trigger = {
		OR = {
			AND = {
				has_landed_title = e_aengland
				NOT = {
					any_demesne_title = {
						has_title_flag = aengland_primary_kingdom
					}
				}
				any_demesne_title = {
					tier = KING
					empire = {
						title = e_aengland
					}
				}
			}
			AND = {
				NOT = { has_landed_title = e_aengland }
				any_demesne_title = {
					has_title_flag = aengland_primary_kingdom
				}
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = { has_landed_title = e_aengland }
			any_title = {
				limit = { has_title_flag = aengland_primary_kingdom }
				clr_title_flag = aengland_primary_kingdom
			}
			capital_scope = {
				# Try to put it in the capital kingdom if held
				if = {
					limit = { kingdom = { holder_scope = { character = ROOT } } }
					kingdom = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_northumbria
						ROOT = { has_landed_title = k_northumbria }
					}
					k_northumbria = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_mercia
						ROOT = { has_landed_title = k_mercia }
					}
					k_mercia = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_wessex
						ROOT = { has_landed_title = k_wessex }
					}
					k_wessex = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_eastanglia
						ROOT = { has_landed_title = k_east_anglia }
					}
					k_east_anglia = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_cantia
						ROOT = { has_landed_title = k_cantia }
					}
					k_cantia = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_essex
						ROOT = { has_landed_title = k_eastseaxe }
					}
					k_eastseaxe = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_sussex
						ROOT = { has_landed_title = k_sussex }
					}
					k_sussex = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						OR = {
							region = custom_eastanglia
							region = custom_essex
						}
						ROOT = { has_landed_title = k_anglia }
					}
					k_anglia = { set_title_flag = aengland_primary_kingdom }
				}
				else = {		# Just pick a random held kingdom title
					random_demesne_title = {
						limit = {
							tier = KING
							empire = {
								title = e_aengland
							}							
						}
						set_title_flag = aengland_primary_kingdom
					}					
				}
			}
		}
		else = {
			any_demesne_title = {
				limit = { has_title_flag = aengland_primary_kingdom }
				clr_title_flag = aengland_primary_kingdom
			}
		}
	}
}

# num_provinces_controlled calculation event initialization
character_event = {
	id = 320209
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_landed_title = d_null
	}
	
	immediate = {
		1 = {
			province_event = { id = 320210 }
		}
	}
	
	option = {
		name = "OK"
	}
}

# num_provinces_controlled calculations 
province_event = {
	id = 320210
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		# Calculate total number of Anglo-Saxon provinces
		set_variable = {
			which = global_num_anglo_saxon_provinces
			value = 0
		}
		any_province = {
			limit = { 
				region = world_britannia 
				owner = { top_liege = { is_ingvaeonic_culture_trigger = yes } }
			}
			change_variable = {
				which = global_num_anglo_saxon_provinces
				value = 1
			}
		}
		any_independent_ruler = {
			limit = {
				is_ingvaeonic_culture_trigger = yes
				OR = {
					holds_anglo_saxon_kingdom_trigger = yes
					has_landed_title = e_aengland
				}
			}
			# Calculate number of Anglo-Saxon provinces controlled (with and without revolters)
			export_to_variable = {
				which = num_provinces_controlled
				value = num_of_count_titles_in_realm
			}
			export_to_variable = {
				which = num_provinces_controlled_including_revolters
				value = num_of_count_titles_in_realm
			}
			save_event_target_as = current_king
			any_independent_ruler = {
				limit = { 
					NOT = { character = PREV } 
					is_tributary = {
						type = anglosaxon_tributary 
						suzerain = PREV 
					}
				}
				export_to_variable = {
					which = num_provinces_controlled
					value = num_of_count_titles_in_realm
				}
				if = {
					limit = { NOT = { war_with = PREV } }
					event_target:current_king = {
						change_variable = {
							which = num_provinces_controlled
							which = PREV
						}
					}
				}
				event_target:current_king = {
					change_variable = {
						which = num_provinces_controlled_including_revolters
						which = PREV
					}
				}
				any_current_enemy = {
					limit = {
						in_revolt = yes
						liege_before_war = { character = PREVPREV }
					}
					export_to_variable = {
						which = num_provinces_controlled
						value = num_of_count_titles_in_realm
					}
					event_target:current_king = {
						change_variable = {
							which = num_provinces_controlled_including_revolters
							which = PREV
						}
					}
				}
			}
			set_variable = {
				which = fraction_anglo_saxon_provinces_controlled
				which = num_provinces_controlled
			}
			set_variable = {
				which = fraction_anglo_saxon_provinces_controlled_including_revolters
				which = num_provinces_controlled_including_revolters
			}
			divide_variable = {
				which = fraction_anglo_saxon_provinces_controlled
				which = global_num_anglo_saxon_provinces
			}
			divide_variable = {
				which = fraction_anglo_saxon_provinces_controlled_including_revolters
				which = global_num_anglo_saxon_provinces
			}
		}	
		province_event = { id = 320210 days = 10 }	# Loop this forever
	}
	
	option = {
		name = "OK"
	}
}