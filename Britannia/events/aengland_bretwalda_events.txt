########################################
#
# Events for Bretwalda of Aengland
#
# IDs 320200 - 320399
#
########################################


### CYNERICE OF AENGLALAND ###

narrative_event = {		# All Agreed, Gain Cynerice of Aenglaland
	id = 320200
	title = "EVTNAME320200"
	desc = "EVTDESC320200"
	picture = GFX_evt_royal_court
	only_playable = yes
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_character_flag = gained_aengland
		any_title = {
			limit = { has_title_flag = aengland_primary_kingdom }
			clr_title_flag = aengland_primary_kingdom
		}
		primary_title = {
			set_title_flag = aengland_primary_kingdom
			e_aengland = { 
				gain_title = ROOT 
				copy_title_laws = PREV
			}
			capital_scope = {
				e_aengland = {
					set_preferred_capital = PREV
				}
			}
		}
		set_variable = {
			which = aengland_bretwalda_authority
			value = 0
		}
		set_variable = {
			which = aengland_bretwalda_authority_2
			which = aengland_bretwalda_authority
		}
		clr_character_flag = gained_aengland
	}
	
	option = {
		name = "EVTOPTA320200"		# Gain Cynerice of Aenglaland
		trigger = {
			character = ROOT
		}
		if = {
			limit = { NOT = { has_global_flag = first_bretwalda } }
			create_bloodline = {
				type = aelle_bretwalda
			}
			set_global_flag = first_bretwalda
		}
	}
	
	option = {
		name = "EVTOPTB320200"		# Vassal or Subject King
		trigger = {
			NOT = { character = ROOT }
			OR = {
				top_liege = { character = ROOT }
				is_tributary = {
					type = anglosaxon_tributary 
					suzerain = ROOT 
				}
			}
		}
	}
	
	option = {
		name = "EVTOPTC320200"		# Rival Kings
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = {
					type = anglosaxon_tributary 
					suzerain = ROOT 
				}
			}
			independent = yes
			is_ingvaeonic_culture_trigger = yes
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
				OR = {
					lower_tier_than = DUKE
					title = e_aengland
					empire = { title = e_aengland }
				}
			}
		}
	}
	
	option = {
		name = "EVTOPTD320200"		# Other Rulers
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = {
					type = anglosaxon_tributary 
					suzerain = ROOT 
				}
				AND = {
					independent = yes
					is_ingvaeonic_culture_trigger = yes
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
						OR = {
							lower_tier_than = DUKE
							title = e_aengland
							empire = { title = e_aengland }
						}
					}
				}
			}
		}
	}
}

# Bretwaldaship is lost on death before the Declare Supremacy Decision is taken
narrative_event = {
	id = 320201
	title = EVTNAME320201	
	desc = EVTDESC320201
	picture = GFX_evt_council
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		any_title = {
			limit = { has_title_flag = aengland_primary_kingdom }
			clr_title_flag = aengland_primary_kingdom
		}
		
		any_vassal = {
			limit = { 
				defacto_liege_title = { title = e_aengland }
			}
			set_character_flag = restore_vassalage_@ROOT
		}
		e_aengland = { destroy_landed_title = THIS }
		e_aengland = { remove_claim = ROOT }
		# This ensures that all actual vassals of ROOT are kept when Aengland is destroyed
		any_character = {
			limit = { has_character_flag = restore_vassalage_@ROOT }
			clr_character_flag = restore_vassalage_@ROOT
			set_defacto_liege = THIS
			if = {
				limit = { 
					ROOT = { higher_tier_than = PREV }
				}
				set_defacto_liege = ROOT
			}
			else = {
				ROOT = {
					current_heir = {
						set_defacto_vassal = PREVPREV
					}
				}
			}
		}
		
		ROOT = {
			current_heir = {
				save_event_target_as = bretwalda_heir
			}
		}
		
		# Remove Return of the Saxons event troops			
		character_event = { id = 313157 }
	}
	
	option = {			# Bretwalda (or heir)
		name = "EVTOPTA320201"
		trigger = {
			character = ROOT
		}
		tooltip = {
			e_aengland = { 
				show_scope_change = no
				destroy_landed_title = THIS 
			}
		}
	}
	
	option = {			# Other Anglo-Saxons
		name = "EVTOPTB320201"
		trigger = {
			NOT = { character = ROOT }
			is_ingvaeonic_culture_trigger = yes
			NOT = {
				top_liege = { 
					primary_title = {
						tier = EMPEROR 
						NOT = { title = e_aengland }
					} 
				}
			}
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
			}
		}
	}
	
	option = {			# Britons
		name = "EVTOPTC320201"
		trigger = {
			NOT = { character = ROOT }	
			OR = {
				is_brythonic_culture_trigger = yes
				culture_group = imperiale
			}
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
			}
		}
	}
	
	option = {			# Others
		name = "EVTOPTD320201"
		trigger = {
			NOR = {
				character = ROOT
				AND = {
					is_ingvaeonic_culture_trigger = yes
					NOT = {
						top_liege = { 
							primary_title = {
								tier = EMPEROR 
								NOT = { title = e_aengland }
							} 
						}
					}
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
					}
				}
				AND = {	
					OR = {
						is_brythonic_culture_trigger = yes
						culture_group = imperiale
					}
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
					}
				}
			}
		}
	}
}

# Bretwaldaship is lost if title gets new holder before the Declare Supremacy Decision is taken
narrative_event = {
	id = 320202
	title = EVTNAME320202	
	desc = EVTDESC320202
	picture = GFX_evt_council
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		ROOT = { character_event = { id = 320203 days = 1 } }
		
		any_vassal = {
			limit = { 
				defacto_liege_title = { title = e_aengland }
			}
			set_character_flag = restore_vassalage_@ROOT
		}
		e_aengland = { destroy_landed_title = THIS }
		e_aengland = { remove_claim = ROOT }
		
		# This ensures that all actual vassals of ROOT are kept when Aengland is destroyed
		any_character = {
			limit = { has_character_flag = restore_vassalage_@ROOT }
			clr_character_flag = restore_vassalage_@ROOT
			set_defacto_liege = THIS
			set_defacto_liege = ROOT
		}
	}
	
	option = {			# New Ruler
		name = "EVTOPTA320202"
		trigger = {
			character = ROOT
			NOT = { character = FROMFROMFROM }
		}
		tooltip = {
			e_aengland = { 
				show_scope_change = no
				destroy_landed_title = THIS 
			}
		}
	}
	
	option = {			# Old High King
		name = "EVTOPTB320202"
		trigger = {
			character = FROMFROMFROM
		}
		tooltip = {
			e_aengland = { 
				show_scope_change = no
				destroy_landed_title = THIS 
			}
		}
	}
	
	option = {			# Other Anglo-Saxons
		name = "EVTOPTC320202"
		trigger = {
			NOT = { character = ROOT }
			NOT = { character = FROMFROMFROM }
			is_ingvaeonic_culture_trigger = yes
			NOT = {
				top_liege = { 
					primary_title = {
						tier = EMPEROR 
						NOT = { title = e_aengland }
					} 
				}
			}
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
			}			
		}
	}
	
	option = {			# Britons
		name = "EVTOPTD320202"
		trigger = {
			NOT = { character = ROOT }	
			NOT = { character = FROMFROMFROM }
			OR = {
				is_brythonic_culture_trigger = yes
				culture_group = imperiale
			}
			primary_title = {
				capital_scope = {
					region = world_britannia
				}
			}
		}
	}
	
	option = {			# Others
		name = "EVTOPTE320202"
		trigger = {
			NOR = {
				character = ROOT
				character = FROMFROMFROM
				AND = {
					is_ingvaeonic_culture_trigger = yes
					NOT = {
						top_liege = { 
							primary_title = {
								tier = EMPEROR 
								NOT = { title = e_aengland }
							} 
						}
					}
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
					}
				}
				AND = {	
					OR = {
						is_brythonic_culture_trigger = yes
						culture_group = imperiale
					}
					primary_title = {
						capital_scope = {
							region = world_britannia
						}
					}
				}
			}
		}
	}
}

# Notify new ruler
narrative_event = {
	id = 320203
	title = EVTNAME320202	
	desc = EVTDESC320203
	picture = GFX_evt_council
	
	is_triggered_only = yes
	
	option = {			# New Ruler
		name = "EVTOPTA320203"
		tooltip = {
			e_aengland = { 
				show_scope_change = no
				destroy_landed_title = THIS 
			}
		}
	}
}

narrative_event = {		# Cynerice of Aenglaland Lost (Unfit to Rule)
	id = 320204
	title = "EVTNAME320204"
	desc = "EVTDESC320204"
	picture = GFX_evt_council
	only_playable = yes
	major = yes
	
	trigger = {
		is_alternate_start = no
		has_landed_title = e_aengland
		OR = {
			AND = {
				had_character_flag = {
					flag = is_unfit_to_rule_aengland
					days = 240
				}
				is_unfit_to_rule_aengland_trigger = yes
			}
			has_character_flag = bretwalda_is_subject_kingdom
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		clr_character_flag = is_unfit_to_rule_aengland
		clr_global_flag = aengland_declared_supremacy
		clr_character_flag = bretwalda_is_subject_kingdom
	}
	
	option = {
		name = "EVTOPTA320204"		# Lose Aengland
		trigger = {
			has_landed_title = e_aengland
		}
		
		hidden_tooltip = {
			# Flag all vassals to be kept after fall of Aengland
			any_vassal = {
				limit = { 
					defacto_liege_title = { title = e_aengland }
				}
				set_character_flag = restore_vassalage_@ROOT
			}
			
			e_aengland = { destroy_landed_title = e_aengland }
			e_aengland = { remove_claim = ROOT }
			
			any_title = {
				limit = { has_title_flag = aengland_primary_kingdom }
				clr_title_flag = aengland_primary_kingdom
			}			
			
			set_variable = {
				which = aengland_hegemony_score
				value = 100			# A little bit below the threshold - easy to get back
			}
		}
		
		prestige = -100
		
		e_aengland = { destroy_landed_title = e_aengland }
		e_aengland = { remove_claim = ROOT }
		hidden_tooltip = { character_event = { id = 313157 } }
	}
		
	option = {
		name = "EVTOPTB320204"		# Other Anglosaxons
		trigger = {
			NOT = { has_landed_title = e_aengland }
			is_ingvaeonic_culture_trigger = yes
		}
	}
	
	option = {
		name = "EVTOPTB320204"		# Others
		trigger = {
			NOT = { has_landed_title = e_aengland }
			is_ingvaeonic_culture_trigger = no
		}
	}
	
	after = {
		hidden_tooltip = {
			if = {
				limit = { character = ROOT }
				any_character = {
					limit = { has_character_flag = restore_vassalage_@ROOT }
					clr_character_flag = restore_vassalage_@ROOT
					set_defacto_liege = THIS
					set_defacto_liege = ROOT
				}
			}
		}
	}
}

# on_yearly_pulse aengland_hegemony_score and aengland_bretwalda_authority counter
character_event = {
	id = 320205
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		OR = {
			holds_anglo_saxon_kingdom_trigger = yes
			has_landed_title = e_aengland
			check_variable = { 
				which = aengland_hegemony_score
				value = 0.001
			}
			check_variable = { 
				which = aengland_bretwalda_authority
				value = 0.01
			}
		}
		NOT = { has_global_flag = aengland_united }
	}
	
	immediate = {
		# Hegemony Score Calculation
		if = {
			limit = {
				OR = {
					holds_anglo_saxon_kingdom_trigger = yes
					has_landed_title = e_aengland
				}
				independent = yes
				is_tributary = no
				# Check if controls >= 25 provinces and >= 50% of Anglo-Saxon provinces
				check_variable = { 
					which = num_provinces_controlled
					value = 25
				}
				check_variable = { 
					which = fraction_anglo_saxon_provinces_controlled
					value = 0.5
				}
			}
			change_variable = {
				which = aengland_hegemony_score
				which = aengland_hegemony_score_gain
			}
		}
		else = {
			subtract_variable = {
				which = aengland_hegemony_score
				value = 6
			}
		}
		
		# Bretwalda Authority Change
		if = {
			limit = {
				has_landed_title = e_aengland
			}
			change_variable = {
				which = aengland_bretwalda_authority
				which = aengland_bretwalda_authority_gain
			}
			
			set_variable = {
				which = aengland_bretwalda_authority_2
				which = aengland_bretwalda_authority
			}
			
			# Cap Bretwalda Authority at 1200 if not completely controlling Aengland
			if = {
				limit = { 
					check_variable = { 
						which = aengland_bretwalda_authority
						value = 1200
					}					
					NOT = { has_character_flag = completely_controls_aengland }
				}
				set_variable = {
					which = aengland_bretwalda_authority
					value = 1200
				}
			}
		}
		
		# Make sure score is non-negative
		if = {
			limit = {
				NOT = { 
					check_variable = { 
						which = aengland_hegemony_score
						value = 0
					}
				}
			}
			set_variable = { 
				which = aengland_hegemony_score
				value = 0
			}
		}
		if = {
			limit = {
				NOT = { 
					check_variable = { 
						which = aengland_bretwalda_authority
						value = 0
					}
				}
			}
			set_variable = { 
				which = aengland_bretwalda_authority
				value = 0
			}
			set_variable = {
				which = aengland_bretwalda_authority_2
				which = aengland_bretwalda_authority
			}
		}
	}
	
	option = {
		name = "OK"
	}
}

# on_new_holder aengland_hegemony_score and aengland_bretwalda_authority initialization (called on_startup and on_new_holder_*)
character_event = {
	id = 320206
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				holds_anglo_saxon_kingdom_trigger = yes
				NOT = {
					check_variable = { 
						which = aengland_hegemony_score
						value = 0.001
					}
				}
			}			
			set_variable = {
				which = aengland_hegemony_score
				value = 0
			}
		}
		
		if = {
			limit = {
				has_landed_title = e_aengland
				NOT = {
					check_variable = { 
						which = aengland_bretwalda_authority
						value = 0.001
					}
				}
			}			
			set_variable = {
				which = aengland_bretwalda_authority
				value = 0
			}
			set_variable = {
				which = aengland_bretwalda_authority_2
				which = aengland_bretwalda_authority
			}
		}
		
		# Start variable calculation loop
		if = {
			limit = {
				OR = {
					holds_anglo_saxon_kingdom_trigger = yes
					has_landed_title = e_aengland
					AND = {
						has_global_flag = aengland_declared_supremacy
						is_tributary = {
							type = anglosaxon_tributary
						}
						suzerain = { has_landed_title = e_aengland }
					}
				}
			}
			1 = { province_event = { id = 320210 } }
		}
	}
	
	option = {
		name = "OK"
	}
}

# on_death aengland_bretwalda_authority inheritance
character_event = {
	id = 320207
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		check_variable = { 
			which = aengland_bretwalda_authority
			value = 0.001
		}
	}
	
	immediate = {
		# Any child inherits their parent's score
		any_child_even_if_dead = {
			if = {
				limit = { is_alive = no }
				# Go to grandchildren if child is dead
				any_child = {
					if = {
						limit = { NOT = { has_character_flag = inherited_high_aengland_bretwalda_authority_@ROOT } }
						set_character_flag = inherited_high_aengland_bretwalda_authority_@ROOT
						change_variable = {
							which = aengland_bretwalda_authority
							which = ROOT
						}
						set_variable = {
							which = aengland_bretwalda_authority_2
							which = aengland_bretwalda_authority
						}
					}
				}
			}
			else = {
				if = {
					limit = { NOT = { has_character_flag = inherited_high_aengland_bretwalda_authority_@ROOT } }
					set_character_flag = inherited_high_aengland_bretwalda_authority_@ROOT
					change_variable = {
						which = aengland_bretwalda_authority
						which = ROOT
					}
					set_variable = {
						which = aengland_bretwalda_authority_2
						which = aengland_bretwalda_authority
					}
				}
			}
		}
		# An heir to any of your titles also inherits your score, even if not your child
		any_demesne_title = {
			current_heir = {
				if = {
					limit = { NOT = { has_character_flag = inherited_high_aengland_bretwalda_authority_@ROOT } }
					set_character_flag = inherited_high_aengland_bretwalda_authority_@ROOT
					change_variable = {
						which = aengland_bretwalda_authority
						which = ROOT
					}
					set_variable = {
						which = aengland_bretwalda_authority_2
						which = aengland_bretwalda_authority
					}
				}				
			}
		}
	}
	
	option = {
		name = "OK"
	}
}

# aengland_primary_kingdom flag maintenance
character_event = {	
	id = 320208
	desc = "You're not supposed to see this..."
	picture = GFX_evt_saxon_army
	
	hide_window = yes
	
	trigger = {
		OR = {
			AND = {
				has_landed_title = e_aengland
				NOT = {
					any_demesne_title = {
						has_title_flag = aengland_primary_kingdom
					}
				}
				any_demesne_title = {
					tier = KING
					empire = {
						title = e_aengland
					}
				}
			}
			AND = {
				NOT = { has_landed_title = e_aengland }
				any_demesne_title = {
					has_title_flag = aengland_primary_kingdom
				}
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = { has_landed_title = e_aengland }
			any_title = {
				limit = { has_title_flag = aengland_primary_kingdom }
				clr_title_flag = aengland_primary_kingdom
			}
			capital_scope = {
				# Try to put it in the capital kingdom if held
				if = {
					limit = { kingdom = { holder_scope = { character = ROOT } } }
					kingdom = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_northumbria
						ROOT = { has_landed_title = k_northumbria }
					}
					k_northumbria = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_mercia
						ROOT = { has_landed_title = k_mercia }
					}
					k_mercia = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_wessex
						ROOT = { has_landed_title = k_wessex }
					}
					k_wessex = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_eastanglia
						ROOT = { has_landed_title = k_east_anglia }
					}
					k_east_anglia = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_cantia
						ROOT = { has_landed_title = k_cantia }
					}
					k_cantia = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_essex
						ROOT = { has_landed_title = k_eastseaxe }
					}
					k_eastseaxe = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						region = custom_sussex
						ROOT = { has_landed_title = k_sussex }
					}
					k_sussex = { set_title_flag = aengland_primary_kingdom }
				}
				else_if = {
					limit = {
						OR = {
							region = custom_eastanglia
							region = custom_essex
						}
						ROOT = { has_landed_title = k_anglia }
					}
					k_anglia = { set_title_flag = aengland_primary_kingdom }
				}
				else = {		# Just pick a random held kingdom title
					ROOT = {
						random_demesne_title = {
							limit = {
								tier = KING
								empire = {
									title = e_aengland
								}							
							}
							set_title_flag = aengland_primary_kingdom
						}
					}
				}
			}
		}
		else = {
			any_demesne_title = {
				limit = { has_title_flag = aengland_primary_kingdom }
				clr_title_flag = aengland_primary_kingdom
			}
		}
	}
}

# num_provinces_controlled calculation event initialization
character_event = {
	id = 320209
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		has_landed_title = d_null
	}
	
	immediate = {
		1 = {
			province_event = { id = 320210 }
		}
		
		any_playable_ruler = {
			limit = {
				OR = {
					holds_anglo_saxon_kingdom_trigger = yes
					has_landed_title = e_aengland
				}
			}
			if = {
				limit = {
					holds_anglo_saxon_kingdom_trigger = yes
					NOT = {
						check_variable = { 
							which = aengland_hegemony_score
							value = 0.001
						}
					}
				}			
				set_variable = {
					which = aengland_hegemony_score
					value = 0
				}
			}
			
			if = {
				limit = {
					has_landed_title = e_aengland
					NOT = {
						check_variable = { 
							which = aengland_bretwalda_authority
							value = 0.001
						}
					}
				}
				set_variable = {
					which = aengland_bretwalda_authority
					value = 0
				}
				set_variable = {
					which = aengland_bretwalda_authority_2
					which = aengland_bretwalda_authority
				}
			}
		}
		
		# Calculate number of provinces in Britannia on startup
		set_variable = {
			which = global_num_provinces_in_britannia
			value = 0
		}				
		any_province = {
			limit = { region = world_britannia }
			change_variable = {
				which = global_num_provinces_in_britannia
				value = 1
			}
		}
	}
	
	option = {
		name = "OK"
	}
}

# global_num_anglo_saxon_provinces num_provinces_controlled calculations (global)
province_event = {
	id = 320210
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		# Calculate total number of Anglo-Saxon provinces
		set_variable = {
			which = global_num_anglo_saxon_provinces
			value = 0
		}
		any_independent_ruler = {
			limit = { 
				OR = {
					has_landed_title = e_aengland
					is_ingvaeonic_culture_trigger = yes 
				}
			}
			any_realm_province = {
				limit = { region = world_britannia }
				change_variable = {
					which = global_num_anglo_saxon_provinces
					value = 1
				}
			}
			any_current_enemy = {
				limit = {
					in_revolt = yes
					liege_before_war = { character = PREVPREV }
				}
				any_realm_province = {
					limit = { region = world_britannia }
					change_variable = {
						which = global_num_anglo_saxon_provinces
						value = 1
					}
				}
			}
		}
		
		# Recalculate variables for all Anglo-Saxon kings
		any_independent_ruler = {
			character_event = { id = 320211 }
		}

		clear_delayed_event = { id = 320210 }
		province_event = { id = 320210 days = 10 }	# Loop this forever
	}
	
	option = {
		name = "OK"
	}
}

# num_provinces_controlled calculations (per Anglo-Saxon king)
character_event = {
	id = 320211
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		OR = {
			is_ingvaeonic_culture_trigger = yes
			has_landed_title = e_aengland
		}
		OR = {
			holds_anglo_saxon_kingdom_trigger = yes
			has_landed_title = e_aengland
			AND = {
				has_global_flag = aengland_declared_supremacy
				is_tributary = {
					type = anglosaxon_tributary
				}
				suzerain = { has_landed_title = e_aengland }
			}
		}
	}
	
	immediate = {		
		# Calculate number of Anglo-Saxon provinces controlled (with and without revolters)
		set_variable = {
			which = num_provinces_controlled
			value = 0
		}
		any_realm_province = {
			limit = { region = world_britannia }
			PREV = {
				change_variable = {
					which = num_provinces_controlled
					value = 1
				}
			}
		}
		set_variable = {
			which = num_total_provinces_controlled
			which = num_provinces_controlled
		}
		set_variable = {
			which = num_provinces_controlled_including_revolters
			which = num_provinces_controlled
		}
		any_independent_ruler = {
			limit = { 
				NOT = { character = ROOT } 
				is_tributary = { 
					suzerain = ROOT 
				}
			}
			set_variable = {
				which = num_provinces_controlled
				value = 0
			}
			any_realm_province = {
				limit = { region = world_britannia }
				PREV = {
					change_variable = {
						which = num_provinces_controlled
						value = 1
					}
				}
			}
			if = {
				limit = { NOT = { war_with = PREV } }
				set_variable = {
					which = num_total_provinces_controlled
					which = num_provinces_controlled
				}
				ROOT = {
					change_variable = {
						which = num_total_provinces_controlled
						which = PREV
					}
				}
			}
			if = {
				limit = {
					is_tributary = {
						type = anglosaxon_tributary 
						suzerain = ROOT 
					}
				}
				if = {
					limit = { NOT = { war_with = PREV } }
					ROOT = {
						change_variable = {
							which = num_provinces_controlled
							which = PREV
						}
					}
				}
				set_variable = {
					which = num_provinces_controlled_including_revolters
					which = num_provinces_controlled
				}
				ROOT = {
					change_variable = {
						which = num_provinces_controlled_including_revolters
						which = PREV
					}
				}
				any_current_enemy = {
					limit = {
						in_revolt = yes
						liege_before_war = { character = PREVPREV }
					}
					set_variable = {
						which = num_provinces_controlled_including_revolters
						value = 0
					}
					any_realm_province = {
						limit = { region = world_britannia }
						PREV = {
							change_variable = {
								which = num_provinces_controlled_including_revolters
								value = 1
							}
						}
					}
					ROOT = {
						change_variable = {
							which = num_provinces_controlled_including_revolters
							which = PREV
						}
					}
				}
			}
		}
		set_variable = {
			which = fraction_anglo_saxon_provinces_controlled
			which = num_provinces_controlled
		}
		set_variable = {
			which = fraction_anglo_saxon_provinces_controlled_including_revolters
			which = num_provinces_controlled_including_revolters
		}
		divide_variable = {
			which = fraction_anglo_saxon_provinces_controlled
			which = global_num_anglo_saxon_provinces
		}
		divide_variable = {
			which = fraction_anglo_saxon_provinces_controlled_including_revolters
			which = global_num_anglo_saxon_provinces
		}
		set_variable = {
			which = fraction_num_total_provinces_controlled
			which = num_total_provinces_controlled
		}
		divide_variable = {
			which = fraction_num_total_provinces_controlled
			which = global_num_provinces_in_britannia
		}
		
		# Calculate score from proportion of Anglo-Saxon provinces controlled
		set_variable = {
			which = score_anglo_saxon_provinces_controlled
			which = fraction_anglo_saxon_provinces_controlled
		}
		set_variable = {
			which = authority_anglo_saxon_provinces_controlled
			which = fraction_anglo_saxon_provinces_controlled
		}
		set_variable = {
			which = percent_anglo_saxon_provinces_controlled
			which = fraction_anglo_saxon_provinces_controlled
		}
		multiply_variable = {
			which = score_anglo_saxon_provinces_controlled
			value = 10
		}
		multiply_variable = {
			which = percent_anglo_saxon_provinces_controlled
			value = 100
		}
		subtract_variable = {
			which = authority_anglo_saxon_provinces_controlled
			value = 0.5
		}
		multiply_variable = {
			which = authority_anglo_saxon_provinces_controlled
			value = 10
		}
		
		# Calculate score from proportion of Britannia controlled
		set_variable = {
			which = score_num_total_provinces_controlled
			which = fraction_num_total_provinces_controlled
		}
		set_variable = {
			which = authority_num_total_provinces_controlled
			which = fraction_num_total_provinces_controlled
		}
		set_variable = {
			which = percent_num_total_provinces_controlled
			which = fraction_num_total_provinces_controlled
		}
		multiply_variable = {
			which = score_num_total_provinces_controlled
			value = 20
		}
		multiply_variable = {
			which = percent_num_total_provinces_controlled
			value = 100
		}
		subtract_variable = {
			which = authority_num_total_provinces_controlled
			value = 0.25
		}
		multiply_variable = {
			which = authority_num_total_provinces_controlled
			value = 20
		}
		
		# Calculate stat effects
		export_to_variable = {
			which = bretwalda_diplomacy_effect
			value = diplomacy
		}
		export_to_variable = {
			which = bretwalda_martial_effect
			value = martial
		}
		export_to_variable = {
			which = bretwalda_stewardship_effect
			value = stewardship
		}
		subtract_variable = {
			which = bretwalda_diplomacy_effect
			value = 9
		}
		subtract_variable = {
			which = bretwalda_martial_effect
			value = 9
		}
		subtract_variable = {
			which = bretwalda_stewardship_effect
			value = 9
		}
		multiply_variable = {
			which = bretwalda_diplomacy_effect
			value = 1.5
		}
		multiply_variable = {
			which = bretwalda_martial_effect
			value = 1.5
		}
		multiply_variable = {
			which = bretwalda_stewardship_effect
			value = 1.5
		}
		
		
		# Calculate total Aengland Hegemony Score
		set_variable = {
			which = aengland_hegemony_score_gain
			which = score_anglo_saxon_provinces_controlled
		}
		change_variable = {
			which = aengland_hegemony_score_gain
			which = score_num_total_provinces_controlled
		}
		if = {		# Bloodline effects
			limit = { 
				any_owned_bloodline = {
					has_bloodline_flag = aengland_bretwalda_bloodline
				}
			}
			multiply_variable = {
				which = aengland_hegemony_score_gain
				value = 1.15
			}
		}
		if = {		# Culture effects
			limit = { 
				is_ingvaeonic_culture_trigger = no
			}
			multiply_variable = {
				which = aengland_hegemony_score_gain
				value = 0.50
			}
		}
		if = {		# Culture group effects
			limit = { 
				NOT = { culture_group = germanic }
			}
			multiply_variable = {
				which = aengland_hegemony_score_gain
				value = 0.50
			}
		}
		
		# Calculate total Bretwalda Authority
		if = {
			limit = {
				NAND = {
					has_global_flag = aengland_declared_supremacy
					is_tributary = {
						type = anglosaxon_tributary
					}
					suzerain = { has_landed_title = e_aengland }
				}
			}
			# Base increase
			set_variable = {
				which = aengland_bretwalda_authority_gain
				which = authority_anglo_saxon_provinces_controlled
			}
			change_variable = {
				which = aengland_bretwalda_authority_gain
				which = authority_num_total_provinces_controlled
			}
			if = {
				limit = { completely_controls_region = custom_aengland }
				change_variable = {
					which = aengland_bretwalda_authority_gain
					value = 20
				}
				set_character_flag = completely_controls_aengland
			}
			else_if = {
				limit = { has_character_flag = completely_controls_aengland }
				clr_character_flag = completely_controls_aengland
			}
			
			# Multiplers
			set_variable = {
				which = aengland_bretwalda_authority_multiplier
				value = 100
			}
			change_variable = {
				which = aengland_bretwalda_authority_multiplier
				which = bretwalda_diplomacy_effect
			}
			change_variable = {
				which = aengland_bretwalda_authority_multiplier
				which = bretwalda_martial_effect
			}
			change_variable = {
				which = aengland_bretwalda_authority_multiplier
				which = bretwalda_stewardship_effect
			}
			if = {		# Government effects
				limit = { 
					is_tribal = yes
				}
				subtract_variable = {
					which = aengland_bretwalda_authority_multiplier
					value = 33
				}
			}
			if = {		# Bloodline effects
				limit = { 
					any_owned_bloodline = {
						has_bloodline_flag = aengland_bretwalda_bloodline
					}
				}
				change_variable = {
					which = aengland_bretwalda_authority_multiplier
					value = 15
				}
			}
			multiply_variable = {
				which = aengland_bretwalda_authority_multiplier
				value = 0.01
			}
			multiply_variable = {
				which = aengland_bretwalda_authority_gain
				which = aengland_bretwalda_authority_multiplier
			}
			
			if = {		# Culture effects
				limit = { 
					is_ingvaeonic_culture_trigger = no
				}
				multiply_variable = {
					which = aengland_bretwalda_authority_gain
					value = 0.50
				}
			}
			if = {		# Culture group effects
				limit = { 
					NOT = { culture_group = germanic }
				}
				multiply_variable = {
					which = aengland_bretwalda_authority_gain
					value = 0.50
				}
			}
			
			# No gain if controls < 75% of Anglo-Saxon provinces or < 70 provinces in total
			if = {
				limit = {
					OR = {
						NOT = {
							check_variable = { 
								which = fraction_anglo_saxon_provinces_controlled
								value = 0.75
							}
						}
						NOT = {
							check_variable = { 
								which = num_provinces_controlled
								value = 70
							}
						}
					}
				}
				set_variable = {
					which = aengland_bretwalda_authority_gain
					value = 0
				}
			}
			
			# Lose Authority if doesn't control at 60% of all Anglo-Saxon provinces
			# Gain = 2 * (%Controlled - 60), capped at 80
			if = {
				limit = {
					NOT = {
						check_variable = { 
							which = fraction_anglo_saxon_provinces_controlled
							value = 0.60
						}
					}
				}
				set_variable = {
					which = aengland_bretwalda_authority_gain
					which = percent_anglo_saxon_provinces_controlled
				}
				subtract_variable = {
					which = aengland_bretwalda_authority_gain
					value = 60
				}
				multiply_variable = {
					which = aengland_bretwalda_authority_gain
					value = 2
				}
			}
			
			# Enforce max loss of 80 per year - happens automatically if tributary
			if = {
				limit = {
					OR = {
						NOT = {
							check_variable = { 
								which = aengland_bretwalda_authority_gain
								value = -80
							}
						}
						is_tributary = yes
					}
				}
				set_variable = { 
					which = aengland_bretwalda_authority_gain
					value = -80
				}
			}
		}
		else = {
			# Calculate annexation score
			set_variable = {
				which = aengland_bretwalda_authority		# We use this because it's possible to compare same variable in different scopes
				value = 0
			}
			export_to_variable = {
				which = num_provinces_in_realm
				value = num_of_count_titles_in_realm
			}
			set_variable = {
				which = score_num_provinces_in_realm
				which = num_provinces_in_realm
			}
			multiply_variable = {
				which = score_num_provinces_in_realm
				value = 10
			}
			export_to_variable = {
				which = realm_size_var
				value = realm_size
			}
			set_variable = {
				which = score_realm_size_var
				which = realm_size_var
			}
			multiply_variable = {
				which = score_realm_size_var
				value = 4
			}
			
			set_variable = {
				which = aengland_bretwalda_authority_multiplier
				value = 100
			}
			change_variable = {
				which = aengland_bretwalda_authority_multiplier
				which = bretwalda_diplomacy_effect
			}
			change_variable = {
				which = aengland_bretwalda_authority_multiplier
				which = bretwalda_martial_effect
			}
			change_variable = {
				which = aengland_bretwalda_authority_multiplier
				which = bretwalda_stewardship_effect
			}
			if = {
				limit = { is_tribal = yes }
				change_variable = {
					which = aengland_bretwalda_authority_multiplier
					value = 33
				}
			}
			if = {
				limit = {
					OR = {
						AND = {
							is_female = yes 
							NOR = {
								has_game_rule = {
									name = gender
									value = all
								}
								religion = promethean_pagan
								has_religion_feature = religion_equal
								has_religion_feature = religion_feature_pict
								has_religion_feature = religion_feature_vasconic
								has_religion_feature = religion_matriarchal
								primary_title = {
									has_law = status_of_women_4 
								}
							}
						}
						AND = {
							is_female = no 
							NOT = {
								has_game_rule = {
									name = gender
									value = all
								}
							}
							OR = {
								has_religion_feature = religion_matriarchal
								religion = britannic_pagan
							}
						}
					}
				}
				change_variable = {
					which = aengland_bretwalda_authority_multiplier
					value = -33
				}
			}
			export_to_variable = {
				which = score_num_ruled_years
				value = ruled_years
			}
			subtract_variable = {
				which = score_num_ruled_years
				value = 10
			}
			multiply_variable = {
				which = score_num_ruled_years
				value = 2
			}
			change_variable = {
				which = aengland_bretwalda_authority_multiplier
				which = score_num_ruled_years
			}
			divide_variable = {
				which = aengland_bretwalda_authority_multiplier
				value = 100
			}
			
			change_variable = {
				which = aengland_bretwalda_authority
				which = score_num_provinces_in_realm
			}
			change_variable = {
				which = aengland_bretwalda_authority
				which = score_realm_size_var
			}
			multiply_variable = {
				which = aengland_bretwalda_authority
				which = aengland_bretwalda_authority_multiplier
			}
			
			# Maximum possible annexation score is 1200
			if = {
				limit = {
					check_variable = {
						which = aengland_bretwalda_authority
						value = 1200
					}
				}
				set_variable = {
					which = aengland_bretwalda_authority
					value = 1200
				}
				set_character_flag = max_annexation_score
			}
			else = {
				if = {
					limit = { has_character_flag = max_annexation_score }
					clr_character_flag = max_annexation_score
				}
			}
			
			# Seizing control has a 1.5x cost modifier
			set_variable = {
				which = aengland_bretwalda_authority_2
				which = aengland_bretwalda_authority
			}
			multiply_variable = {
				which = aengland_bretwalda_authority_2
				value = 1.33
			}
		}
	}
	
	option = {
		name = "OK"
	}
}

# Make sure that Aengland has no King-level vassals before Declaring Supremacy
character_event = {
	id = 320212
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	only_independent = yes
	
	trigger = {
		has_landed_title = e_aengland
		NOT = { has_global_flag = aengland_declared_supremacy }
		any_vassal = {
			tier = KING
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		any_vassal = {
			limit = { tier = KING }
			set_defacto_liege = THIS
			if = {
				limit = { is_anglosaxon_tributary_potential_trigger = yes }
				ROOT = { make_tributary = { who = PREV tributary_type = anglosaxon_tributary } }
			}
			else = {
				ROOT = { make_tributary = { who = PREV tributary_type = permanent } }
			}
		}
	}
}

# Convert Anglo-Saxon tributaries to normal permanent tributaries if no longer eligible, and vice versa
character_event = {
	id = 320213
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_feast_1"
	
	hide_window = yes
	only_independent = yes
	
	trigger = {
		OR = {
			AND = {
				is_tributary = {
					type = anglosaxon_tributary
				}
				OR = {
					is_anglosaxon_tributary_potential_trigger = no
					suzerain = { is_anglosaxon_tributary_potential_trigger = no }
				}
			}
			AND = {
				is_tributary = yes
				NOT = {
					is_tributary = {
						type = anglosaxon_tributary
					}
				}
				is_anglosaxon_tributary_potential_trigger = yes
				suzerain = { is_anglosaxon_tributary_potential_trigger = yes }
			}
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		if = {
			limit = { 
				is_tributary = {
					type = anglosaxon_tributary
				}
			}
			suzerain = {
				remove_tributary = ROOT
				make_tributary = { who = ROOT tributary_type = permanent }
			}
		}
		else = {
			suzerain = {
				remove_tributary = ROOT
				make_tributary = { who = ROOT tributary_type = anglosaxon_tributary }
			}
		}
	}
}

# Declare Supremacy
narrative_event = {
	id = 320220
	title = EVTNAME320220	
	desc = EVTDESC320220
	picture = GFX_evt_royal_court
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = aengland_declared_supremacy
		
		1 = { province_event = { id = 320210 } }
	}
	
	option = {
		name = "EVTOPTA320220"		# Bretwalda
		trigger = {
			character = ROOT
		}
	}
		
	option = {
		name = "EVTOPTB320220"		# Vassals or Subject Kings
		trigger = {
			NOT = { character = ROOT }
			OR = {
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				top_liege = { character = ROOT }
			}
		}
	}
	
	option = {
		name = "EVTOPTC320220"		# Other Rulers
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
			}
		}
	}
}



# Seize Control Demand
letter_event = {
	id = 320225
	desc = "EVTDESC320225"
	picture = "GFX_evt_emissary"
	
	only_rulers = yes
	
	is_triggered_only = yes
	
	option = {			# Accept
		name = "EVTOPTA320225"
		prestige = -100
		reverse_opinion = {
			modifier = opinion_approves
			who = FROMFROM
			years = 10
		}
		FROMFROM = { character_event = { id = 320226 } }
		tooltip = {
			FROMFROM = { remove_tributary = ROOT }
			if = {
				limit = { tier = COUNT }
				set_defacto_liege = FROMFROM
			}
			else_if = {
				limit = { tier = DUKE }
				any_demesne_title = {
					limit = { tier = DUKE }
					usurp_title = FROMFROM
				}
			}
			else_if = {
				limit = { tier = KING }
				any_demesne_title = {
					limit = { tier = KING }
					usurp_title = FROMFROM
				}
			}
			else_if = {			# Shouldn't be possible, but...
				limit = { tier = EMPEROR }
				any_demesne_title = {
					limit = { tier = EMPEROR }
					usurp_title = FROMFROM
				}
			}
		}
		hidden_tooltip = {
			any_vassal = {
				opinion = {
					modifier = opinion_usurped_title
					who = FROMFROM
					years = 20
				}
			}
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				OR = {
					trait = ambitious
					trait = unloyal
					relative_power = {
						who = FROMFROM
						power = 0.8
					}
				}
			}
			modifier = {
				factor = 0.85
				NOT = { opinion = { who = FROMFROM value = 0 } }
			}
			modifier = {
				factor = 0.85
				NOT = { opinion = { who = FROMFROM value = 30 } }
			}
			modifier = {
				factor = 0.85
				NOT = { opinion = { who = FROMFROM value = 60 } }
			}
			modifier = {
				factor = 5
				NOT = {
					relative_power = {
						who = FROMFROM
						power = 0.33
					}
				}
			}
			modifier = {
				factor = 2
				NOT = {
					relative_power = {
						who = FROMFROM
						power = 0.4
					}
				}
			}
			modifier = {
				factor = 1.25
				NOT = {
					relative_power = {
						who = FROMFROM
						power = 0.5
					}
				}
			}
			modifier = {
				factor = 0.85
				relative_power = {
					who = FROMFROM
					power = 0.6
				}
			}
			modifier = {
				factor = 0.75
				relative_power = {
					who = FROMFROM
					power = 0.7
				}
			}
			modifier = {
				factor = 0.85
				NOT = { culture = FROMFROM }
			}
			modifier = {
				factor = 0.75
				NOT = { culture_group = FROMFROM }
			}
			modifier = {
				factor = 0.75
				NOT = { religion = FROMFROM }
			}
			modifier = {
				factor = 0.75
				NOT = { religion_group = FROMFROM }
			}
		}
	}
	
	option = {			# Never!
		name = "EVTOPTB320225"
		# Can't resist if you're a prisoner
		trigger = {
			OR = {
				prisoner = no
				NOT = { host = { character = FROMFROM } }
			}
		}
		prestige = 100
		reverse_opinion = {
			modifier = opinion_furious
			who = FROMFROM
			years = 10
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0.2
				trait = craven
			}
			modifier = {
				factor = 1.5
				is_tribal = yes
			}
			modifier = {
				factor = 0.75
				lower_tier_than = KING
			}
			modifier = {
				factor = 1.25
				higher_tier_than = KING
			}
		}
		FROMFROM = { character_event = { id = 320227 } }
		custom_tooltip = {
			text = EVTOPTB320225TT
		}
		hidden_tooltip = {
			war = {
				casus_belli = free_tributary_cb_liege_claim
				target = e_aengland					
			}
		}
	}
}

# Subject Kingdom accepts
letter_event = {
	id = 320226
	desc = "EVTDESC320226"
	picture = "GFX_evt_emissary"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA320226"
		remove_tributary = FROM
		FROM = {
			if = {
				limit = { tier = COUNT }
				set_defacto_liege = ROOT
			}
			else_if = {
				limit = { tier = DUKE }
				any_demesne_title = {
					limit = { tier = DUKE }
					usurp_title = ROOT
				}
			}
			else_if = {
				limit = { tier = KING }
				any_demesne_title = {
					limit = { tier = KING }
					usurp_title = ROOT
				}
			}
			else_if = {			# Shouldn't be possible, but...
				limit = { tier = EMPEROR }
				any_demesne_title = {
					limit = { tier = EMPEROR }
					usurp_title = ROOT
				}
			}
		}
	}
}

# Subject Kingdom refuses
letter_event = {
	id = 320227
	desc = "EVTDESC320227"
	picture = "GFX_evt_battle_cavalry"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA320227"
	}
}

# Vassalization Demand
letter_event = {
	id = 320230
	desc = "EVTDESC320230"
	picture = "GFX_evt_emissary"
	
	only_rulers = yes
	
	is_triggered_only = yes
	
	option = {			# Accept
		name = "EVTOPTA320230"
		prestige = -50
		reverse_opinion = {
			modifier = opinion_approves
			who = FROMFROM
			years = 10
		}
		FROMFROM = { character_event = { id = 320231 } }
		tooltip = {
			FROMFROM = { remove_tributary = ROOT }
			if = {			# Shouldn't be possible, but...
				limit = { tier = EMPEROR }
				any_demesne_title = {
					limit = { tier = EMPEROR }
					destroy_landed_title = THIS
				}
			}
			set_defacto_liege = FROMFROM
		}
		ai_chance = {
			factor = 66
			modifier = {
				factor = 0
				OR = {
					trait = ambitious
					trait = unloyal
					relative_power = {
						who = FROMFROM
						power = 0.9
					}
				}
			}
			modifier = {
				factor = 0.85
				NOT = { opinion = { who = FROMFROM value = 0 } }
			}
			modifier = {
				factor = 0.85
				NOT = { opinion = { who = FROMFROM value = 30 } }
			}
			modifier = {
				factor = 0.85
				NOT = { opinion = { who = FROMFROM value = 60 } }
			}
			modifier = {
				factor = 5
				NOT = {
					relative_power = {
						who = FROMFROM
						power = 0.33
					}
				}
			}
			modifier = {
				factor = 2
				NOT = {
					relative_power = {
						who = FROMFROM
						power = 0.4
					}
				}
			}
			modifier = {
				factor = 1.25
				NOT = {
					relative_power = {
						who = FROMFROM
						power = 0.5
					}
				}
			}
			modifier = {
				factor = 0.85
				relative_power = {
					who = FROMFROM
					power = 0.6
				}
			}
			modifier = {
				factor = 0.75
				relative_power = {
					who = FROMFROM
					power = 0.7
				}
			}
			modifier = {
				factor = 0.75
				relative_power = {
					who = FROMFROM
					power = 0.8
				}
			}
			modifier = {
				factor = 0.85
				NOT = { culture = FROMFROM }
			}
			modifier = {
				factor = 0.75
				NOT = { culture_group = FROMFROM }
			}
			modifier = {
				factor = 0.75
				NOT = { religion = FROMFROM }
			}
			modifier = {
				factor = 0.75
				NOT = { religion_group = FROMFROM }
			}
		}
	}
	
	option = {			# Never!
		name = "EVTOPTB320230"
		# Can't resist if you're a prisoner
		trigger = {
			OR = {
				prisoner = no
				NOT = { host = { character = FROMFROM } }
			}
		}
		prestige = 100
		reverse_opinion = {
			modifier = opinion_furious
			who = FROMFROM
			years = 10
		}
		ai_chance = {
			factor = 33
			modifier = {
				factor = 0.2
				trait = craven
			}
			modifier = {
				factor = 1.5
				is_tribal = yes
			}
			modifier = {
				factor = 0.75
				lower_tier_than = KING
			}
			modifier = {
				factor = 1.25
				higher_tier_than = KING
			}
		}
		FROMFROM = { character_event = { id = 320232 } }
		custom_tooltip = {
			text = EVTOPTB320230TT
		}
		hidden_tooltip = {
			war = {
				casus_belli = free_tributary_cb_liege_claim
				target = e_aengland					
			}
		}
	}
}

# Subject Kingdom accepts
letter_event = {
	id = 320231
	desc = "EVTDESC320231"
	picture = "GFX_evt_emissary"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA320231"
		remove_tributary = FROM
		FROM = {
			hidden_tooltip = {
				opinion = {
					modifier = opinion_demanded_vassalage
					who = ROOT
					years = 20
				}
			}
			if = {			# Shouldn't be possible, but...
				limit = { tier = EMPEROR }
				hidden_tooltip = {
					any_vassal = {
						if = {
							limit = { tier = KING }
							set_defacto_liege = ROOT
						}
						else = {
							set_character_flag = restore_vassalage_@FROM
						}
					}
				}
				any_demesne_title = {
					limit = { tier = EMPEROR }
					destroy_landed_title = THIS
				}
				hidden_tooltip = {
					any_character = {
						limit = { has_character_flag = restore_vassalage_@FROM }
						set_defacto_liege = FROM
						clr_character_flag = restore_vassalage_@FROM
					}
				}
			}
			set_defacto_liege = ROOT
		}
	}
}

# Subject Kingdom refuses
letter_event = {
	id = 320232
	desc = "EVTDESC320232"
	picture = "GFX_evt_battle_cavalry"
	
	is_triggered_only = yes
	
	option = {
		name = "EVTOPTA320232"
	}
}

### BATTLE OF BRUNANBURH CHAIN
# Start of chain (notify Bretwalda)
character_event = {
	id = 320235
	title = "EVTNAME320235"
	desc = "EVTDESC320235"
	hide_new = yes
	
	picture = "GFX_evt_courtiers_talking"
	
	only_independent = yes
	
	trigger = {
		has_landed_title = e_aengland
		has_global_flag = aengland_declared_supremacy
		NOT = { has_global_flag = aengland_united }
		completely_controls_region = custom_aengland
		NOR = { 
			has_global_flag = battle_of_brunanburh_war_start
			has_global_flag = won_battle_of_brunanburh
			AND = {
				has_global_flag = battle_of_brunanburh_war_over
				NOT = {
					had_global_flag = {
						flag = battle_of_brunanburh_war_over
						days = 3650		# 10 years since last war
					}
				}
			}
		}
	}
	
	mean_time_to_happen = {
		months = 60
		modifier = { 
			factor = 0.9
			check_variable = {
				which = aengland_bretwalda_authority
				value = 600
			}
		}
		modifier = { 
			factor = 0.8
			check_variable = {
				which = aengland_bretwalda_authority
				value = 800
			}
		}
		modifier = { 
			factor = 0.66
			check_variable = {
				which = aengland_bretwalda_authority
				value = 900
			}
		}
		modifier = { 
			factor = 0.5
			check_variable = {
				which = aengland_bretwalda_authority
				value = 1000
			}
		}
		modifier = { 
			factor = 0.4
			check_variable = {
				which = aengland_bretwalda_authority
				value = 1100
			}
		}
		modifier = { 
			factor = 0.3
			check_variable = {
				which = aengland_bretwalda_authority
				value = 1200
			}
		}
		modifier = { 
			factor = 0.2
			check_variable = {
				which = aengland_bretwalda_authority
				value = 1250
			}
		}
		modifier = { 
			factor = 0.8
			war = yes
		}
		# In a major war
		modifier = {
			factor = 0.5
			any_war = {
				OR = {
					AND = {
						attacker = { character = ROOT }
						defender = {
							relative_power_including_allies_defender = {
								who = ROOT
								power = 0.66
							}
						}
					}
					AND = {
						defender = { character = ROOT }
						attacker = {
							relative_power_including_allies_attacker = {
								who = ROOT
								power = 0.66
							}
						}
					}
				}
			}
		}
		# Losing a major war
		modifier = {
			factor = 0.25
			any_war = {
				OR = {
					AND = {
						attacker = { character = ROOT }
						NOT = { war_score = 30 }
					}
					AND = {
						defender = { character = ROOT }
						war_score = 30
					}
				}
			}
		}
	}
	
	immediate = {
		set_global_flag = battle_of_brunanburh_war_start
		
		# Bounce event to other rulers
		# We use a province event to guarantee that it actually happens
		6 = { 
			province_event = { id = 320236 days = 45 random = 15 } 
			
			# Cleanup in case of someone dying or the event chain messing up
			province_event = { id = 320249 days = 90 }
		}
	}
	
	option = {
		name = "EVTOPTA320235"
	}
}

# Bounce events 320237 and 320238
province_event = {
	id = 320236
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_battle_cavalry"
	
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		e_aengland = { has_holder = yes }
		has_global_flag = aengland_declared_supremacy
	}
	
	immediate = {
		e_aengland = { holder_scope = { save_event_target_as = aengland_holder } }
		any_independent_ruler = {
			limit = {
				primary_title = {
					capital_scope = { is_in_british_isles_trigger = yes }
				}
				any_realm_province = { is_in_british_isles_trigger = yes }
				NOT = {
					has_landed_title = e_aengland
				}
			}
			character_event = { id = 320237 }
		}
		6 = { province_event = { id = 320238 days = 2 } }
	}
}

# Other rulers asked to join coalition
character_event = {
	id = 320237
	desc = "EVTDESC320237"
	picture = "GFX_evt_emissary"
	
	only_rulers = yes
	
	is_triggered_only = yes
	
	trigger = {
		e_aengland = { has_holder = yes }
		has_global_flag = aengland_declared_supremacy
	}
	
	option = {			# Accept
		name = "EVTOPTA320237"
		# Not already at war
		trigger = {
			NOT = {
				any_war = {
					OR = {
						AND = {
							any_attacker = {
								character = event_target:aengland_holder
							}
							any_defender = {
								character = ROOT
							}
						}
						AND = {
							any_attacker = {
								character = ROOT
							}
							any_defender = {
								character = event_target:aengland_holder
							}
						}
					}
				}
			}
		}
		prestige = 100
		set_character_flag = joined_brunanburh_coalition
		custom_tooltip = {
			text = EVTOPTA320237TT
		}
		# White Peace out of wars with other coalition members
		if = {
			limit = { 
				ai = yes
				war = yes
			}
			any_war = {
				limit = {
					OR = {
						AND = {
							attacker = { character = ROOT }							
							defender = { 
								ai = yes
								primary_title = {
									capital_scope = { is_in_british_isles_trigger = yes }
								}
								any_realm_province = { is_in_british_isles_trigger = yes }
								NOT = {
									has_landed_title = e_aengland
								}
							}
							NOT = { war_score = 80 }
						}
						AND = {
							attacker = {
								ai = yes
								primary_title = {
									capital_scope = { is_in_british_isles_trigger = yes }
								}
								any_realm_province = { is_in_british_isles_trigger = yes }
								NOT = {
									has_landed_title = e_aengland
								}
							}							
							defender = { 
								character = ROOT
							}
							war_score = -80
						}
					}
				}
				end_war = whitepeace
			}
		}
		ai_chance = {
			factor = 80
			modifier = {
				factor = 0
				OR = {
					has_non_aggression_pact_with = event_target:aengland_holder
					is_allied_with = event_target:aengland_holder
					opinion = { who = event_target:aengland_holder value = 80 }
					# Loyal Tributary
					AND = {
						opinion = { who = event_target:aengland_holder value = 60 }
						is_tributary = {
							suzerain = event_target:aengland_holder
						}
					}
				}
			}
			modifier = {
				factor = 3
				trait = ambitious
			}
			modifier = {
				factor = 1.5
				trait = brave
			}
			modifier = {
				factor = 0.5
				trait = content
			}
			modifier = {
				factor = 0.5
				trait = craven
			}
			modifier = {
				factor = 0.8
				lower_tier_than = KING
			}
			modifier = {
				factor = 1.25
				higher_tier_than = KING
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = event_target:aengland_holder value = -40 } }
			}
			modifier = {
				factor = 1.5
				NOT = { opinion = { who = event_target:aengland_holder value = -20 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = event_target:aengland_holder value = 0 } }
			}
			modifier = {
				factor = 0.85
				opinion = { who = event_target:aengland_holder value = 20 }
			}
			modifier = {
				factor = 0.6
				opinion = { who = event_target:aengland_holder value = 40 }
			}
			modifier = {
				factor = 0.4
				opinion = { who = event_target:aengland_holder value = 60 }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = event_target:aengland_holder value = -40 } }
			}
			modifier = {
				factor = 1.5
				NOT = { opinion = { who = event_target:aengland_holder value = -20 } }
			}
			modifier = {
				factor = 2
				is_tributary = {
					suzerain = event_target:aengland_holder
				}
				NOT = { opinion = { who = event_target:aengland_holder value = -40 } }
			}
			modifier = {
				factor = 1.75
				is_tributary = {
					suzerain = event_target:aengland_holder
				}
				NOT = { opinion = { who = event_target:aengland_holder value = -20 } }
			}
			modifier = {
				factor = 1.4
				is_tributary = {
					suzerain = event_target:aengland_holder
				}
				NOT = { opinion = { who = event_target:aengland_holder value = 0 } }
			}
			modifier = {
				factor = 1.2
				is_tributary = {
					suzerain = event_target:aengland_holder
				}
				NOT = { opinion = { who = event_target:aengland_holder value = 20 } }
			}
			modifier = {
				factor = 0.8
				is_tributary = {
					suzerain = event_target:aengland_holder
				}
				opinion = { who = event_target:aengland_holder value = 40 }
			}
			modifier = {
				factor = 5
				relative_power = {
					who = event_target:aengland_holder
					power = 1.5
				}
			}
			modifier = {
				factor = 3
				relative_power = {
					who = event_target:aengland_holder
					power = 1
				}
			}
			modifier = {
				factor = 2
				relative_power = {
					who = event_target:aengland_holder
					power = 0.86
				}
			}
			modifier = {
				factor = 1.5
				relative_power = {
					who = event_target:aengland_holder
					power = 0.75
				}
			}
			modifier = {
				factor = 1.25
				relative_power = {
					who = event_target:aengland_holder
					power = 0.66
				}
			}
			modifier = {
				factor = 1.1
				realm_levies = 2000
			}
			modifier = {
				factor = 1.25
				realm_levies = 3000
			}
			modifier = {
				factor = 1.5
				realm_levies = 4000
			}
			modifier = {
				factor = 2
				realm_levies = 5000
			}
			modifier = {
				factor = 0.85
				NOT = {
					relative_power = {
						who = event_target:aengland_holder
						power = 0.33
					}
				}
			}
			modifier = {
				factor = 0.85
				NOT = {
					relative_power = {
						who = event_target:aengland_holder
						power = 0.2
					}
				}
			}
			modifier = {
				factor = 1.5
				is_tributary = {
					suzerain = event_target:aengland_holder
				}
				relative_power = {
					who = event_target:aengland_holder
					power = 0.75
				}
			}
			modifier = {
				factor = 1.25
				is_tributary = {
					suzerain = event_target:aengland_holder
				}
				relative_power = {
					who = event_target:aengland_holder
					power = 0.66
				}
			}
			modifier = {
				factor = 1.25
				NOT = { culture_group = event_target:aengland_holder }
			}
			modifier = {
				factor = 1.25
				NOT = { religion = event_target:aengland_holder }
			}
			modifier = {
				factor = 1.25
				NOT = { religion_group = event_target:aengland_holder }
			}
			modifier = {
				factor = 1.25
				any_realm_province = {
					any_neighbor_province = {
						owner = {
							top_liege = {
								character = event_target:aengland_holder
							}
						}
					}
				}
			}
			modifier = {
				factor = 0.85
				event_target:aengland_holder = {
					NOT = {
						any_province = {
							distance = {
								who = ROOT
								value = 350
							}
						}
					}
				}
			}
			modifier = {
				factor = 0.75
				event_target:aengland_holder = {
					NOT = {
						any_province = {
							distance = {
								who = ROOT
								value = 400
							}
						}
					}
				}
			}
			modifier = {
				factor = 0.75
				event_target:aengland_holder = {
					NOT = {
						any_province = {
							distance = {
								who = ROOT
								value = 500
							}
						}
					}
				}
			}
			modifier = {
				factor = 0.75
				war = yes
				any_war = {
					OR = {
						attacker = { character = ROOT }
						defender = { character = ROOT }
					}
				}
			}
			# At war with someone who is NOT eligible to join the coalition
			modifier = {
				factor = 0.75
				war = yes
				any_war = {
					OR = {
						AND = {
							attacker = { character = ROOT }
							NOT = { 
								defender = { 
									primary_title = {
										capital_scope = { is_in_british_isles_trigger = yes }
									}
									any_realm_province = { is_in_british_isles_trigger = yes }
									NOT = {
										has_landed_title = e_aengland
									}
								}								
							}
						}
						AND = {
							defender = { character = ROOT }
							NOT = { 
								attacker = { 
									primary_title = {
										capital_scope = { is_in_british_isles_trigger = yes }
									}
									any_realm_province = { is_in_british_isles_trigger = yes }
									NOT = {
										has_landed_title = e_aengland
									}
								}								
							}
						}
					}
				}
			}
		}
	}
	
	option = {	
		name = {		# Not a good idea	
			text = "EVTOPTB320237"
			trigger = {
				NOT = {
					any_war = {
						OR = {
							AND = {
								any_attacker = {
									character = event_target:aengland_holder
								}
								any_defender = {
									character = ROOT
								}
							}
							AND = {
								any_attacker = {
									character = ROOT
								}
								any_defender = {
									character = event_target:aengland_holder
								}
							}
						}
					}
				}
			}
		}
		name = {		# Already at war - great!
			text = "EVTOPTB320237_1"
			trigger = {
				any_war = {
					OR = {
						AND = {
							any_attacker = {
								character = event_target:aengland_holder
							}
							any_defender = {
								character = ROOT
							}
						}
						AND = {
							any_attacker = {
								character = ROOT
							}
							any_defender = {
								character = event_target:aengland_holder
							}
						}
					}
				}
			}
		}
		ai_chance = {
			factor = 20
			modifier = {
				factor = 0
				NOT = { opinion = { who = event_target:aengland_holder value = -60 } }
				NOR = {
					has_non_aggression_pact_with = event_target:aengland_holder
					is_allied_with = event_target:aengland_holder
				}
			}
		}
	}
}

# Bounce event 320239 to Bretwalda
province_event = {
	id = 320238
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_battle_cavalry"
	
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		e_aengland = { has_holder = yes }
		has_global_flag = aengland_declared_supremacy
	}
	
	immediate = {
		e_aengland = { holder_scope = { character_event = { id = 320239 } } }
		6 = { province_event = { id = 320240 days = 2 } }
	}
}

# Notify Bretwalda that the war is about to begin
character_event = {
	id = 320239
	title = "EVTNAME320239"
	desc = "EVTDESC320239"
	hide_new = yes
	
	picture = "GFX_evt_saxon_army"
	
	only_independent = yes
	is_triggered_only = yes
	
	trigger = {
		e_aengland = { has_holder = yes }
		has_global_flag = aengland_declared_supremacy
	}
	
	option = {
		name = "EVTOPTA320239"
	}
}

# Bounce event 320241
province_event = {
	id = 320240
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_battle_cavalry"
	
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		e_aengland = { has_holder = yes }
		has_global_flag = aengland_declared_supremacy
	}
	
	immediate = {
		e_aengland = { holder_scope = { character_event = { id = 320241 } } }
	}
}

# War begins
narrative_event = {
	id = 320241
	title = EVTNAME320241	
	desc = EVTDESC320241
	picture = GFX_evt_battle_cavalry
	major = yes
	show_portrait = event_target:battle_of_brunanburh_war_declarer
	
	is_triggered_only = yes
	
	immediate = {
		# Strongest member of the coalition not at war and without a truce declares it
		random_independent_ruler = {
			limit = {
				has_character_flag = joined_brunanburh_coalition
				war = no
				NOT = { has_truce = ROOT }
				NOT = {
					any_independent_ruler = {
						has_character_flag = joined_brunanburh_coalition
						realm_levy_diff = {
							who = PREV
							value = 0
						}
						war = no
						NOT = { has_truce = ROOT }
						NOT = { character = PREV }
					}
				}
			}
			save_event_target_as = battle_of_brunanburh_war_declarer
			set_global_flag = chose_brunanburh_war_leader
		}
		# Strongest member of the coalition not at war and without a truce declares it
		if = {
			limit = { NOT = { has_global_flag = chose_brunanburh_war_leader } }
			random_independent_ruler = {
				limit = {
					has_character_flag = joined_brunanburh_coalition
					war = no
					NOT = {
						any_independent_ruler = {
							has_character_flag = joined_brunanburh_coalition
							realm_levy_diff = {
								who = PREV
								value = 0
							}
							war = no
							NOT = { character = PREV }
						}
					}
				}
				save_event_target_as = battle_of_brunanburh_war_declarer
				set_global_flag = chose_brunanburh_war_leader
			}
		}
		# If somehow they're all at war, just pick the strongest
		if = {
			limit = { NOT = { has_global_flag = chose_brunanburh_war_leader } }
			random_independent_ruler = {
				limit = {
					has_character_flag = joined_brunanburh_coalition
					NOT = {
						any_independent_ruler = {
							has_character_flag = joined_brunanburh_coalition
							realm_levy_diff = {
								who = PREV
								value = 0
							}
							NOT = { character = PREV }
						}
					}
				}
				save_event_target_as = battle_of_brunanburh_war_declarer
				set_character_flag = battle_of_brunanburh_war_declarer
			}
		}
		set_variable = {
			which = total_alliance_realm_levies
			value = 0
		}
		event_target:battle_of_brunanburh_war_declarer = {
			war = {
				target = ROOT
				casus_belli = battle_of_brunanburh_cb
				thirdparty_title = e_aengland
			}
			# Always gets a commander and a bit of event troops 
			create_character = {
				random_traits = yes
				dynasty = random
				religion = THIS
				culture = THIS
				female = no
				age = 35
				attributes = {
					martial = 10
				}
				trait = brilliant_strategist
				trait = veteran
				trait = diligent
				trait = wroth
			}
			new_character = {
				spawn_unit = {
					province = event_target:battle_of_brunanburh_war_declarer_capital
					troops = {
						light_infantry = { 600 600 }
						heavy_infantry = { 400 400 }
						pikemen = { 300 300 }
						archers = { 150 150 }
						light_cavalry = { 75 75 }
					}
					attrition = 0.25
					merge = yes
					disband_on_peace = yes
				}
			}
			# Add up the strength of the alliance
			ROOT = {
				export_to_variable = {
					which = alliance_member_realm_levies
					value = realm_levies
					who = PREV
				}
				change_variable = {
					which = total_alliance_realm_levies
					which = alliance_member_realm_levies
				}
			}
		}
		any_independent_ruler = {
			limit = { 
				has_character_flag = joined_brunanburh_coalition
			}
			join_attacker_wars = event_target:battle_of_brunanburh_war_declarer
			# Add up the strength of the alliance
			ROOT = {
				export_to_variable = {
					which = alliance_member_realm_levies
					value = realm_levies
					who = PREV
				}
				change_variable = {
					which = total_alliance_realm_levies
					which = alliance_member_realm_levies
				}
			}
		}
		# Compare alliance strength to ROOT strength
		# Spawn more event troops until alliance strength is > 1.25x Aengland's strength
		ROOT = {
			export_to_variable = {
				which = aengland_realm_levies
				value = realm_levies
			}
			set_variable = {
				which = alliance_min_strength
				which = aengland_realm_levies
			}
			multiply_variable = {
				which = alliance_min_strength
				value = 1.25
			}
			set_variable = {
				which = alliance_remaining_event_troops
				which = alliance_min_strength
			}
			subtract_variable = {
				which = alliance_remaining_event_troops
				which = total_alliance_realm_levies
			}
			while = {
				limit = {
					check_variable = {
						which = alliance_remaining_event_troops
						value = 0
					}
				}				
				event_target:battle_of_brunanburh_war_declarer = {
					capital_scope = {
						save_event_target_as = battle_of_brunanburh_war_declarer_capital
					}
					spawn_unit = {
						province = event_target:battle_of_brunanburh_war_declarer_capital
						troops = {
							light_infantry = { 400 400 }
							heavy_infantry = { 250 250 }
							pikemen = { 200 200 }
							archers = { 100 100 }
							light_cavalry = { 50 50 }
						}
						attrition = 0.25
						merge = yes
						disband_on_peace = yes
					}
				}
				subtract_variable = {
					which = alliance_remaining_event_troops
					value = 1000
				}
			}
		}
		
		set_global_flag = battle_of_brunanburh_war_declared
	}
	
	option = {
		name = "EVTOPTA320241"		# Bretwalda
		trigger = {
			character = ROOT
		}
	}
		
	option = {
		name = "EVTOPTB320241"		# Vassals or Subject Kings
		trigger = {
			NOT = { character = ROOT }
			OR = {
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				top_liege = { character = ROOT }
			}
			NOT = { has_character_flag = joined_brunanburh_coalition }
		}
	}
	
	option = {
		name = "EVTOPTC320241"		# Alliance Members
		trigger = {
			has_character_flag = joined_brunanburh_coalition
		}
		clr_character_flag = joined_brunanburh_coalition
		custom_tooltip = {
			text = EVTOPTC320241TT
		}
	}
	
	option = {
		name = "EVTOPTD320241"		# Other Rulers
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				has_character_flag = joined_brunanburh_coalition
			}
		}
	}
}

# Coalition Defeated
narrative_event = {
	id = 320242
	title = "EVTNAME320242"
	desc = "EVTDESC320242"
	hide_new = yes
	
	picture = "GFX_evt_battle_gaul"
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = won_battle_of_brunanburh
		clr_global_flag = battle_of_brunanburh_war_start
	}
	
	option = {
		name = "EVTOPTA320242"		# Bretwalda - Aengland Prevails! (Unify England)
		trigger = {
			character = ROOT
		}
		custom_tooltip = {
			text = HK_unite_aengland_tooltip
		}
		hidden_tooltip = {
			ROOT = { narrative_event = { id = 320250 } }
		}
	}
	
	option = {
		name = "EVTOPTB320242"		# Bretwalda - Don't Unify
		trigger = {
			character = ROOT
		}
		change_variable = {
			which = aengland_bretwalda_authority
			value = 1000
		}
		hidden_tooltip = {
			set_variable = {
				which = aengland_bretwalda_authority_2
				value = aengland_bretwalda_authority
			}
		}
	}
		
	option = {
		name = "EVTOPTC320242"		# Vassals or Subject Kings
		trigger = {
			NOT = { character = ROOT }
			OR = {
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				top_liege = { character = ROOT }
			}
			NOT = { has_character_flag = brunanburh_alliance_member }
		}
	}
	
	option = {
		name = "EVTOPTD320242"		# Alliance Members
		trigger = {
			has_character_flag = brunanburh_alliance_member
		}
		clr_character_flag = brunanburh_alliance_member
	}
	
	option = {
		name = "EVTOPTE320242"		# Other Rulers
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				has_character_flag = brunanburh_alliance_member
			}
		}
	}
}

# Coalition Victorius
narrative_event = {
	id = 320243
	title = "EVTNAME320243"
	desc = "EVTDESC320243"
	hide_new = yes
	
	picture = "GFX_evt_burning_fire"
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = battle_of_brunanburh_war_over
		clr_global_flag = battle_of_brunanburh_war_start
	}
	
	option = {
		name = "EVTOPTA320243"		# Bretwalda
		trigger = {
			character = ROOT
		}
		# Lose all Bretwalda Authority
		subtract_variable = {
			which = aengland_bretwalda_authority
			which = aengland_bretwalda_authority
		}
		hidden_tooltip = {
			set_variable = {
				which = aengland_bretwalda_authority_2
				which = aengland_bretwalda_authority
			}			
		}
	}
		
	option = {
		name = "EVTOPTB320243"		# Vassals or Subject Kings
		trigger = {
			NOT = { character = ROOT }
			OR = {
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				top_liege = { character = ROOT }
			}
			NOT = { has_character_flag = brunanburh_alliance_member }
		}
	}
	
	option = {
		name = "EVTOPTC320243"		# Alliance Members
		trigger = {
			has_character_flag = brunanburh_alliance_member
		}
		clr_character_flag = brunanburh_alliance_member
	}
	
	option = {
		name = "EVTOPTD320243"		# Other Rulers
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				has_character_flag = brunanburh_alliance_member
			}
		}
	}
}

# White Peace/Invalidation
narrative_event = {
	id = 320244
	title = "EVTNAME320244"
	desc = "EVTDESC320244"
	hide_new = yes
	
	picture = "GFX_evt_burning_fire"
	major = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = battle_of_brunanburh_war_over
		clr_global_flag = battle_of_brunanburh_war_start
	}
	
	option = {
		name = "EVTOPTA320244"		# Bretwalda
		trigger = {
			character = ROOT
		}
	}
	
	option = {
		name = "EVTOPTB320244"		# Vassals or Subject Kings
		trigger = {
			NOT = { character = ROOT }
			OR = {
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				top_liege = { character = ROOT }
			}
			NOT = { has_character_flag = brunanburh_alliance_member }
		}
	}
	
	option = {
		name = "EVTOPTC320244"		# Alliance Members
		trigger = {
			has_character_flag = brunanburh_alliance_member
		}
		clr_character_flag = brunanburh_alliance_member
	}
	
	option = {
		name = "EVTOPTD320244"		# Other Rulers
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				has_character_flag = brunanburh_alliance_member
			}
		}
	}
}

# Cleanup
province_event = {
	id = 320249
	desc = "You're not supposed to see this..."
	picture = "GFX_evt_battle_cavalry"
	
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		any_character = {
			limit = { has_character_flag = joined_brunanburh_coalition }
			clr_character_flag = joined_brunanburh_coalition
		}
		
		if = {
			limit = { NOT = { has_global_flag = battle_of_brunanburh_war_declared } }
			clr_global_flag = battle_of_brunanburh_war_start
		}
	}
}

# King of the Anglo-Saxons
narrative_event = {
	id = 320250
	title = EVTNAME320250	
	desc = EVTDESC320250
	picture = GFX_evt_royal_court
	major = yes
	hide_new = yes
	hide_from = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_global_flag = aengland_united
		
		any_province = {
			limit = { has_province_modifier = province_not_dejure_liege }
			remove_province_modifier = province_not_dejure_liege
		}
	}
	
	option = {
		name = "EVTOPTA320250"		# Bretwalda
		trigger = {
			character = ROOT
		}
	}
		
	option = {
		name = "EVTOPTB320250"		# Vassals or Subject Kings
		trigger = {
			NOT = { character = ROOT }
			OR = {
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				top_liege = { character = ROOT }
			}
		}
	}
	
	option = {
		name = "EVTOPTC320250"		# Britons
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
			}
			is_brythonic_culture_trigger = yes
		}
	}
	
	option = {
		name = "EVTOPTD320250"		# Other Rulers
		trigger = {
			NOR = { 
				character = ROOT
				top_liege = { character = ROOT }
				is_tributary = { 
					type = anglosaxon_tributary 
					suzerain = ROOT
				}
				top_liege = {
					is_tributary = { 
						type = anglosaxon_tributary 
						suzerain = ROOT
					}
				}
				is_brythonic_culture_trigger = yes
			}
		}
	}
}